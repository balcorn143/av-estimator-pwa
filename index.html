<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV Estimator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional Audio/Visual Project Estimation Tool">
    <meta name="theme-color" content="#1d9bf0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AV Estimator">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1f26; }
        ::-webkit-scrollbar-thumb { background: #2f3336; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #404447; }
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: #1d9bf0; }
        h1, h2, h3, h4, h5, h6, p, span, label, div { color: inherit; }
        body { color: #e7e9ea; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }
        select { color: #e7e9ea; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// ============================================================================
// CONFIGURATION - Update this when you set up your GitHub repository
// ============================================================================
const APP_VERSION = '1.1.0';

const CONFIG = {
    // GitHub raw content URL - update 'USERNAME' and 'REPO' with your values
    GITHUB_BASE_URL: '',

    // File names
    CATALOG_FILE: 'av_catalog.json',
    PACKAGES_FILE: 'av_packages.json',

    // Supabase
    SUPABASE_URL: 'https://zyxzkwziyysugomjyidb.supabase.co',
    SUPABASE_ANON_KEY: 'sb_publishable_gnK6VeaiKdehrhoUi-b4Fg_LvsEfjCB',
};

// Initialize Supabase client
const supabase = window.supabase ? window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY) : null;

// Helper to get data URL (local or GitHub)
const getDataUrl = (filename) => {
    if (CONFIG.GITHUB_BASE_URL) {
        return CONFIG.GITHUB_BASE_URL + filename + '?t=' + Date.now();
    }
    return './' + filename;
};

// Default catalog with new sync-ready structure
const DEFAULT_CATALOG = [
    // Displays - with mount and cable accessories
    { id: 'cat-001', manufacturer: 'Samsung', model: 'QM85C', partNumber: 'LH85QMCEBGCXXS', description: '85" 4K UHD Display', category: 'Displays', subcategory: 'Commercial Displays', unitCost: 4500, laborHrsPerUnit: 2, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-005', qtyPer: 1 }, { catalogId: 'cat-020', qtyPer: 1 }] },
    { id: 'cat-002', manufacturer: 'Samsung', model: 'QM75C', partNumber: 'LH75QMCEBGCXXS', description: '75" 4K UHD Display', category: 'Displays', subcategory: 'Commercial Displays', unitCost: 3200, laborHrsPerUnit: 2, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-005', qtyPer: 1 }, { catalogId: 'cat-020', qtyPer: 1 }] },
    { id: 'cat-003', manufacturer: 'Samsung', model: 'QM65C', partNumber: 'LH65QMCEBGCXXS', description: '65" 4K UHD Display', category: 'Displays', subcategory: 'Commercial Displays', unitCost: 2100, laborHrsPerUnit: 1.5, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-006', qtyPer: 1 }, { catalogId: 'cat-020', qtyPer: 1 }] },
    { id: 'cat-004', manufacturer: 'LG', model: '86UL3J', partNumber: '86UL3J-B', description: '86" 4K UHD Display', category: 'Displays', subcategory: 'Commercial Displays', unitCost: 3800, laborHrsPerUnit: 2, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-005', qtyPer: 1 }, { catalogId: 'cat-020', qtyPer: 1 }] },
    // Mounts
    { id: 'cat-005', manufacturer: 'Chief', model: 'XTM1U', partNumber: 'XTM1U', description: 'Large Tilt Wall Mount', category: 'Mounts', subcategory: 'Wall Mounts', unitCost: 350, laborHrsPerUnit: 1, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-006', manufacturer: 'Chief', model: 'LTM1U', partNumber: 'LTM1U', description: 'Medium Tilt Wall Mount', category: 'Mounts', subcategory: 'Wall Mounts', unitCost: 275, laborHrsPerUnit: 0.75, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    // Control
    { id: 'cat-007', manufacturer: 'Crestron', model: 'TSW-1070', partNumber: '6510814', description: '10" Touch Panel', category: 'Control', subcategory: 'Touch Panels', unitCost: 2800, laborHrsPerUnit: 1.5, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-008', manufacturer: 'Crestron', model: 'TSW-770', partNumber: '6510813', description: '7" Touch Panel', category: 'Control', subcategory: 'Touch Panels', unitCost: 2200, laborHrsPerUnit: 1, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    // Audio
    { id: 'cat-009', manufacturer: 'Shure', model: 'MXA920', partNumber: 'MXA920AL', description: 'Ceiling Array Microphone', category: 'Audio', subcategory: 'Microphones', unitCost: 3200, laborHrsPerUnit: 2, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-022', qtyPer: 1 }] },
    { id: 'cat-010', manufacturer: 'Biamp', model: 'TesiraFORTE AI', partNumber: 'TESIRA-FORTE-AI', description: 'AVB DSP with AEC', category: 'Audio', subcategory: 'DSP', unitCost: 4500, laborHrsPerUnit: 4, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    // Video Conferencing
    { id: 'cat-011', manufacturer: 'Logitech', model: 'Rally Bar', partNumber: '960-001308', description: 'Video Conferencing Bar', category: 'Video Conferencing', subcategory: 'Video Bars', unitCost: 2999, laborHrsPerUnit: 1, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-021', qtyPer: 1 }] },
    { id: 'cat-012', manufacturer: 'Logitech', model: 'Rally Bar Mini', partNumber: '960-001336', description: 'Compact Video Bar', category: 'Video Conferencing', subcategory: 'Video Bars', unitCost: 1999, laborHrsPerUnit: 0.75, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-021', qtyPer: 1 }] },
    { id: 'cat-013', manufacturer: 'Poly', model: 'Studio X50', partNumber: '2200-86270-001', description: 'Video Bar', category: 'Video Conferencing', subcategory: 'Video Bars', unitCost: 2495, laborHrsPerUnit: 1, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    // Switching
    { id: 'cat-014', manufacturer: 'Extron', model: 'DTP CrossPoint 108', partNumber: '60-1515-01', description: '10x8 4K Matrix Switcher', category: 'Switching', subcategory: 'Matrix Switchers', unitCost: 8500, laborHrsPerUnit: 4, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    // Infrastructure
    { id: 'cat-015', manufacturer: 'Middle Atlantic', model: 'WRK-44-32', partNumber: 'WRK-44-32', description: '44U AV Rack', category: 'Infrastructure', subcategory: 'Racks', unitCost: 1200, laborHrsPerUnit: 4, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    // Speakers - with cable accessories
    { id: 'cat-016', manufacturer: 'JBL', model: 'Control 26CT', partNumber: '?"', description: '6.5" Ceiling Speaker', category: 'Audio', subcategory: 'Speakers', unitCost: 195, laborHrsPerUnit: 0.5, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-019', qtyPer: 30 }] },
    // Cisco
    { id: 'cat-017', manufacturer: 'Cisco', model: 'Room Kit Pro', partNumber: 'CS-KITPRO-K9', description: 'Video Conferencing System', category: 'Video Conferencing', subcategory: 'Room Systems', unitCost: 12500, laborHrsPerUnit: 4, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-018', manufacturer: 'Cisco', model: 'Board Pro 75', partNumber: 'CS-BOARDPRO75', description: '75" Interactive Display', category: 'Video Conferencing', subcategory: 'Interactive Displays', unitCost: 15000, laborHrsPerUnit: 3, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z', defaultAccessories: [{ catalogId: 'cat-005', qtyPer: 1 }] },
    // Cables & Accessories
    { id: 'cat-019', manufacturer: 'Generic', model: 'Speaker Wire', partNumber: 'SPK-WIRE-FT', description: 'Speaker Wire (per foot)', category: 'Cables', subcategory: 'Speaker Cable', unitCost: 0.50, laborHrsPerUnit: 0.01, uom: 'FT', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-020', manufacturer: 'Generic', model: 'HDMI 6ft', partNumber: 'HDMI-6FT', description: 'HDMI Cable 6ft', category: 'Cables', subcategory: 'Video Cable', unitCost: 25, laborHrsPerUnit: 0.1, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-021', manufacturer: 'Generic', model: 'Cat6 10ft', partNumber: 'CAT6-10FT', description: 'Cat6 Ethernet Cable 10ft', category: 'Cables', subcategory: 'Network Cable', unitCost: 15, laborHrsPerUnit: 0.1, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-022', manufacturer: 'Shure', model: 'A920-HCM', partNumber: 'A920-HCM', description: 'Hard Ceiling Mount Kit', category: 'Mounts', subcategory: 'Ceiling Mounts', unitCost: 85, laborHrsPerUnit: 0.25, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
    { id: 'cat-023', manufacturer: 'Chief', model: 'PAC526', partNumber: 'PAC526', description: 'Hardware Kit / Screw Pack', category: 'Accessories', subcategory: 'Hardware', unitCost: 45, laborHrsPerUnit: 0, uom: 'EA', vendor: '', discontinued: false, phase: '', modifiedAt: '2024-01-01T00:00:00Z' },
];

// Unit of Measure options
const UOM_OPTIONS = ['EA', 'FT', 'M', 'PR', 'SET', 'BOX', 'ROLL', 'LOT'];
const SYSTEM_OPTIONS = ['Audio', 'Video', 'Control', 'Infrastructure'];
const PHASE_OPTIONS = [
    { value: '27-41 00', label: 'Rough-In 27-41 00' },
    { value: '27-41 23', label: 'Trim Out 27-41 23' },
    { value: '27-41 33', label: 'Finish 27-41 33' },
    { value: '27-41 16', label: 'Management 27-41 16' },
    { value: '27-41 17', label: 'Programming 27-41 17' },
];

// Generate unique catalog ID
const generateCatalogId = () => 'cat-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

const styles = {
    app: { fontFamily: "'Segoe UI', -apple-system, sans-serif", minHeight: '100vh', backgroundColor: '#0f1419', color: '#e7e9ea' },
    header: { background: 'linear-gradient(180deg, #1a1f26 0%, #151a21 100%)', padding: '12px 24px', borderBottom: '1px solid #2f3336', display: 'flex', alignItems: 'center', justifyContent: 'space-between', position: 'sticky', top: 0, zIndex: 100 },
    logo: { fontSize: '18px', fontWeight: '700', color: '#1d9bf0', display: 'flex', alignItems: 'center', gap: '8px' },
    nav: { display: 'flex', gap: '4px' },
    navButton: (active) => ({ padding: '8px 16px', border: 'none', borderRadius: '20px', cursor: 'pointer', fontSize: '14px', fontWeight: '500', backgroundColor: active ? '#1d9bf0' : 'transparent', color: active ? '#fff' : '#8b98a5', transition: 'all 0.2s' }),
    main: { display: 'flex', height: 'calc(100vh - 53px)' },
    sidebar: { width: '360px', backgroundColor: '#151a21', borderRight: '1px solid #2f3336', display: 'flex', flexDirection: 'column' },
    sidebarHeader: { padding: '16px', borderBottom: '1px solid #2f3336' },
    sidebarSearch: { padding: '12px 16px', borderBottom: '1px solid #2f3336' },
    sidebarActions: { padding: '12px 16px', borderBottom: '1px solid #2f3336', display: 'flex', gap: '8px', flexWrap: 'wrap' },
    sidebarContent: { flex: 1, overflowY: 'auto', padding: '8px' },
    content: { flex: 1, padding: '24px', overflowY: 'auto', backgroundColor: '#0f1419' },
    card: { backgroundColor: '#1a1f26', borderRadius: '16px', border: '1px solid #2f3336', padding: '20px', marginBottom: '16px' },
    cardTitle: { fontSize: '15px', fontWeight: '600', color: '#e7e9ea', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '10px' },
    input: { width: '100%', padding: '10px 14px', backgroundColor: '#0f1419', border: '1px solid #2f3336', borderRadius: '8px', color: '#e7e9ea', fontSize: '14px', outline: 'none', boxSizing: 'border-box' },
    inputSmall: { padding: '8px 12px', backgroundColor: '#0f1419', border: '1px solid #2f3336', borderRadius: '6px', color: '#e7e9ea', fontSize: '13px', outline: 'none', boxSizing: 'border-box' },
    textarea: { width: '100%', padding: '12px 16px', backgroundColor: '#0f1419', border: '1px solid #2f3336', borderRadius: '8px', color: '#e7e9ea', fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', minHeight: '150px' },
    button: (v) => ({ padding: '10px 20px', border: 'none', borderRadius: '20px', cursor: 'pointer', fontSize: '14px', fontWeight: '600', backgroundColor: v === 'primary' ? '#1d9bf0' : v === 'success' ? '#00ba7c' : v === 'warning' ? '#f59e0b' : v === 'danger' ? '#dc2626' : v === 'purple' ? '#7c3aed' : '#2f3336', color: '#fff', display: 'inline-flex', alignItems: 'center', gap: '6px', transition: 'opacity 0.2s' }),
    smallButton: { padding: '6px 10px', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: '500', backgroundColor: '#2f3336', color: '#e7e9ea', display: 'inline-flex', alignItems: 'center', gap: '4px' },
    iconButton: { padding: '6px', border: 'none', borderRadius: '6px', cursor: 'pointer', backgroundColor: 'transparent', color: '#8b98a5', display: 'inline-flex', alignItems: 'center' },
    table: { width: '100%', borderCollapse: 'collapse', fontSize: '13px', tableLayout: 'fixed' },
    th: { textAlign: 'left', padding: '12px 16px', backgroundColor: '#1a1f26', color: '#8b98a5', fontWeight: '600', fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: '1px solid #2f3336', borderRight: '1px solid #3d4450', position: 'sticky', top: 0, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' },
    thResizable: { position: 'relative', userSelect: 'none' },
    resizeHandle: { position: 'absolute', right: '-2px', top: '4px', bottom: '4px', width: '4px', cursor: 'col-resize', backgroundColor: '#4a5568', borderRadius: '2px', zIndex: 2, opacity: 0.6, transition: 'opacity 0.15s, background-color 0.15s' },
    td: { padding: '12px 16px', borderBottom: '1px solid #2f3336', borderRight: '1px solid #2a2f38', color: '#e7e9ea', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' },
    treeItem: (d, s) => ({ padding: '8px 12px', paddingLeft: `${12 + d * 16}px`, cursor: 'pointer', borderRadius: '8px', backgroundColor: s ? '#1d3a5c' : 'transparent', color: s ? '#e7e9ea' : '#8b98a5', fontSize: '14px', display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '2px', border: s ? '1px solid #1d9bf0' : '1px solid transparent' }),
    treeItemTotals: { fontSize: '11px', color: '#6e767d', display: 'flex', gap: '8px', marginLeft: 'auto', flexShrink: 0 },
    badge: (c) => ({ padding: '3px 10px', borderRadius: '12px', fontSize: '12px', fontWeight: '600', backgroundColor: c === 'blue' ? '#1d3a5c' : c === 'green' ? '#1a3d2e' : c === 'orange' ? '#3d2e1a' : c === 'red' ? '#3d1a1a' : c === 'purple' ? '#2d1a3d' : '#2f3336', color: c === 'blue' ? '#1d9bf0' : c === 'green' ? '#00ba7c' : c === 'orange' ? '#ffad1f' : c === 'red' ? '#f87171' : c === 'purple' ? '#a78bfa' : '#8b98a5' }),
    modal: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
    modalContent: { backgroundColor: '#1a1f26', borderRadius: '16px', border: '1px solid #2f3336', padding: '24px', width: '600px', maxWidth: '90vw', maxHeight: '85vh', overflowY: 'auto' },
    searchResults: { maxHeight: '350px', overflowY: 'auto', border: '1px solid #2f3336', borderRadius: '12px', marginTop: '16px' },
    searchItem: (s) => ({ padding: '14px 16px', cursor: 'pointer', backgroundColor: s ? '#1d3a5c' : 'transparent', borderBottom: '1px solid #2f3336' }),
    emptyState: { textAlign: 'center', padding: '80px 20px', color: '#6e767d' },
    pkgColor: (n) => { 
        const c = [
            // Blues
            { bg: 'rgba(29,155,240,0.15)', b: '#1d9bf0' },
            { bg: 'rgba(56,189,248,0.15)', b: '#38bdf8' },
            { bg: 'rgba(14,116,144,0.15)', b: '#0e7490' },
            // Greens
            { bg: 'rgba(0,186,124,0.15)', b: '#00ba7c' },
            { bg: 'rgba(34,197,94,0.15)', b: '#22c55e' },
            { bg: 'rgba(16,185,129,0.15)', b: '#10b981' },
            { bg: 'rgba(132,204,22,0.15)', b: '#84cc16' },
            // Yellows/Oranges
            { bg: 'rgba(255,173,31,0.15)', b: '#ffad1f' },
            { bg: 'rgba(251,191,36,0.15)', b: '#fbbf24' },
            { bg: 'rgba(245,158,11,0.15)', b: '#f59e0b' },
            { bg: 'rgba(249,115,22,0.15)', b: '#f97316' },
            // Reds/Pinks
            { bg: 'rgba(249,24,128,0.15)', b: '#f91880' },
            { bg: 'rgba(239,68,68,0.15)', b: '#ef4444' },
            { bg: 'rgba(244,63,94,0.15)', b: '#f43f5e' },
            { bg: 'rgba(236,72,153,0.15)', b: '#ec4899' },
            // Purples
            { bg: 'rgba(120,86,255,0.15)', b: '#7856ff' },
            { bg: 'rgba(168,85,247,0.15)', b: '#a855f7' },
            { bg: 'rgba(139,92,246,0.15)', b: '#8b5cf6' },
            { bg: 'rgba(192,132,252,0.15)', b: '#c084fc' },
            // Teals/Cyans
            { bg: 'rgba(20,184,166,0.15)', b: '#14b8a6' },
            { bg: 'rgba(6,182,212,0.15)', b: '#06b6d4' },
            { bg: 'rgba(34,211,238,0.15)', b: '#22d3ee' },
            // Others
            { bg: 'rgba(244,114,182,0.15)', b: '#f472b6' },
            { bg: 'rgba(251,146,60,0.15)', b: '#fb923c' },
            { bg: 'rgba(163,230,53,0.15)', b: '#a3e635' },
        ]; 
        let h = 0; 
        for (let i = 0; i < n.length; i++) h = n.charCodeAt(i) + ((h << 5) - h); 
        return c[Math.abs(h) % c.length]; 
    },
    preview: { backgroundColor: '#0f1419', border: '1px solid #2f3336', borderRadius: '8px', padding: '12px', marginTop: '12px', maxHeight: '150px', overflowY: 'auto' },
    previewItem: { padding: '4px 8px', fontSize: '13px', color: '#8b98a5', display: 'flex', alignItems: 'center', gap: '8px' },
    clipboardBanner: { padding: '12px 16px', backgroundColor: '#1a3d2e', borderBottom: '1px solid #2d4a3e', display: 'flex', alignItems: 'center', justifyContent: 'space-between', fontSize: '13px', color: '#00ba7c' },
    toast: { position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)', backgroundColor: '#1a1f26', color: '#e7e9ea', padding: '12px 24px', borderRadius: '8px', border: '1px solid #2f3336', boxShadow: '0 4px 12px rgba(0,0,0,0.4)', fontSize: '14px', zIndex: 2000 },
};

const Icons = {
    Location: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
    Sublocation: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>,
    ChevronsDown: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg>,
    ChevronsUp: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg>,
    Plus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Search: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    Package: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
    Database: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
    ChevronRight: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
    ChevronDown: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>,
    Trash: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
    Download: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    Zap: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
    Layers: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
    Copy: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
    Clipboard: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
    Duplicate: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="8" y="8" width="12" height="12" rx="2"/><path d="M16 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2"/></svg>,
    X: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    DollarSign: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
    Clock: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    SortAZ: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h7"/><path d="M3 12h5"/><path d="M3 18h3"/><path d="M16 6l4 14"/><path d="M20 6l-4 14"/><path d="M14 14h8"/></svg>,
    Filter: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
    Template: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>,
    Save: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
    Undo: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
    Redo: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>,
    Edit: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    Star: ({ filled }) => <svg width="16" height="16" viewBox="0 0 24 24" fill={filled ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
    Users: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    Copy: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
    Lock: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
    Unlock: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
    Download: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    Upload: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
    ChevronsDown: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg>,
    ChevronsUp: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg>,
    ChevronUp: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>,
    ChevronLeft: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,
    ViewSingle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>,
    ViewAll: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="5" rx="1"/><rect x="3" y="10" width="18" height="5" rx="1"/><rect x="3" y="17" width="18" height="5" rx="1"/></svg>,
    Compact: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="10" x2="20" y2="10"/><line x1="4" y1="14" x2="20" y2="14"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
    Comfortable: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="4" y1="5" x2="20" y2="5"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="19" x2="20" y2="19"/></svg>,
    Cloud: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
    CloudOff: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M18.73 18.73A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-11.62-6"/><path d="M5 5a8 8 0 0 0 3 15.09"/></svg>,
    Sync: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
    Check: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
    AlertTriangle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
};

function parseLocationInput(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const results = [];
    for (const line of lines) {
        const rangeMatch = line.match(/^(.+?)(\d+)-(\d+)$/);
        if (rangeMatch) {
            const prefix = rangeMatch[1];
            const start = parseInt(rangeMatch[2]);
            const end = parseInt(rangeMatch[3]);
            const padLength = rangeMatch[2].length;
            if (start <= end && (end - start) <= 100) {
                for (let i = start; i <= end; i++) {
                    results.push(prefix + String(i).padStart(padLength, '0'));
                }
            } else results.push(line);
        } else results.push(line);
    }
    return results;
}

function calculateTotals(location, catalogPkgs, projectPkgs) {
    let cost = 0, labor = 0, itemCount = 0;
    if (location.items) {
        for (const item of location.items) {
            if (item.type === 'package') {
                const resolved = resolvePackageInstance(item, catalogPkgs, projectPkgs);
                if (resolved && !resolved.isMissing) {
                    cost += resolved.totalCost;
                    labor += resolved.totalLabor;
                    itemCount += resolved.expandedItems.length;
                }
            } else {
                cost += (item.qty || 0) * (item.unitCost || 0);
                labor += (item.qty || 0) * (item.laborHrsPerUnit || 0);
                itemCount += 1;
                // Include accessories in totals
                if (item.accessories) {
                    for (const acc of item.accessories) {
                        cost += (acc.qty || 0) * (acc.unitCost || 0);
                        labor += (acc.qty || 0) * (acc.laborHrsPerUnit || 0);
                        itemCount += 1;
                    }
                }
            }
        }
    }
    if (location.children) {
        for (const child of location.children) {
            const t = calculateTotals(child, catalogPkgs, projectPkgs);
            cost += t.cost; labor += t.labor; itemCount += t.itemCount;
        }
    }
    return { cost, labor, itemCount };
}

function formatCurrency(amount) {
    if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(1) + 'M';
    if (amount >= 1000) return '$' + (amount / 1000).toFixed(1) + 'K';
    return '$' + amount.toFixed(0);
}

function formatHours(hours) { return hours >= 100 ? hours.toFixed(0) + 'h' : hours.toFixed(1) + 'h'; }

function fmtCost(amount) {
    return '$' + Number(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtQty(n) { return Number(n || 0).toLocaleString('en-US'); }
function fmtHrs(hours) {
    return Number(hours || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'h';
}

// ============================================================================
// PACKAGE UTILITIES
// ============================================================================

// Resolve a package instance to its expanded items using catalog/project package definitions
function resolvePackageInstance(instance, catalogPkgs, projectPkgs) {
    if (!instance || instance.type !== 'package') return null;
    const allPkgs = [...(projectPkgs || []), ...(catalogPkgs || [])];
    const def = allPkgs.find(p => p.id === instance.packageId);
    if (!def) return { definition: null, isOutOfDate: false, isMissing: true, expandedItems: [], totalCost: 0, totalLabor: 0 };

    const multiplier = instance.qty || 1;
    const expandedItems = (def.items || []).map(item => ({
        ...item,
        qty: (item.qtyPerPackage || item.qty || 1) * multiplier,
    }));

    let totalCost = 0, totalLabor = 0;
    expandedItems.forEach(item => {
        totalCost += (item.qty || 0) * (item.unitCost || 0);
        totalLabor += (item.qty || 0) * (item.laborHrsPerUnit || 0);
        if (item.accessories) {
            item.accessories.forEach(acc => {
                const accQty = (acc.qtyPer || acc.qty || 0) * multiplier;
                totalCost += accQty * (acc.unitCost || 0);
                totalLabor += accQty * (acc.laborHrsPerUnit || 0);
            });
        }
    });

    return {
        definition: def,
        isOutOfDate: (def.version || 1) > (instance.packageVersion || 1),
        isMissing: false,
        expandedItems,
        totalCost,
        totalLabor,
    };
}

// Flatten a location's items, expanding package instances into individual items (for exports/BOM)
function getFlattenedItems(location, catalogPkgs, projectPkgs) {
    const result = [];
    for (const item of (location.items || [])) {
        if (item.type === 'package') {
            const resolved = resolvePackageInstance(item, catalogPkgs, projectPkgs);
            if (resolved && !resolved.isMissing) {
                resolved.expandedItems.forEach(ei => {
                    // Push expanded item with accessories intact (qty already multiplied by resolvePackageInstance)
                    // Accessories also need qty multiplied by package qty
                    const multiplier = item.qty || 1;
                    const expandedAccessories = ei.accessories ? ei.accessories.map(acc => ({
                        ...acc,
                        qty: (acc.qtyPer || acc.qty || 0) * multiplier,
                    })) : undefined;
                    result.push({ ...ei, accessories: expandedAccessories });
                });
            }
        } else {
            result.push(item);
        }
    }
    return result;
}

// Find all instances of a package across all locations (recursive)
function findAllPackageInstances(locations, packageId) {
    const results = [];
    const search = (locs, path) => {
        for (const loc of (locs || [])) {
            (loc.items || []).forEach((item, idx) => {
                if (item.type === 'package' && item.packageId === packageId) {
                    results.push({ locationId: loc.id, locationName: loc.name, path: [...path, loc.name], itemIdx: idx, instance: item });
                }
            });
            if (loc.children) search(loc.children, [...path, loc.name]);
        }
    };
    search(locations, []);
    return results;
}

// Generate a unique package ID
function generatePackageId() {
    return 'pkg-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

// Migrate old-style packageName items to new package instance model
function migrateProjectPackages(project, existingPackages) {
    if (project.packageMigrationVersion >= 1) return { project, newPackageDefs: [] };

    const newPackageDefs = [];
    let changed = false;

    const migrateLoc = (loc) => {
        if (!loc.items || loc.items.length === 0) return loc;

        const packageGroups = {};
        const otherItems = [];

        loc.items.forEach(item => {
            if (item.type === 'package') {
                otherItems.push(item); // Already migrated
            } else if (item.packageName) {
                if (!packageGroups[item.packageName]) packageGroups[item.packageName] = [];
                packageGroups[item.packageName].push(item);
                changed = true;
            } else {
                otherItems.push(item);
            }
        });

        // Convert each package group to a package instance
        const newItems = [...otherItems];
        Object.entries(packageGroups).forEach(([name, items]) => {
            // Try to find existing package definition
            let def = [...existingPackages, ...newPackageDefs].find(p => p.name === name);
            if (!def) {
                def = {
                    id: generatePackageId(),
                    name,
                    scope: 'catalog',
                    version: 1,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    items: items.map(i => {
                        const { packageName: _, ...rest } = i;
                        return { ...rest, qtyPerPackage: i.qty || 1 };
                    }),
                };
                newPackageDefs.push(def);
            }
            newItems.push({
                type: 'package',
                packageId: def.id,
                packageName: name,
                packageVersion: def.version || 1,
                qty: 1,
                notes: '',
            });
        });

        return {
            ...loc,
            items: newItems,
            children: loc.children ? loc.children.map(migrateLoc) : loc.children,
        };
    };

    const migratedLocations = (project.locations || []).map(migrateLoc);

    return {
        project: changed ? { ...project, locations: migratedLocations, packageMigrationVersion: 1 } : { ...project, packageMigrationVersion: 1 },
        newPackageDefs,
    };
}

// Migrate existing package definitions to add new fields (scope, version, qtyPerPackage)
function migratePackageDefinitions(packages) {
    return (packages || []).map(pkg => ({
        ...pkg,
        id: pkg.id || generatePackageId(),
        scope: pkg.scope || 'catalog',
        version: pkg.version || 1,
        createdAt: pkg.createdAt || new Date().toISOString(),
        updatedAt: pkg.updatedAt || new Date().toISOString(),
        items: (pkg.items || []).map(item => ({
            ...item,
            qtyPerPackage: item.qtyPerPackage || item.qty || 1,
        })),
    }));
}

// Get the path to a location (returns array of ancestor names, not including the location itself)
function getLocationPath(locations, targetId, currentPath = []) {
    for (const loc of locations) {
        if (loc.id === targetId) {
            return currentPath;
        }
        if (loc.children) {
            const found = getLocationPath(loc.children, targetId, [...currentPath, loc.name]);
            if (found) return found;
        }
    }
    return null;
}

// Get all locations flattened with path info (includes empty locations)
function getAllLocationsFlatted(locations, parentPath = '') {
    let result = [];
    for (const loc of locations) {
        const path = parentPath ? `${parentPath} > ${loc.name}` : loc.name;
        result.push({ ...loc, path, depth: parentPath.split(' > ').filter(Boolean).length });
        
        if (loc.children) {
            result = result.concat(getAllLocationsFlatted(loc.children, path));
        }
    }
    return result;
}

// Get all locations with items (flattened with path info)
function getLocationsWithItems(locations, parentPath = '') {
    let result = [];
    for (const loc of locations) {
        const path = parentPath ? `${parentPath} > ${loc.name}` : loc.name;
        const hasItems = loc.items && loc.items.length > 0;
        const hasChildrenWithItems = loc.children && loc.children.some(c => {
            const check = (l) => (l.items?.length > 0) || (l.children?.some(check));
            return check(c);
        });
        
        if (hasItems) {
            result.push({ ...loc, path, depth: parentPath.split(' > ').filter(Boolean).length });
        }
        
        if (loc.children) {
            result = result.concat(getLocationsWithItems(loc.children, path));
        }
    }
    return result;
}

// Get available hierarchy levels from location tree
function getHierarchyLevels(locations) {
    const levels = [{ depth: -1, label: 'Entire Project' }];
    const allFlat = getAllLocationsFlatted(locations);
    const maxDepth = allFlat.reduce((max, loc) => Math.max(max, loc.depth), 0);
    for (let d = 0; d <= maxDepth; d++) {
        const namesAtDepth = allFlat.filter(l => l.depth === d).map(l => l.name);
        const unique = [...new Set(namesAtDepth)];
        const examples = unique.slice(0, 3).join(', ');
        const extra = unique.length > 3 ? ', ...' : '';
        levels.push({ depth: d, label: `By: ${examples}${extra}` });
    }
    return levels;
}

// Group locations by hierarchy depth for reports
// Returns array of { name, path, locations: [leaf locations with items] }
function getGroupedByHierarchy(locations, targetDepth, catalogPkgs, projectPkgs) {
    if (targetDepth === -1) {
        // Entire project = one group
        const locsWithItems = getLocationsWithItems(locations);
        return [{ name: 'Entire Project', path: '', locations: locsWithItems }];
    }
    // Collect nodes at the target depth
    const collectAtDepth = (locs, currentDepth, parentPath) => {
        let groups = [];
        for (const loc of locs) {
            const path = parentPath ? `${parentPath} > ${loc.name}` : loc.name;
            if (currentDepth === targetDepth) {
                // This node is at target depth - collect all descendant leaf locations
                const descendantLeaves = getLocationsWithItems([loc], parentPath);
                if (descendantLeaves.length > 0) {
                    groups.push({ name: path, path, locations: descendantLeaves });
                }
            } else if (loc.children && currentDepth < targetDepth) {
                groups = groups.concat(collectAtDepth(loc.children, currentDepth + 1, path));
            }
        }
        return groups;
    };
    return collectAtDepth(locations, 0, '');
}

function cloneStructure(location, newName, includeItems = true) {
    return {
        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
        name: newName,
        children: location.children ? location.children.map(child => cloneStructure(child, child.name, includeItems)) : [],
        items: includeItems && location.items ? location.items.map(item => ({
            ...item,
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            accessories: item.accessories ? item.accessories.map(acc => ({
                ...acc,
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
            })) : []
        })) : []
    };
}

function sortLocationsAlpha(locations) {
    return [...locations].sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
}

function filterLocations(locations, searchTerm) {
    if (!searchTerm) return locations;
    const term = searchTerm.toLowerCase();
    
    const matches = (loc) => {
        if (loc.name.toLowerCase().includes(term)) return true;
        if (loc.children) return loc.children.some(matches);
        return false;
    };
    
    const filterTree = (locs) => {
        return locs.filter(matches).map(loc => ({
            ...loc,
            children: loc.children ? filterTree(loc.children) : []
        }));
    };
    
    return filterTree(locations);
}

// Generate Esticom-compatible BoM workbook for a single location
function generateEsticomWorkbook(location, catalogPkgs, projectPkgs) {
    const XLSX = window.XLSX;
    const wb = XLSX.utils.book_new();

    // Use getFlattenedItems to expand package instances into individual items
    const flatItems = getFlattenedItems(location, catalogPkgs, projectPkgs);

    // Consolidate all items + accessories into unique part numbers
    const partMap = {};
    for (const item of flatItems) {
        const key = item.partNumber || (item.manufacturer + '|' + item.model);
        if (partMap[key]) {
            partMap[key].qty += (item.qty || 0);
        } else {
            partMap[key] = {
                qty: item.qty || 0,
                name: item.description || ((item.manufacturer || '') + ' ' + (item.model || '')).trim(),
                manufacturer: item.manufacturer || '',
                supplier: item.vendor || '',
                partNumber: item.partNumber || '',
                uom: item.uom || 'EA',
                unitCost: item.unitCost || 0
            };
        }
        // Include accessories as their own line items
        if (item.accessories) {
            for (const acc of item.accessories) {
                const accKey = acc.partNumber || (acc.manufacturer + '|' + acc.model);
                if (partMap[accKey]) {
                    partMap[accKey].qty += (acc.qty || 0);
                } else {
                    partMap[accKey] = {
                        qty: acc.qty || 0,
                        name: acc.description || ((acc.manufacturer || '') + ' ' + (acc.model || '')).trim(),
                        manufacturer: acc.manufacturer || '',
                        supplier: acc.vendor || '',
                        partNumber: acc.partNumber || '',
                        uom: acc.uom || 'EA',
                        unitCost: acc.unitCost || 0
                    };
                }
            }
        }
    }

    // Build array-of-arrays matching Esticom template layout
    const data = [];
    data.push([]);  // Row 1: empty
    data.push(['BILL OF MATERIALS (Import Template)', '', '', '', '', '', '']);  // Row 2: title
    data.push([]);  // Row 3: empty
    data.push([]);  // Row 4: empty
    data.push(['QTY', 'Name', 'Manufacturer', 'Supplier', 'Part Number', 'UOM', 'Item Cost']);  // Row 5: headers
    data.push([]);  // Row 6: blank separator

    // Row 7+: consolidated data rows
    for (const part of Object.values(partMap)) {
        data.push([
            part.qty,
            part.name,
            part.manufacturer,
            part.supplier,
            part.partNumber,
            part.uom,
            part.unitCost
        ]);
    }

    const ws = XLSX.utils.aoa_to_sheet(data);

    // Merge title row A2:G2
    ws['!merges'] = [
        { s: { r: 1, c: 0 }, e: { r: 1, c: 6 } }
    ];

    // Column widths matching Esticom template
    ws['!cols'] = [
        { wch: 5 },    // A: QTY
        { wch: 30 },   // B: Name
        { wch: 14 },   // C: Manufacturer
        { wch: 12 },   // D: Supplier
        { wch: 13 },   // E: Part Number
        { wch: 10 },   // F: UOM
        { wch: 10 },   // G: Item Cost
    ];

    XLSX.utils.book_append_sheet(wb, ws, 'Bill of materials');
    return wb;
}

function LocationTree({ locations, selectedId, onSelect, onDelete, onRename, onDuplicate, onMoveUp, onMoveDown, onPromote, onDemote, multiSelect, onMultiSelectToggle, depth = 0, searchTerm, expandedState, onToggleExpand, catalogPkgs, projectPkgs }) {
    const [contextMenu, setContextMenu] = useState(null);
    const [hoveredId, setHoveredId] = useState(null);
    const [editingId, setEditingId] = useState(null);
    const [editName, setEditName] = useState('');
    const toggle = (id, e) => { e.stopPropagation(); onToggleExpand(id); };
    
    const filteredLocations = useMemo(() => filterLocations(locations, searchTerm), [locations, searchTerm]);
    
    // Close context menu on click outside
    useEffect(() => {
        const handleClick = () => setContextMenu(null);
        if (contextMenu) window.addEventListener('click', handleClick);
        return () => window.removeEventListener('click', handleClick);
    }, [contextMenu]);
    
    const handleContextMenu = (e, loc) => {
        e.preventDefault();
        setContextMenu({ x: e.clientX, y: e.clientY, location: loc });
    };
    
    const handleClick = (loc, e) => {
        if (e.shiftKey || e.ctrlKey || e.metaKey) {
            // Shift/Ctrl+click toggles multi-select (event passed for shift-range)
            onMultiSelectToggle(loc, e);
        } else {
            onSelect(loc);
        }
    };
    
    const startRename = (loc) => {
        setEditingId(loc.id);
        setEditName(loc.name);
        setContextMenu(null);
    };
    
    const confirmRename = (loc) => {
        if (editName.trim() && editName.trim() !== loc.name) {
            onRename(loc.id, editName.trim());
        }
        setEditingId(null);
        setEditName('');
    };
    
    const cancelRename = () => {
        setEditingId(null);
        setEditName('');
    };
    
    if (filteredLocations.length === 0 && searchTerm) {
        return <div style={{ padding: '20px', textAlign: 'center', color: '#6e767d', fontSize: '13px' }}>No locations match "{searchTerm}"</div>;
    }
    
    return (
        <div>
            {filteredLocations.map(loc => {
                const has = loc.children?.length > 0;
                const exp = expandedState[loc.id];
                const sel = selectedId === loc.id;
                const isMultiSelected = multiSelect.some(l => l.id === loc.id);
                const totals = calculateTotals(loc, catalogPkgs, projectPkgs);
                const nameMatch = searchTerm && loc.name.toLowerCase().includes(searchTerm.toLowerCase());
                const isHovered = hoveredId === loc.id;
                const highlighted = sel || isMultiSelected;
                const isEditing = editingId === loc.id;
                return (
                    <div key={loc.id}>
                        <div style={{ 
                            ...styles.treeItem(depth, highlighted), 
                            backgroundColor: isMultiSelected ? '#3d1a1a' : sel ? '#1d3a5c' : nameMatch ? '#2d2a1a' : 'transparent', 
                            borderColor: isMultiSelected ? '#f87171' : sel ? '#1d9bf0' : 'transparent',
                            position: 'relative' 
                        }} 
                            onClick={e => !isEditing && handleClick(loc, e)}
                            onContextMenu={e => handleContextMenu(e, loc)}
                            onMouseEnter={e => { setHoveredId(loc.id); if (!highlighted && !nameMatch) e.currentTarget.style.backgroundColor = '#1a1f26'; }}
                            onMouseLeave={e => { setHoveredId(null); if (!highlighted) e.currentTarget.style.backgroundColor = nameMatch ? '#2d2a1a' : 'transparent'; }}>
                            {has ? <span onClick={e => { e.stopPropagation(); toggle(loc.id, e); }} style={{ cursor: 'pointer', display: 'flex' }}>{exp ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</span> : <span style={{ width: 14 }} />}
                            {depth === 0 ? <Icons.Location /> : <Icons.Sublocation />}
                            {isEditing ? (
                                <input 
                                    type="text"
                                    value={editName}
                                    onChange={e => setEditName(e.target.value)}
                                    onBlur={() => confirmRename(loc)}
                                    onKeyDown={e => {
                                        if (e.key === 'Enter') confirmRename(loc);
                                        if (e.key === 'Escape') cancelRename();
                                    }}
                                    onClick={e => e.stopPropagation()}
                                    style={{ ...styles.inputSmall, width: '100px', padding: '2px 6px', fontSize: '13px' }}
                                    autoFocus
                                />
                            ) : (
                                <span 
                                    style={{ fontWeight: highlighted ? '600' : '400', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: isHovered ? '100px' : '120px' }}
                                    onDoubleClick={e => { e.stopPropagation(); startRename(loc); }}
                                >
                                    {loc.name}
                                </span>
                            )}
                            {totals.itemCount > 0 && !isHovered && !isEditing && (
                                <div style={styles.treeItemTotals}>
                                    <span style={{ color: '#00ba7c' }}>{fmtCost(totals.cost)}</span>
                                    <span style={{ color: '#1d9bf0' }}>{formatHours(totals.labor)}</span>
                                </div>
                            )}
                            {isHovered && !isEditing && (
                                <button 
                                    style={{ ...styles.iconButton, marginLeft: 'auto', color: '#f87171', padding: '4px' }} 
                                    onClick={e => { e.stopPropagation(); onDelete(loc); }}
                                    title="Delete location">
                                    <Icons.Trash />
                                </button>
                            )}
                        </div>
                        {has && exp && <LocationTree locations={loc.children} selectedId={selectedId} onSelect={onSelect} onDelete={onDelete} onRename={onRename} onDuplicate={onDuplicate} onMoveUp={onMoveUp} onMoveDown={onMoveDown} onPromote={onPromote} onDemote={onDemote} multiSelect={multiSelect} onMultiSelectToggle={onMultiSelectToggle} depth={depth + 1} searchTerm={searchTerm} expandedState={expandedState} onToggleExpand={onToggleExpand} catalogPkgs={catalogPkgs} projectPkgs={projectPkgs} />}
                    </div>
                );
            })}
            
            {/* Context Menu */}
            {contextMenu && (
                <div style={{ 
                    position: 'fixed', 
                    left: contextMenu.x, 
                    top: contextMenu.y, 
                    backgroundColor: '#1a1f26', 
                    border: '1px solid #2f3336', 
                    borderRadius: '8px', 
                    padding: '4px', 
                    zIndex: 1000,
                    boxShadow: '0 4px 12px rgba(0,0,0,0.4)',
                    minWidth: '160px'
                }}>
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '8px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#e6edf3', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '13px'
                        }}
                        onClick={() => startRename(contextMenu.location)}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.Edit /> Rename
                    </button>
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '8px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#ffad1f', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '13px'
                        }}
                        onClick={() => { onDuplicate(contextMenu.location); setContextMenu(null); }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#3d2e1a'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.Duplicate /> Duplicate
                    </button>
                    <div style={{ borderTop: '1px solid #2f3336', margin: '4px 0' }} />
                    <div style={{ padding: '4px 12px', fontSize: '10px', color: '#6e767d', textTransform: 'uppercase' }}>Move</div>
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '6px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#8b98a5', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '12px'
                        }}
                        onClick={() => { onMoveUp(contextMenu.location.id); setContextMenu(null); }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.ChevronUp /> Move Up
                    </button>
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '6px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#8b98a5', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '12px'
                        }}
                        onClick={() => { onMoveDown(contextMenu.location.id); setContextMenu(null); }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.ChevronDown /> Move Down
                    </button>
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '6px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#8b98a5', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '12px'
                        }}
                        onClick={() => { onPromote(contextMenu.location.id); setContextMenu(null); }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.ChevronsUp /> Promote ( Level)
                    </button>
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '6px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#8b98a5', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '12px'
                        }}
                        onClick={() => { onDemote(contextMenu.location.id); setContextMenu(null); }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.ChevronsDown /> Demote ( Level)
                    </button>
                    <div style={{ borderTop: '1px solid #2f3336', margin: '4px 0' }} />
                    <button 
                        style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            width: '100%', 
                            padding: '8px 12px', 
                            border: 'none', 
                            backgroundColor: 'transparent', 
                            color: '#f87171', 
                            cursor: 'pointer', 
                            borderRadius: '4px',
                            fontSize: '13px'
                        }}
                        onClick={() => { onDelete(contextMenu.location); setContextMenu(null); }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#3d1a1a'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                        <Icons.Trash /> Delete
                    </button>
                </div>
            )}
        </div>
    );
}

function SearchModal({ catalog, packages, projectPackages, onClose, onInsert, onInsertPkg }) {
    const [search, setSearch] = useState('');
    const [selected, setSelected] = useState([]);
    const [qty, setQty] = useState(1);
    const [tab, setTab] = useState('components');
    const [filterCategory, setFilterCategory] = useState('');
    const [filterSubcategory, setFilterSubcategory] = useState('');
    const [filterManufacturer, setFilterManufacturer] = useState('');
    const searchRef = useRef(null);

    // Custom item state
    const [customItem, setCustomItem] = useState({
        manufacturer: '', model: '', partNumber: '', description: '',
        category: '', subcategory: '', unitCost: '', laborHrsPerUnit: '', uom: 'EA'
    });

    // Placeholder state
    const [phCategory, setPhCategory] = useState('');
    const [phSubcategory, setPhSubcategory] = useState('');
    const [phTier, setPhTier] = useState('mid');
    const [phDescription, setPhDescription] = useState('');

    const phSubcategories = useMemo(() => {
        if (!phCategory) return [];
        return [...new Set(catalog.filter(c => c.category === phCategory && !c.deleted && !c.discontinued).map(c => c.subcategory).filter(Boolean))].sort();
    }, [catalog, phCategory]);

    const phStats = useMemo(() => {
        if (!phCategory) return null;
        let items = catalog.filter(c => c.category === phCategory && !c.deleted && !c.discontinued && c.unitCost > 0);
        if (phSubcategory) items = items.filter(c => c.subcategory === phSubcategory);
        if (items.length === 0) return null;
        const costs = items.map(c => c.unitCost).sort((a, b) => a - b);
        const labors = items.map(c => c.laborHrsPerUnit || 0).sort((a, b) => a - b);
        const percentile = (arr, p) => {
            const idx = (arr.length - 1) * p;
            const lo = Math.floor(idx);
            const hi = Math.ceil(idx);
            return lo === hi ? arr[lo] : arr[lo] + (arr[hi] - arr[lo]) * (idx - lo);
        };
        return {
            count: items.length,
            items: items.sort((a, b) => a.unitCost - b.unitCost),
            low: { cost: percentile(costs, 0.25), labor: percentile(labors, 0.25) },
            mid: { cost: percentile(costs, 0.5), labor: percentile(labors, 0.5) },
            high: { cost: percentile(costs, 0.75), labor: percentile(labors, 0.75) },
            min: costs[0],
            max: costs[costs.length - 1],
        };
    }, [catalog, phCategory, phSubcategory]);

    const [showPhItems, setShowPhItems] = useState(false);
    
    // Get unique values for dropdowns
    const categories = useMemo(() => [...new Set(catalog.map(c => c.category))].sort(), [catalog]);
    const subcategories = useMemo(() => {
        const filtered = filterCategory ? catalog.filter(c => c.category === filterCategory) : catalog;
        return [...new Set(filtered.map(c => c.subcategory).filter(Boolean))].sort();
    }, [catalog, filterCategory]);
    const manufacturers = useMemo(() => [...new Set(catalog.map(c => c.manufacturer))].sort(), [catalog]);
    
    // Filter results
    const results = useMemo(() => {
        let filtered = catalog;
        
        // Apply dropdown filters
        if (filterCategory) filtered = filtered.filter(c => c.category === filterCategory);
        if (filterSubcategory) filtered = filtered.filter(c => c.subcategory === filterSubcategory);
        if (filterManufacturer) filtered = filtered.filter(c => c.manufacturer === filterManufacturer);
        
        // Apply text search (searches across all relevant fields)
        if (search.length >= 1) {
            const term = search.toLowerCase();
            filtered = filtered.filter(c => 
                (c.manufacturer?.toLowerCase().includes(term)) ||
                (c.model?.toLowerCase().includes(term)) ||
                (c.partNumber?.toLowerCase().includes(term)) ||
                (c.description?.toLowerCase().includes(term)) ||
                (c.category?.toLowerCase().includes(term)) ||
                (c.subcategory?.toLowerCase().includes(term))
            );
        }
        
        // Sort favorites first
        filtered.sort((a, b) => (b.favorite ? 1 : 0) - (a.favorite ? 1 : 0));
        return filtered.slice(0, 50);
    }, [catalog, search, filterCategory, filterSubcategory, filterManufacturer]);
    
    const allPkgs = useMemo(() => [
        ...(packages || []).map(p => ({ ...p, _scope: 'catalog' })),
        ...(projectPackages || []).map(p => ({ ...p, _scope: 'project' })),
    ], [packages, projectPackages]);
    const pkgResults = search.length >= 2 ? allPkgs.filter(p => p.name.toLowerCase().includes(search.toLowerCase())) : allPkgs;
    
    const toggle = (item, e) => { 
        if (e.ctrlKey || e.metaKey) {
            setSelected(p => p.find(s => s.id === item.id) ? p.filter(s => s.id !== item.id) : [...p, item]); 
        } else {
            setSelected([item]); 
        }
    };
    
    const [addedFeedback, setAddedFeedback] = useState('');
    const [selectedPkgId, setSelectedPkgId] = useState(null);
    const insert = () => {
        if (selected.length > 0) {
            onInsert(selected, qty);
            setAddedFeedback(`Added ${selected.length} item${selected.length > 1 ? 's' : ''}`);
            setSelected([]);
            setTimeout(() => setAddedFeedback(''), 2000);
        }
    };
    const insertSelectedPkg = () => {
        const pkg = allPkgs.find(p => p.id === selectedPkgId);
        if (pkg) {
            onInsertPkg(pkg, qty);
            setAddedFeedback(`Added package: ${pkg.name}`);
            setSelectedPkgId(null);
            setTimeout(() => setAddedFeedback(''), 2000);
        }
    };
    
    const clearFilters = () => {
        setFilterCategory('');
        setFilterSubcategory('');
        setFilterManufacturer('');
        setSearch('');
        searchRef.current?.focus();
    };
    
    const hasFilters = filterCategory || filterSubcategory || filterManufacturer || search;
    
    // Handle Enter key to insert
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (tab === 'components' && selected.length > 0) {
                    e.preventDefault();
                    insert();
                } else if (tab === 'packages' && selectedPkgId) {
                    e.preventDefault();
                    insertSelectedPkg();
                }
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [selected, qty, tab, selectedPkgId]);
    
    // Focus search on open
    useEffect(() => { searchRef.current?.focus(); }, []);
    
    const selectStyle = { 
        ...styles.inputSmall, 
        flex: 1, 
        minWidth: '120px',
        cursor: 'pointer',
        appearance: 'none',
        backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b98a5' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E")`,
        backgroundRepeat: 'no-repeat',
        backgroundPosition: 'right 8px center',
        paddingRight: '28px'
    };
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '750px', maxWidth: '95vw' }} onClick={e => e.stopPropagation()}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <Icons.Search /> Add Components
                    </h2>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        <button style={{ ...styles.smallButton, backgroundColor: tab === 'components' ? '#1d9bf0' : '#2f3336' }} onClick={() => setTab('components')}>
                            Components {tab === 'components' && `(${results.length})`}
                        </button>
                        <button style={{ ...styles.smallButton, backgroundColor: tab === 'packages' ? '#1d9bf0' : '#2f3336' }} onClick={() => setTab('packages')}>
                            Packages ({pkgResults.length})
                        </button>
                        <button style={{ ...styles.smallButton, backgroundColor: tab === 'placeholder' ? '#a78bfa' : '#2f3336' }} onClick={() => setTab('placeholder')}>
                            Placeholder
                        </button>
                        <button style={{ ...styles.smallButton, backgroundColor: tab === 'custom' ? '#00ba7c' : '#2f3336' }} onClick={() => setTab('custom')}>
                            <Icons.Plus /> Custom Item
                        </button>
                    </div>
                </div>
                
                {tab === 'components' && (
                    <>
                        {/* Filter Row */}
                        <div style={{ display: 'flex', gap: '8px', marginBottom: '12px', flexWrap: 'wrap' }}>
                            <select value={filterManufacturer} onChange={e => setFilterManufacturer(e.target.value)} style={selectStyle}>
                                <option value="">All Manufacturers</option>
                                {manufacturers.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                            <select value={filterCategory} onChange={e => { setFilterCategory(e.target.value); setFilterSubcategory(''); }} style={selectStyle}>
                                <option value="">All Categories</option>
                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <select value={filterSubcategory} onChange={e => setFilterSubcategory(e.target.value)} style={selectStyle} disabled={!filterCategory && subcategories.length === 0}>
                                <option value="">All Subcategories</option>
                                {subcategories.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            {hasFilters && (
                                <button style={{ ...styles.smallButton, color: '#8b98a5' }} onClick={clearFilters}>
                                    <Icons.X /> Clear
                                </button>
                            )}
                        </div>
                        
                        {/* Search Input */}
                        <div style={{ position: 'relative', marginBottom: '12px' }}>
                            <input 
                                ref={searchRef}
                                type="text" 
                                placeholder="Search by model, part number, description..." 
                                value={search} 
                                onChange={e => setSearch(e.target.value)} 
                                style={{ ...styles.input, paddingLeft: '36px' }} 
                            />
                            <div style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#6e767d' }}>
                                <Icons.Search />
                            </div>
                        </div>
                    </>
                )}
                
                {tab === 'packages' && (
                    <input 
                        type="text" 
                        placeholder="Search packages..." 
                        value={search} 
                        onChange={e => setSearch(e.target.value)} 
                        style={{ ...styles.input, marginBottom: '12px' }} 
                        autoFocus 
                    />
                )}
                
                {/* Results */}
                {tab === 'components' && (
                    <div style={{ ...styles.searchResults, maxHeight: '350px' }}>
                        {results.length > 0 ? results.map(item => {
                            const isSelected = selected.find(s => s.id === item.id);
                            const hasAccessories = item.defaultAccessories?.length > 0;
                            const accessoryItems = hasAccessories ? item.defaultAccessories.map(acc => catalog.find(c => c.id === acc.catalogId)).filter(Boolean) : [];
                            
                            return (
                                <div key={item.id}
                                    style={{ ...styles.searchItem(isSelected), padding: '12px 14px' }}
                                    onClick={e => toggle(item, e)}
                                    onDoubleClick={() => { onInsert([item], qty); setAddedFeedback('Added 1 item'); setTimeout(() => setAddedFeedback(''), 2000); }}
                                    onMouseEnter={e => { if (!isSelected) e.currentTarget.style.backgroundColor = '#1a1f26'; }}
                                    onMouseLeave={e => { if (!isSelected) e.currentTarget.style.backgroundColor = 'transparent'; }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', gap: '16px' }}>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ fontWeight: '600', marginBottom: '2px' }}>{item.favorite && <span style={{ color: '#f59e0b', marginRight: '4px' }}><Icons.Star filled /></span>}{item.manufacturer} <span style={{ color: '#1d9bf0' }}>{item.model}</span></div>
                                            <div style={{ fontSize: '12px', color: '#6e767d', marginBottom: '4px' }}>{item.partNumber}</div>
                                            <div style={{ fontSize: '13px', color: '#8b98a5', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{item.description}</div>
                                        </div>
                                        <div style={{ textAlign: 'right', flexShrink: 0 }}>
                                            <div style={{ fontWeight: '600', color: '#00ba7c' }}>{fmtCost(item.unitCost)}</div>
                                            <div style={{ fontSize: '12px', color: '#8b98a5' }}>{item.laborHrsPerUnit}h labor</div>
                                        </div>
                                    </div>
                                    <div style={{ marginTop: '6px', display: 'flex', gap: '6px', flexWrap: 'wrap', alignItems: 'center' }}>
                                        <span style={styles.badge('blue')}>{item.category}</span>
                                        {item.subcategory && <span style={styles.badge('purple')}>{item.subcategory}</span>}
                                        {item.discontinued && <span style={styles.badge('red')}>Discontinued</span>}
                                        {hasAccessories && (
                                            <span style={{ ...styles.badge('orange'), display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                <Icons.Package /> {item.defaultAccessories.length} accessories
                                            </span>
                                        )}
                                    </div>
                                    {/* Show accessories preview when selected */}
                                    {isSelected && hasAccessories && (
                                        <div style={{ marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #2f3336' }}>
                                            <div style={{ fontSize: '11px', color: '#6e767d', marginBottom: '4px' }}>Includes:</div>
                                            {accessoryItems.map((acc, idx) => (
                                                <div key={idx} style={{ fontSize: '12px', color: '#8b98a5', paddingLeft: '12px' }}>
                                                     {item.defaultAccessories[idx].qtyPer}x {acc.manufacturer} {acc.model}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : (
                            <div style={{ padding: '40px 20px', textAlign: 'center', color: '#6e767d' }}>
                                {hasFilters ? 'No components match your filters' : 'Start typing or select filters to search'}
                            </div>
                        )}
                    </div>
                )}
                
                {tab === 'packages' && (
                    <div style={{ ...styles.searchResults, maxHeight: '350px' }}>
                        {pkgResults.length > 0 ? pkgResults.map(pkg => {
                            const c = styles.pkgColor(pkg.name);
                            const cost = (pkg.items || []).reduce((s, i) => s + ((i.qtyPerPackage || i.qty || 1) * (i.unitCost || 0)), 0);
                            const isPkgSelected = selectedPkgId === pkg.id;
                            return (
                                <div key={pkg.id}
                                    style={{ ...styles.searchItem(isPkgSelected), backgroundColor: isPkgSelected ? '#1d3a5c' : c.bg, borderLeft: `3px solid ${isPkgSelected ? '#1d9bf0' : c.b}` }}
                                    onClick={() => setSelectedPkgId(prev => prev === pkg.id ? null : pkg.id)}
                                    onDoubleClick={() => { onInsertPkg(pkg, qty); setAddedFeedback(`Added package: ${pkg.name}`); setTimeout(() => setAddedFeedback(''), 2000); }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                            <Icons.Package />
                                            <span style={{ fontWeight: '600' }}>{pkg.name}</span>
                                            <span style={styles.badge(pkg._scope === 'catalog' ? 'blue' : 'green')}>{pkg._scope === 'catalog' ? 'Catalog' : 'Project'}</span>
                                            <span style={styles.badge('green')}>{(pkg.items || []).length} items</span>
                                        </div>
                                        <div style={{ fontWeight: '600', color: '#00ba7c' }}>{fmtCost(cost)}</div>
                                    </div>
                                    {(pkg.items || []).length > 0 && (
                                        <div style={{ marginTop: '6px', paddingTop: '6px', borderTop: '1px solid #2f333640' }}>
                                            {pkg.items.slice(0, 4).map((item, i) => (
                                                <div key={i} style={{ fontSize: '12px', color: '#8b98a5', paddingLeft: '12px' }}>
                                                     {item.qtyPerPackage || item.qty || 1}x {item.manufacturer} {item.model}
                                                </div>
                                            ))}
                                            {pkg.items.length > 4 && <div style={{ fontSize: '11px', color: '#6e767d', paddingLeft: '12px' }}>+ {pkg.items.length - 4} more</div>}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : (
                            <div style={{ padding: '40px 20px', textAlign: 'center', color: '#6e767d' }}>No packages found</div>
                        )}
                    </div>
                )}
                
                {tab === 'placeholder' && (
                    <div style={{ padding: '4px 0' }}>
                        <p style={{ color: '#8b98a5', fontSize: '13px', marginBottom: '16px' }}>Add a budget placeholder based on catalog averages. Swap it for a real product later.</p>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Category *</label>
                                <select value={phCategory} onChange={e => { setPhCategory(e.target.value); setPhSubcategory(''); }} style={{ ...styles.input, cursor: 'pointer' }}>
                                    <option value="">Select category...</option>
                                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Subcategory</label>
                                <select value={phSubcategory} onChange={e => setPhSubcategory(e.target.value)} style={{ ...styles.input, cursor: 'pointer' }} disabled={!phCategory}>
                                    <option value="">All in category</option>
                                    {phSubcategories.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                            <div style={{ gridColumn: '1 / -1' }}>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Description (optional)</label>
                                <input type="text" value={phDescription} onChange={e => setPhDescription(e.target.value)} style={styles.input} placeholder="e.g., 85 in. Display for Lobby" />
                            </div>
                        </div>

                        {phStats ? (
                            <>
                                <div style={{ fontSize: '12px', color: '#6e767d', marginBottom: '12px' }}>Based on {phStats.count} catalog item{phStats.count !== 1 ? 's' : ''} &bull; Range: {fmtCost(phStats.min)} &ndash; {fmtCost(phStats.max)}</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '10px' }}>
                                    {[
                                        { key: 'low', label: 'Low (25th %ile)', color: '#00ba7c' },
                                        { key: 'mid', label: 'Mid (Median)', color: '#1d9bf0' },
                                        { key: 'high', label: 'High (75th %ile)', color: '#f59e0b' },
                                    ].map(tier => (
                                        <div
                                            key={tier.key}
                                            style={{
                                                padding: '14px',
                                                backgroundColor: phTier === tier.key ? `${tier.color}15` : '#1a1f26',
                                                border: `2px solid ${phTier === tier.key ? tier.color : '#2f3336'}`,
                                                borderRadius: '10px',
                                                cursor: 'pointer',
                                                textAlign: 'center',
                                                transition: 'all 0.15s',
                                            }}
                                            onClick={() => setPhTier(tier.key)}
                                        >
                                            <div style={{ fontSize: '11px', color: '#8b98a5', marginBottom: '6px', fontWeight: '500' }}>{tier.label}</div>
                                            <div style={{ fontSize: '20px', fontWeight: '700', color: tier.color }}>{fmtCost(phStats[tier.key].cost)}</div>
                                            <div style={{ fontSize: '11px', color: '#6e767d', marginTop: '4px' }}>{phStats[tier.key].labor.toFixed(2)}h labor</div>
                                        </div>
                                    ))}
                                </div>
                                <button
                                    style={{ ...styles.smallButton, marginTop: '12px', color: '#8b98a5', display: 'flex', alignItems: 'center', gap: '4px' }}
                                    onClick={() => setShowPhItems(!showPhItems)}
                                >
                                    {showPhItems ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                                    {showPhItems ? 'Hide' : 'Show'} {phStats.count} catalog items
                                </button>
                                {showPhItems && (
                                    <div style={{ maxHeight: '180px', overflowY: 'auto', marginTop: '8px', borderRadius: '8px', border: '1px solid #2f3336' }}>
                                        <table style={{ ...styles.table, fontSize: '12px' }}>
                                            <thead>
                                                <tr>
                                                    <th style={{ ...styles.th, padding: '6px 10px', fontSize: '11px' }}>Manufacturer</th>
                                                    <th style={{ ...styles.th, padding: '6px 10px', fontSize: '11px' }}>Model</th>
                                                    <th style={{ ...styles.th, padding: '6px 10px', fontSize: '11px', textAlign: 'right' }}>Cost</th>
                                                    <th style={{ ...styles.th, padding: '6px 10px', fontSize: '11px', textAlign: 'right' }}>Labor</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {phStats.items.map(item => (
                                                    <tr key={item.id}>
                                                        <td style={{ ...styles.td, padding: '4px 10px' }}>{item.manufacturer}</td>
                                                        <td style={{ ...styles.td, padding: '4px 10px', color: '#1d9bf0' }}>{item.model}</td>
                                                        <td style={{ ...styles.td, padding: '4px 10px', textAlign: 'right', color: '#00ba7c' }}>{fmtCost(item.unitCost)}</td>
                                                        <td style={{ ...styles.td, padding: '4px 10px', textAlign: 'right' }}>{item.laborHrsPerUnit}h</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </>
                        ) : phCategory ? (
                            <div style={{ padding: '30px 20px', textAlign: 'center', color: '#6e767d' }}>No items with cost data found in this {phSubcategory ? 'subcategory' : 'category'}</div>
                        ) : (
                            <div style={{ padding: '30px 20px', textAlign: 'center', color: '#6e767d' }}>Select a category to see budget tiers</div>
                        )}
                    </div>
                )}

                {tab === 'custom' && (
                    <div style={{ padding: '4px 0' }}>
                        <p style={{ color: '#8b98a5', fontSize: '13px', marginBottom: '16px' }}>Add a component that isn't in the catalog. Fill in the details below.</p>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Manufacturer</label>
                                <input type="text" placeholder="e.g., Crestron" value={customItem.manufacturer} onChange={e => setCustomItem(p => ({ ...p, manufacturer: e.target.value }))} style={styles.input} autoFocus />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Model</label>
                                <input type="text" placeholder="e.g., DM-NVX-363" value={customItem.model} onChange={e => setCustomItem(p => ({ ...p, model: e.target.value }))} style={styles.input} />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Part Number</label>
                                <input type="text" placeholder="Optional" value={customItem.partNumber} onChange={e => setCustomItem(p => ({ ...p, partNumber: e.target.value }))} style={styles.input} />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Description</label>
                                <input type="text" placeholder="e.g., AV over IP Encoder" value={customItem.description} onChange={e => setCustomItem(p => ({ ...p, description: e.target.value }))} style={styles.input} />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Category</label>
                                <input type="text" placeholder="e.g., Switching" value={customItem.category} onChange={e => setCustomItem(p => ({ ...p, category: e.target.value }))} style={styles.input} list="custom-categories" />
                                <datalist id="custom-categories">{[...new Set(catalog.map(c => c.category))].sort().map(c => <option key={c} value={c} />)}</datalist>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Subcategory</label>
                                <input type="text" placeholder="Optional" value={customItem.subcategory} onChange={e => setCustomItem(p => ({ ...p, subcategory: e.target.value }))} style={styles.input} list="custom-subcategories" />
                                <datalist id="custom-subcategories">{[...new Set(catalog.map(c => c.subcategory).filter(Boolean))].sort().map(s => <option key={s} value={s} />)}</datalist>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Unit Cost ($)</label>
                                <input type="number" step="0.01" min="0" placeholder="0.00" value={customItem.unitCost} onChange={e => setCustomItem(p => ({ ...p, unitCost: e.target.value }))} onFocus={e => e.target.select()} style={styles.input} />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Labor Hours</label>
                                <input type="number" step="0.25" min="0" placeholder="0.00" value={customItem.laborHrsPerUnit} onChange={e => setCustomItem(p => ({ ...p, laborHrsPerUnit: e.target.value }))} onFocus={e => e.target.select()} style={styles.input} />
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5' }}>Unit of Measure</label>
                                <select value={customItem.uom} onChange={e => setCustomItem(p => ({ ...p, uom: e.target.value }))} style={styles.input}>
                                    <option value="EA">EA (Each)</option>
                                    <option value="FT">FT (Foot)</option>
                                    <option value="LOT">LOT</option>
                                    <option value="HR">HR (Hour)</option>
                                    <option value="LS">LS (Lump Sum)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                )}

                {/* Footer */}
                <div style={{ marginTop: '16px', display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' }}>
                    <label style={{ fontSize: '14px', color: '#8b98a5' }}>Qty:</label>
                    <input
                        type="number"
                        value={qty}
                        onChange={e => setQty(Math.max(1, parseInt(e.target.value) || 1))}
                        onFocus={e => e.target.select()}
                        style={{ ...styles.inputSmall, width: '70px' }}
                        min="1"
                    />
                    <div style={{ flex: 1 }} />
                    {tab === 'components' && <span style={{ fontSize: '12px', color: '#6e767d' }}>
                        {selected.length > 0 && 'Press Enter to add  '}
                        Ctrl+Click for multi-select  Double-click to add  <kbd style={{ backgroundColor: '#2f3336', padding: '1px 5px', borderRadius: '3px', fontSize: '11px' }}>Ctrl+K</kbd> to open
                    </span>}
                    {tab === 'packages' && <span style={{ fontSize: '12px', color: '#6e767d' }}>
                        {selectedPkgId && 'Press Enter to add  '}
                        Double-click to add
                    </span>}
                    {addedFeedback && <span style={{ color: '#00ba7c', fontSize: '13px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.Check /> {addedFeedback}</span>}
                    <button style={styles.button('secondary')} onClick={onClose}>Close</button>
                    {tab === 'components' && (
                        <button
                            style={{ ...styles.button('primary'), opacity: selected.length === 0 ? 0.5 : 1 }}
                            onClick={insert}
                            disabled={selected.length === 0}>
                            <Icons.Plus /> Add
                        </button>
                    )}
                    {tab === 'packages' && (
                        <button
                            style={{ ...styles.button('primary'), opacity: !selectedPkgId ? 0.5 : 1 }}
                            onClick={insertSelectedPkg}
                            disabled={!selectedPkgId}>
                            <Icons.Plus /> Add
                        </button>
                    )}
                    {tab === 'placeholder' && (
                        <button
                            style={{ ...styles.button('primary'), backgroundColor: '#a78bfa', opacity: (!phCategory || !phStats) ? 0.5 : 1 }}
                            onClick={() => {
                                if (!phCategory || !phStats) return;
                                const tierData = phStats[phTier];
                                const tierLabel = phTier === 'low' ? 'Low' : phTier === 'mid' ? 'Mid' : 'High';
                                const item = {
                                    id: 'placeholder-' + Date.now(),
                                    manufacturer: 'Placeholder',
                                    model: `${tierLabel} ${phSubcategory || phCategory}`,
                                    partNumber: '',
                                    description: phDescription || `${tierLabel} budget ${phSubcategory || phCategory} placeholder`,
                                    category: phCategory,
                                    subcategory: phSubcategory || '',
                                    unitCost: Math.round(tierData.cost * 100) / 100,
                                    laborHrsPerUnit: Math.round(tierData.labor * 100) / 100,
                                    uom: 'EA',
                                    isPlaceholder: true,
                                };
                                onInsert([item], qty);
                                setAddedFeedback(`Added ${tierLabel} placeholder: ${fmtCost(tierData.cost)}`);
                                setTimeout(() => setAddedFeedback(''), 2000);
                            }}
                            disabled={!phCategory || !phStats}>
                            <Icons.Plus /> Add Placeholder
                        </button>
                    )}
                    {tab === 'custom' && (
                        <button
                            style={{ ...styles.button('success'), opacity: (!customItem.manufacturer && !customItem.model && !customItem.description) ? 0.5 : 1 }}
                            onClick={() => {
                                if (!customItem.manufacturer && !customItem.model && !customItem.description) return;
                                const item = {
                                    id: 'custom-' + Date.now(),
                                    manufacturer: customItem.manufacturer || 'Custom',
                                    model: customItem.model || '',
                                    partNumber: customItem.partNumber || '',
                                    description: customItem.description || '',
                                    category: customItem.category || 'Custom',
                                    subcategory: customItem.subcategory || '',
                                    unitCost: parseFloat(customItem.unitCost) || 0,
                                    laborHrsPerUnit: parseFloat(customItem.laborHrsPerUnit) || 0,
                                    uom: customItem.uom || 'EA',
                                    isCustom: true,
                                };
                                onInsert([item], qty);
                                setAddedFeedback('Added custom item');
                                setCustomItem({ manufacturer: '', model: '', partNumber: '', description: '', category: '', subcategory: '', unitCost: '', laborHrsPerUnit: '', uom: 'EA' });
                                setTimeout(() => setAddedFeedback(''), 2000);
                            }}
                            disabled={!customItem.manufacturer && !customItem.model && !customItem.description}>
                            <Icons.Plus /> Add Custom Item
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
}

function AddLocationModal({ parent, isTopLevel, onClose, onAdd }) {
    const [input, setInput] = useState('');
    const parsed = parseLocationInput(input);
    const handleSubmit = () => { if (parsed.length > 0) { onAdd(parsed, parent?.id || null); onClose(); } };
    const title = isTopLevel ? 'Add Locations' : `Add Sublocations to "${parent?.name}"`;
    const placeholder = isTopLevel ? 'Level 1\nLevel 2\nLevel 3\n\nOr use ranges: Building 1-5' : 'Area A\nArea B\nConference Room 101-110';
    
    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
        // Shift+Enter allows normal newline behavior
    };
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '550px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>{isTopLevel ? <Icons.Location /> : <Icons.Sublocation />} {title}</h2>
                <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '4px' }}>Enter one name per line. Use ranges like "Room 101-110" to create multiple.</p>
                <p style={{ color: '#6e767d', fontSize: '12px', marginBottom: '20px' }}>Press <kbd style={{ backgroundColor: '#2f3336', padding: '2px 6px', borderRadius: '4px', fontSize: '11px' }}>Enter</kbd> to add, <kbd style={{ backgroundColor: '#2f3336', padding: '2px 6px', borderRadius: '4px', fontSize: '11px' }}>Shift+Enter</kbd> for new line</p>
                <div>
                    <textarea 
                        value={input} 
                        onChange={e => setInput(e.target.value)} 
                        onKeyDown={handleKeyDown}
                        style={styles.textarea} 
                        placeholder={placeholder} 
                        autoFocus 
                    />
                    {parsed.length > 0 && (
                        <div style={styles.preview}>
                            <div style={{ fontSize: '12px', color: '#8b98a5', marginBottom: '8px', fontWeight: '600' }}>Preview ({parsed.length} items):</div>
                            {parsed.slice(0, 20).map((name, i) => (<div key={i} style={styles.previewItem}>{isTopLevel ? <Icons.Location /> : <Icons.Sublocation />}{name}</div>))}
                            {parsed.length > 20 && <div style={{ ...styles.previewItem, color: '#6e767d', fontStyle: 'italic' }}>...and {parsed.length - 20} more</div>}
                        </div>
                    )}
                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }}>
                        <button type="button" style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                        <button type="button" style={{ ...styles.button('primary'), opacity: parsed.length === 0 ? 0.5 : 1 }} disabled={parsed.length === 0} onClick={handleSubmit}>Add {parsed.length > 0 ? `${parsed.length}` : ''}</button>
                    </div>
                </div>
            </div>
        </div>
    );
}

function DuplicateModal({ location, onClose, onDuplicate }) {
    const [input, setInput] = useState('');
    const [includeItems, setIncludeItems] = useState(true);
    const parsed = parseLocationInput(input);
    const handleSubmit = () => { if (parsed.length > 0) { onDuplicate(location, parsed, includeItems); onClose(); } };
    const subCount = location.children?.length || 0;
    const itemCount = countAllItems(location);
    
    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
    };
    
    // Count all items in location and children
    function countAllItems(loc) {
        let count = loc.items?.length || 0;
        if (loc.children) {
            loc.children.forEach(child => count += countAllItems(child));
        }
        return count;
    }
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '550px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}><Icons.Duplicate /> Duplicate Location</h2>
                <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>Create copies of <strong style={{ color: '#e7e9ea' }}>"{location.name}"</strong>{subCount > 0 ? ` with its ${subCount} sublocation${subCount !== 1 ? 's' : ''}` : ''}{itemCount > 0 ? ` and ${itemCount} component${itemCount !== 1 ? 's' : ''}` : ''}.</p>
                
                {itemCount > 0 && (
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '16px', padding: '12px', backgroundColor: '#161b22', borderRadius: '8px', border: '1px solid #2f3336' }}>
                        <input 
                            type="checkbox" 
                            id="includeItems" 
                            checked={includeItems} 
                            onChange={e => setIncludeItems(e.target.checked)}
                            style={{ width: '18px', height: '18px' }}
                        />
                        <label htmlFor="includeItems" style={{ fontSize: '14px', color: '#e7e9ea', cursor: 'pointer', flex: 1 }}>
                            Include components ({itemCount} item{itemCount !== 1 ? 's' : ''})
                        </label>
                    </div>
                )}
                
                <p style={{ color: '#6e767d', fontSize: '12px', marginBottom: '16px' }}>Press <kbd style={{ backgroundColor: '#2f3336', padding: '2px 6px', borderRadius: '4px', fontSize: '11px' }}>Enter</kbd> to duplicate, <kbd style={{ backgroundColor: '#2f3336', padding: '2px 6px', borderRadius: '4px', fontSize: '11px' }}>Shift+Enter</kbd> for new line</p>
                <div>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#8b98a5' }}>New names:</label>
                    <textarea 
                        value={input} 
                        onChange={e => setInput(e.target.value)} 
                        onKeyDown={handleKeyDown}
                        style={{ ...styles.textarea, minHeight: '100px' }} 
                        placeholder="Level 2&#10;Level 3&#10;&#10;Or: Level 2-10" 
                        autoFocus 
                    />
                    {parsed.length > 0 && (
                        <div style={styles.preview}>
                            <div style={{ fontSize: '12px', color: '#8b98a5', marginBottom: '8px', fontWeight: '600' }}>Will create {parsed.length} copies:</div>
                            {parsed.slice(0, 10).map((name, i) => (<div key={i} style={styles.previewItem}><Icons.Location /> {name} {subCount > 0 && <span style={{ color: '#6e767d' }}>({subCount} sublocations)</span>}{includeItems && itemCount > 0 && <span style={{ color: '#00ba7c' }}> + {itemCount} items</span>}</div>))}
                            {parsed.length > 10 && <div style={{ ...styles.previewItem, color: '#6e767d', fontStyle: 'italic' }}>...and {parsed.length - 10} more</div>}
                        </div>
                    )}
                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }}>
                        <button type="button" style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                        <button type="button" style={{ ...styles.button('warning'), opacity: parsed.length === 0 ? 0.5 : 1 }} disabled={parsed.length === 0} onClick={handleSubmit}><Icons.Duplicate /> Duplicate {parsed.length > 0 ? `(${parsed.length})` : ''}</button>
                    </div>
                </div>
            </div>
        </div>
    );
}

function DeleteConfirmModal({ locations, onClose, onDelete, catalogPkgs, projectPkgs }) {
    // Support both single location and array of locations
    const locArray = Array.isArray(locations) ? locations : [locations];
    const totalStats = locArray.reduce((acc, loc) => {
        const t = calculateTotals(loc, catalogPkgs, projectPkgs);
        return { 
            cost: acc.cost + t.cost, 
            labor: acc.labor + t.labor, 
            itemCount: acc.itemCount + t.itemCount,
            subCount: acc.subCount + (loc.children?.length || 0)
        };
    }, { cost: 0, labor: 0, itemCount: 0, subCount: 0 });
    
    const handleDelete = () => {
        locArray.forEach(loc => onDelete(loc.id));
        onClose();
    };
    
    // Handle Enter key to confirm
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleDelete();
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [locArray]);
    
    const isSingle = locArray.length === 1;
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '450px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700', color: '#f87171', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.Trash /> Delete {isSingle ? 'Location' : `${locArray.length} Locations`}
                </h2>
                {isSingle ? (
                    <p style={{ color: '#e7e9ea', fontSize: '15px', marginBottom: '16px' }}>Are you sure you want to delete <strong>"{locArray[0].name}"</strong>?</p>
                ) : (
                    <div style={{ marginBottom: '16px' }}>
                        <p style={{ color: '#e7e9ea', fontSize: '15px', marginBottom: '8px' }}>Are you sure you want to delete these locations?</p>
                        <div style={{ maxHeight: '120px', overflowY: 'auto', backgroundColor: '#0f1419', borderRadius: '8px', padding: '8px' }}>
                            {locArray.map(loc => (
                                <div key={loc.id} style={{ padding: '4px 8px', fontSize: '13px', color: '#8b98a5' }}> {loc.name}</div>
                            ))}
                        </div>
                    </div>
                )}
                {(totalStats.subCount > 0 || totalStats.itemCount > 0) && (
                    <div style={{ backgroundColor: '#2d1a1a', padding: '16px', borderRadius: '12px', marginBottom: '20px', border: '1px solid #5c2626' }}>
                        <div style={{ color: '#f87171', fontWeight: '600', marginBottom: '8px' }}> This will also delete:</div>
                        <ul style={{ color: '#fca5a5', fontSize: '14px', marginLeft: '20px' }}>
                            {totalStats.subCount > 0 && <li>{totalStats.subCount} sublocation{totalStats.subCount > 1 ? 's' : ''}</li>}
                            {totalStats.itemCount > 0 && <li>{totalStats.itemCount} component{totalStats.itemCount > 1 ? 's' : ''} ({fmtCost(totalStats.cost)})</li>}
                        </ul>
                    </div>
                )}
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', color: '#6e767d', marginRight: 'auto' }}>Press Enter to confirm</span>
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button style={styles.button('danger')} onClick={handleDelete} autoFocus><Icons.Trash /> Delete{!isSingle ? ` (${locArray.length})` : ''}</button>
                </div>
            </div>
        </div>
    );
}

// Modal to prompt for including default accessories when adding a component
function AccessoryPromptModal({ component, accessories, qty, catalog, onConfirm, onClose }) {
    const [selectedAccessories, setSelectedAccessories] = useState(
        accessories.map(acc => ({ ...acc, included: true, qty: acc.qtyPer * qty }))
    );
    
    const toggleAccessory = (idx) => {
        setSelectedAccessories(prev => prev.map((acc, i) => 
            i === idx ? { ...acc, included: !acc.included } : acc
        ));
    };
    
    const updateAccessoryQty = (idx, newQty) => {
        setSelectedAccessories(prev => prev.map((acc, i) => 
            i === idx ? { ...acc, qty: Math.max(0, parseInt(newQty) || 0) } : acc
        ));
    };
    
    const handleConfirm = () => {
        const includedAccessories = selectedAccessories
            .filter(acc => acc.included && acc.qty > 0)
            .map(acc => {
                const catalogItem = catalog.find(c => c.id === acc.catalogId);
                return catalogItem ? { ...catalogItem, qty: acc.qty, qtyPer: acc.qtyPer } : null;
            })
            .filter(Boolean);
        onConfirm(includedAccessories);
    };
    
    // Enter to confirm
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') { e.preventDefault(); handleConfirm(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [selectedAccessories]);
    
    const totalAccessoryCost = selectedAccessories
        .filter(acc => acc.included)
        .reduce((sum, acc) => {
            const item = catalog.find(c => c.id === acc.catalogId);
            return sum + (item ? acc.qty * item.unitCost : 0);
        }, 0);
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '500px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.Package /> Include Accessories?
                </h2>
                <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>
                    <strong style={{ color: '#e7e9ea' }}>{component.manufacturer} {component.model}</strong> has default accessories. Select which to include:
                </p>
                
                <div style={{ backgroundColor: '#0f1419', borderRadius: '8px', padding: '12px', marginBottom: '16px' }}>
                    {selectedAccessories.map((acc, idx) => {
                        const catalogItem = catalog.find(c => c.id === acc.catalogId);
                        if (!catalogItem) return null;
                        return (
                            <div key={idx} style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '12px', 
                                padding: '8px',
                                backgroundColor: acc.included ? '#1a2e1a' : 'transparent',
                                borderRadius: '6px',
                                marginBottom: idx < selectedAccessories.length - 1 ? '8px' : 0
                            }}>
                                <input 
                                    type="checkbox" 
                                    checked={acc.included} 
                                    onChange={() => toggleAccessory(idx)} 
                                />
                                <div style={{ flex: 1 }}>
                                    <div style={{ fontWeight: '500', color: acc.included ? '#e7e9ea' : '#6e767d' }}>
                                        {catalogItem.manufacturer} {catalogItem.model}
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#6e767d' }}>{catalogItem.description}</div>
                                </div>
                                <input 
                                    type="number" 
                                    value={acc.qty} 
                                    onChange={e => updateAccessoryQty(idx, e.target.value)} 
                                    style={{ ...styles.inputSmall, width: '60px' }} 
                                    min="0"
                                    disabled={!acc.included}
                                />
                                <div style={{ width: '80px', textAlign: 'right', color: acc.included ? '#00ba7c' : '#6e767d' }}>
                                    {fmtCost(acc.qty * catalogItem.unitCost)}
                                </div>
                            </div>
                        );
                    })}
                </div>
                
                {totalAccessoryCost > 0 && (
                    <div style={{ fontSize: '13px', color: '#8b98a5', marginBottom: '16px' }}>
                        Accessories total: <span style={{ color: '#00ba7c', fontWeight: '600' }}>{fmtCost(totalAccessoryCost)}</span>
                    </div>
                )}
                
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', color: '#6e767d', marginRight: 'auto' }}>Press Enter to confirm</span>
                    <button style={styles.button('secondary')} onClick={() => onConfirm([])}>Skip All</button>
                    <button style={styles.button('primary')} onClick={handleConfirm}><Icons.Plus /> Add with Selected</button>
                </div>
            </div>
        </div>
    );
}

// Modal to select parent item when converting an item to an accessory
function ConvertToAccessoryModal({ items, itemIdx, onConfirm, onClose }) {
    const [selectedParent, setSelectedParent] = useState(null);
    const itemToConvert = items[itemIdx];
    
    const handleConfirm = () => {
        if (selectedParent !== null) {
            onConfirm(itemIdx, selectedParent);
        }
    };
    
    // Enter to confirm
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && selectedParent !== null) { e.preventDefault(); handleConfirm(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [selectedParent]);
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '450px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.ChevronDown /> Convert to Accessory
                </h2>
                <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>
                    Select the parent item for <strong style={{ color: '#e7e9ea' }}>{itemToConvert.manufacturer} {itemToConvert.model}</strong>:
                </p>
                
                <div style={{ backgroundColor: '#0f1419', borderRadius: '8px', padding: '8px', marginBottom: '16px', maxHeight: '300px', overflowY: 'auto' }}>
                    {items.map((item, idx) => {
                        if (idx === itemIdx) return null; // Can't be parent of itself
                        return (
                            <div 
                                key={idx}
                                style={{ 
                                    padding: '10px 12px',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    backgroundColor: selectedParent === idx ? '#1d3a5c' : 'transparent',
                                    border: selectedParent === idx ? '1px solid #1d9bf0' : '1px solid transparent',
                                    marginBottom: '4px'
                                }}
                                onClick={() => setSelectedParent(idx)}>
                                <div style={{ fontWeight: '500' }}>{item.manufacturer} <span style={{ color: '#1d9bf0' }}>{item.model}</span></div>
                                <div style={{ fontSize: '12px', color: '#6e767d' }}>{item.description}</div>
                            </div>
                        );
                    })}
                </div>
                
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button 
                        style={{ ...styles.button('primary'), opacity: selectedParent === null ? 0.5 : 1 }} 
                        onClick={handleConfirm}
                        disabled={selectedParent === null}>
                        Convert
                    </button>
                </div>
            </div>
        </div>
    );
}

// Modal to search and add an accessory to an existing item
function AddAccessoryModal({ item, catalog, onConfirm, onClose }) {
    const [search, setSearch] = useState('');
    const [selected, setSelected] = useState(null);
    const [qty, setQty] = useState(1);
    
    const results = search.length >= 1 ? catalog.filter(c => 
        (c.manufacturer?.toLowerCase().includes(search.toLowerCase())) ||
        (c.model?.toLowerCase().includes(search.toLowerCase())) ||
        (c.partNumber?.toLowerCase().includes(search.toLowerCase())) ||
        (c.description?.toLowerCase().includes(search.toLowerCase()))
    ).slice(0, 20) : [];
    
    const handleConfirm = () => {
        if (selected) {
            onConfirm({ ...selected, qty, qtyPer: qty });
        }
    };
    
    // Enter to confirm
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && selected) { e.preventDefault(); handleConfirm(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [selected, qty]);
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '550px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.Plus /> Add Accessory
                </h2>
                <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>
                    Add accessory to <strong style={{ color: '#e7e9ea' }}>{item.manufacturer} {item.model}</strong>
                </p>
                
                <input 
                    type="text" 
                    placeholder="Search components..." 
                    value={search} 
                    onChange={e => setSearch(e.target.value)} 
                    style={styles.input} 
                    autoFocus 
                />
                
                <div style={{ ...styles.searchResults, maxHeight: '250px', marginTop: '12px' }}>
                    {results.length > 0 ? results.map(c => (
                        <div 
                            key={c.id}
                            style={{ 
                                ...styles.searchItem(selected?.id === c.id),
                                padding: '10px 12px'
                            }}
                            onClick={() => setSelected(c)}
                            onMouseEnter={e => { if (selected?.id !== c.id) e.currentTarget.style.backgroundColor = '#1a1f26'; }}
                            onMouseLeave={e => { if (selected?.id !== c.id) e.currentTarget.style.backgroundColor = 'transparent'; }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <div>
                                    <div style={{ fontWeight: '500' }}>{c.manufacturer} <span style={{ color: '#1d9bf0' }}>{c.model}</span></div>
                                    <div style={{ fontSize: '12px', color: '#6e767d' }}>{c.description}</div>
                                </div>
                                <div style={{ color: '#00ba7c', fontWeight: '600' }}>{fmtCost(c.unitCost)}</div>
                            </div>
                        </div>
                    )) : search.length >= 1 ? (
                        <div style={{ padding: '20px', textAlign: 'center', color: '#6e767d' }}>No results</div>
                    ) : (
                        <div style={{ padding: '20px', textAlign: 'center', color: '#6e767d' }}>Type to search</div>
                    )}
                </div>
                
                <div style={{ display: 'flex', gap: '12px', alignItems: 'center', marginTop: '16px' }}>
                    <label style={{ fontSize: '14px', color: '#8b98a5' }}>Qty:</label>
                    <input 
                        type="number" 
                        value={qty} 
                        onChange={e => setQty(Math.max(1, parseInt(e.target.value) || 1))} 
                        style={{ ...styles.inputSmall, width: '70px' }} 
                        min="1" 
                    />
                    <div style={{ flex: 1 }} />
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button 
                        style={{ ...styles.button('primary'), opacity: !selected ? 0.5 : 1 }} 
                        onClick={handleConfirm}
                        disabled={!selected}>
                        <Icons.Plus /> Add Accessory
                    </button>
                </div>
            </div>
        </div>
    );
}

// Column definitions for the workspace table
const DEFAULT_COLUMNS = [
    { id: 'checkbox', label: '', width: 40, fixed: true },
    { id: 'expand', label: '', width: 30, fixed: true },
    { id: 'qty', label: 'Qty', width: 75 },
    { id: 'notes', label: 'Notes', width: 120 },
    { id: 'system', label: 'System', width: 100 },
    { id: 'manufacturer', label: 'Manufacturer', width: 120 },
    { id: 'model', label: 'Model', width: 140 },
    { id: 'description', label: 'Description', width: 200 },
    { id: 'unitCost', label: 'Unit Cost', width: 80 },
    { id: 'unitLabor', label: 'Unit Labor', width: 80 },
    { id: 'extCost', label: 'Ext. Cost', width: 90 },
    { id: 'extLabor', label: 'Ext. Labor', width: 80 },
];

// Hook for resizable and reorderable columns
function useFlexibleColumns(initialColumns) {
    const [columns, setColumns] = useState(initialColumns);
    const resizing = React.useRef(null);
    const dragging = React.useRef(null);
    const [dragOverIndex, setDragOverIndex] = useState(null);
    
    const startResize = (colIndex, e) => {
        e.preventDefault();
        e.stopPropagation();
        resizing.current = { colIndex, startX: e.clientX, startWidth: columns[colIndex].width };
        
        const onMouseMove = (e) => {
            if (resizing.current) {
                const diff = e.clientX - resizing.current.startX;
                const newWidth = Math.min(800, Math.max(40, resizing.current.startWidth + diff));
                setColumns(prev => {
                    const next = [...prev];
                    next[resizing.current.colIndex] = { ...next[resizing.current.colIndex], width: newWidth };
                    return next;
                });
            }
        };
        
        const onMouseUp = () => {
            resizing.current = null;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    };
    
    const startDrag = (colIndex, e) => {
        if (columns[colIndex].fixed) return;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', colIndex.toString());
        dragging.current = colIndex;
    };
    
    const onDragOver = (colIndex, e) => {
        e.preventDefault();
        if (columns[colIndex].fixed) return;
        if (dragging.current !== null && dragging.current !== colIndex) {
            setDragOverIndex(colIndex);
        }
    };
    
    const onDragLeave = () => {
        setDragOverIndex(null);
    };
    
    const onDrop = (targetIndex, e) => {
        e.preventDefault();
        if (columns[targetIndex].fixed) return;
        const sourceIndex = dragging.current;
        if (sourceIndex !== null && sourceIndex !== targetIndex) {
            setColumns(prev => {
                const next = [...prev];
                const [removed] = next.splice(sourceIndex, 1);
                next.splice(targetIndex, 0, removed);
                return next;
            });
        }
        dragging.current = null;
        setDragOverIndex(null);
    };
    
    const onDragEnd = () => {
        dragging.current = null;
        setDragOverIndex(null);
    };
    
    return { columns, startResize, startDrag, onDragOver, onDragLeave, onDrop, onDragEnd, dragOverIndex };
}

function LocationView({ location, depth, locationPath, onUpdate, onSearch, clipboard, onCopy, onPaste, onSavePackage, onSaveTemplate, onApplyTemplate, templates, catalog, onAddAccessoryToItem, onConvertToAccessory, onUngroupPackage, onMoveToPackage, compactMode, onAddToCatalog, catalogPkgs, projectPkgs }) {
    const [selectedItems, setSelectedItems] = useState([]);
    const [expandedItems, setExpandedItems] = useState({}); // Track which items are expanded (by index)
    const [expandedPackages, setExpandedPackages] = useState({}); // Track which packages are expanded
    const [allExpanded, setAllExpanded] = useState(true);
    const [contextMenu, setContextMenu] = useState(null); // { x, y, itemIdx, isAccessory, accIdx, isPackage, packageName }
    
    // Compact mode styles
    const compactStyles = {
        td: compactMode ? { padding: '4px 8px', fontSize: '11px' } : {},
        th: compactMode ? { padding: '6px 8px', fontSize: '10px' } : {},
        input: compactMode ? { padding: '2px 6px', fontSize: '11px' } : {},
    };
    
    // Flexible columns with resize and reorder
    const { columns, startResize, startDrag, onDragOver, onDragLeave, onDrop, onDragEnd, dragOverIndex } = useFlexibleColumns(DEFAULT_COLUMNS);
    
    // Calculate totals including accessories
    const calculateItemTotal = (item) => {
        let cost = (item.qty || 0) * (item.unitCost || 0);
        let labor = (item.qty || 0) * (item.laborHrsPerUnit || 0);
        if (item.accessories) {
            item.accessories.forEach(acc => {
                cost += (acc.qty || 0) * (acc.unitCost || 0);
                labor += (acc.qty || 0) * (acc.laborHrsPerUnit || 0);
            });
        }
        return { cost, labor };
    };
    
    // Render a cell based on column ID for main items
    const renderItemCell = (col, item, itemIdx, { isSelected, hasAccessories, isExpanded, itemTotal, isPackageItem, pkgColor, changeQty, changeNotes, changeSystem, toggleSelect, toggleItemExpand }) => {
        const tdStyle = { ...styles.td, ...compactStyles.td };
        const inputStyle = { ...styles.inputSmall, ...compactStyles.input };
        switch (col.id) {
            case 'checkbox':
                return <td key={col.id} style={{ ...tdStyle, paddingLeft: isPackageItem ? '24px' : undefined }}><input type="checkbox" checked={isSelected} onChange={e => toggleSelect(itemIdx, e)} /></td>;
            case 'expand':
                return <td key={col.id} style={{ ...tdStyle, padding: compactMode ? '2px 4px' : '8px 4px' }}>{hasAccessories && (
                    <button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => toggleItemExpand(itemIdx)}>
                        {isExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                    </button>
                )}</td>;
            case 'qty':
                return <td key={col.id} style={tdStyle}><input type="number" value={item.qty} onChange={e => changeQty(itemIdx, e.target.value)} onFocus={e => e.target.select()} style={{ ...inputStyle, width: compactMode ? '50px' : '60px' }} min="0" /></td>;
            case 'notes':
                return <td key={col.id} style={tdStyle}><input type="text" value={item.notes || ''} onChange={e => changeNotes(itemIdx, e.target.value)} placeholder="..." style={{ ...inputStyle, width: '100%', fontSize: compactMode ? '10px' : '11px' }} /></td>;
            case 'system':
                return <td key={col.id} style={tdStyle}><select value={item.system || ''} onChange={e => changeSystem(itemIdx, e.target.value)} style={{ ...inputStyle, width: '100%', cursor: 'pointer', fontSize: compactMode ? '10px' : '11px' }}><option value=""></option>{SYSTEM_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}</select></td>;
            case 'manufacturer':
                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '11px' : '12px', color: isPackageItem ? '#8b98a5' : undefined }}>{isPackageItem && <span style={{ color: '#6e767d' }}> </span>}{item.manufacturer}</td>;
            case 'model':
                return <td key={col.id} style={tdStyle}><strong>{item.model}</strong></td>;
            case 'description':
                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '11px' : '12px' }}>{item.description}{hasAccessories && <span style={{ ...styles.badge('orange'), marginLeft: '6px', fontSize: '9px' }}>{item.accessories.length}</span>}</td>;
            case 'unitCost':
                return <td key={col.id} style={tdStyle}><input type="number" step="0.01" min="0" value={editingCost[itemIdx] !== undefined ? editingCost[itemIdx] : (item.unitCost || 0)} onChange={e => changeUnitCost(itemIdx, e.target.value)} onBlur={() => blurUnitCost(itemIdx)} onFocus={e => { focusUnitCost(itemIdx, item.unitCost); e.target.select(); }} style={{ ...inputStyle, width: compactMode ? '70px' : '80px', textAlign: 'right' }} /></td>;
            case 'unitLabor':
                return <td key={col.id} style={tdStyle}><input type="number" step="0.25" min="0" value={editingLabor[itemIdx] !== undefined ? editingLabor[itemIdx] : (item.laborHrsPerUnit || 0)} onChange={e => changeUnitLabor(itemIdx, e.target.value)} onBlur={() => blurUnitLabor(itemIdx)} onFocus={e => { focusUnitLabor(itemIdx, item.laborHrsPerUnit); e.target.select(); }} style={{ ...inputStyle, width: compactMode ? '55px' : '65px', textAlign: 'right' }} /></td>;
            case 'extCost':
                return <td key={col.id} style={{ ...tdStyle, color: '#00ba7c', fontWeight: '600', fontSize: compactMode ? '11px' : '12px' }}>{fmtCost(itemTotal.cost)}</td>;
            case 'extLabor':
                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '11px' : '12px' }}>{fmtHrs(itemTotal.labor)}</td>;
            default:
                return <td key={col.id} style={tdStyle}></td>;
        }
    };
    
    // Render a cell for accessories
    const renderAccessoryCell = (col, acc, itemIdx, accIdx, { pkgColor, changeAccessoryQty, changeAccessoryNotes, removeAccessory }) => {
        const tdStyle = { ...styles.td, ...compactStyles.td, fontSize: compactMode ? '10px' : '11px', color: '#6e767d' };
        const inputStyle = { ...styles.inputSmall, ...compactStyles.input };
        switch (col.id) {
            case 'checkbox':
                return <td key={col.id} style={tdStyle}></td>;
            case 'expand':
                return <td key={col.id} style={tdStyle}></td>;
            case 'qty':
                return <td key={col.id} style={{ ...tdStyle, paddingLeft: pkgColor ? '40px' : '24px' }}><input type="number" value={acc.qty} onChange={e => changeAccessoryQty(itemIdx, accIdx, e.target.value)} onFocus={e => e.target.select()} style={{ ...inputStyle, width: compactMode ? '50px' : '60px' }} min="0" /></td>;
            case 'notes':
                return <td key={col.id} style={tdStyle}><input type="text" value={acc.notes || ''} onChange={e => changeAccessoryNotes(itemIdx, accIdx, e.target.value)} placeholder="..." style={{ ...inputStyle, width: '100%', fontSize: compactMode ? '9px' : '10px' }} /></td>;
            case 'system':
                return <td key={col.id} style={tdStyle}></td>;
            case 'manufacturer':
                return <td key={col.id} style={tdStyle}><span style={{ color: '#4a5568' }}> </span>{acc.manufacturer}</td>;
            case 'model':
                return <td key={col.id} style={{ ...tdStyle, color: '#8b98a5' }}>{acc.model}</td>;
            case 'description':
                return <td key={col.id} style={tdStyle}>{acc.description}</td>;
            case 'unitCost': {
                const accKey = `${itemIdx}-${accIdx}`;
                return <td key={col.id} style={tdStyle}><input type="number" step="0.01" min="0" value={editingAccCost[accKey] !== undefined ? editingAccCost[accKey] : (acc.unitCost || 0)} onChange={e => changeAccessoryUnitCost(itemIdx, accIdx, e.target.value)} onBlur={() => blurAccessoryUnitCost(itemIdx, accIdx)} onFocus={e => { focusAccCost(itemIdx, accIdx, acc.unitCost); e.target.select(); }} style={{ ...inputStyle, width: compactMode ? '70px' : '80px', textAlign: 'right', fontSize: compactMode ? '10px' : '11px' }} /></td>;
            }
            case 'unitLabor': {
                const accKey = `${itemIdx}-${accIdx}`;
                return <td key={col.id} style={tdStyle}><input type="number" step="0.25" min="0" value={editingAccLabor[accKey] !== undefined ? editingAccLabor[accKey] : (acc.laborHrsPerUnit || 0)} onChange={e => changeAccessoryUnitLabor(itemIdx, accIdx, e.target.value)} onBlur={() => blurAccessoryUnitLabor(itemIdx, accIdx)} onFocus={e => { focusAccLabor(itemIdx, accIdx, acc.laborHrsPerUnit); e.target.select(); }} style={{ ...inputStyle, width: compactMode ? '55px' : '65px', textAlign: 'right', fontSize: compactMode ? '10px' : '11px' }} /></td>;
            }
            case 'extCost':
                return <td key={col.id} style={{ ...tdStyle, color: '#4a6e4a' }}>{fmtCost((acc.qty || 0) * (acc.unitCost || 0))}</td>;
            case 'extLabor':
                return <td key={col.id} style={tdStyle}>
                    <span>{fmtHrs((acc.qty || 0) * (acc.laborHrsPerUnit || 0))}</span>
                    <button style={{ ...styles.iconButton, marginLeft: '4px', color: '#4a5568', padding: '2px' }} onClick={() => removeAccessory(itemIdx, accIdx)}><Icons.X /></button>
                </td>;
            default:
                return <td key={col.id} style={tdStyle}></td>;
        }
    };
    
    // Render package header cells
    const renderPackageHeaderCell = (col, colIndex, pkg, { pkgColor, allPkgItemsSelected, somePkgItemsSelected, togglePkgSelect, isPkgExpanded, togglePackageExpand }) => {
        const tdStyle = { ...styles.td };
        // For the first few data columns, we span them for the package name
        const dataColStart = columns.findIndex(c => c.id === 'qty');
        const dataColEnd = columns.findIndex(c => c.id === 'unitCost');
        
        if (col.id === 'checkbox') {
            return <td key={col.id} style={tdStyle}><input type="checkbox" checked={allPkgItemsSelected} ref={el => { if (el) el.indeterminate = somePkgItemsSelected && !allPkgItemsSelected; }} onChange={togglePkgSelect} /></td>;
        }
        if (col.id === 'expand') {
            return <td key={col.id} style={{ ...tdStyle, padding: '8px 4px' }}><button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => togglePackageExpand(pkg.name)}>{isPkgExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</button></td>;
        }
        if (colIndex === dataColStart) {
            const spanCount = dataColEnd - dataColStart;
            return <td key={col.id} colSpan={spanCount} style={{ ...tdStyle, fontWeight: '700' }}><Icons.Package /> <span style={{ color: pkgColor.b }}>{pkg.name}</span><span style={{ ...styles.badge('green'), marginLeft: '8px', fontSize: '10px' }}>{pkg.itemCount} items</span></td>;
        }
        if (colIndex > dataColStart && colIndex < dataColEnd) {
            return null; // Spanned
        }
        if (col.id === 'unitCost' || col.id === 'unitLabor') {
            return <td key={col.id} style={tdStyle}></td>;
        }
        if (col.id === 'extCost') {
            return <td key={col.id} style={{ ...tdStyle, color: '#00ba7c', fontWeight: '700' }}>{fmtCost(pkg.cost)}</td>;
        }
        if (col.id === 'extLabor') {
            return <td key={col.id} style={{ ...tdStyle, fontWeight: '600' }}>{fmtHrs(pkg.labor)}</td>;
        }
        return <td key={col.id} style={tdStyle}></td>;
    };
    
    // Group items by package
    const groupedItems = useMemo(() => {
        const items = location.items || [];
        const packageInstances = [];
        const legacyPackages = {};
        const standalone = [];

        items.forEach((item, idx) => {
            if (item.type === 'package') {
                const resolved = resolvePackageInstance(item, catalogPkgs, projectPkgs);
                packageInstances.push({
                    instance: item,
                    idx,
                    resolved,
                    name: item.packageName,
                    qty: item.qty || 1,
                    isOutOfDate: resolved?.isOutOfDate || false,
                    isMissing: resolved?.isMissing || false,
                    cost: resolved?.totalCost || 0,
                    labor: resolved?.totalLabor || 0,
                    itemCount: resolved?.expandedItems?.length || 0,
                    expandedItems: resolved?.expandedItems || [],
                });
            } else if (item.packageName) {
                // Legacy format  backward compat
                if (!legacyPackages[item.packageName]) {
                    legacyPackages[item.packageName] = { name: item.packageName, items: [], indices: [] };
                }
                legacyPackages[item.packageName].items.push(item);
                legacyPackages[item.packageName].indices.push(idx);
            } else {
                standalone.push({ item, idx });
            }
        });

        // Calculate legacy package totals
        Object.values(legacyPackages).forEach(pkg => {
            pkg.cost = pkg.items.reduce((s, item) => s + calculateItemTotal(item).cost, 0);
            pkg.labor = pkg.items.reduce((s, item) => s + calculateItemTotal(item).labor, 0);
            pkg.itemCount = pkg.items.reduce((count, item) => count + 1 + (item.accessories?.length || 0), 0);
        });

        return { packages: packageInstances, legacyPackages: Object.values(legacyPackages), standalone };
    }, [location.items, catalogPkgs, projectPkgs]);
    
    const totals = calculateTotals(location, catalogPkgs, projectPkgs);
    // Count line items including accessories and package contents
    const directItems = (location.items || []).reduce((count, item) => {
        if (item.type === 'package') {
            const resolved = resolvePackageInstance(item, catalogPkgs, projectPkgs);
            return count + (resolved?.expandedItems?.length || 0);
        }
        return count + 1 + (item.accessories?.length || 0);
    }, 0);

    // Calculate direct totals including accessories
    const directCost = totals.cost - ((location.children || []).reduce((s, c) => s + calculateTotals(c, catalogPkgs, projectPkgs).cost, 0));
    const directLabor = totals.labor - ((location.children || []).reduce((s, c) => s + calculateTotals(c, catalogPkgs, projectPkgs).labor, 0));
    const subCount = (location.children || []).length;
    
    // Check if any items have accessories or packages
    const hasAnyAccessories = (location.items || []).some(item => item.accessories?.length > 0);
    const hasAnyPackages = groupedItems.packages.length > 0 || groupedItems.legacyPackages.length > 0;
    const hasExpandableContent = hasAnyAccessories || hasAnyPackages;
    
    // Close context menu on click outside
    useEffect(() => {
        const handleClick = () => setContextMenu(null);
        if (contextMenu) window.addEventListener('click', handleClick);
        return () => window.removeEventListener('click', handleClick);
    }, [contextMenu]);
    
    const handleContextMenu = (e, itemIdx, isAccessory = false, accIdx = null, isPackage = false, packageName = null) => {
        e.preventDefault();
        setContextMenu({ x: e.clientX, y: e.clientY, itemIdx, isAccessory, accIdx, isPackage, packageName });
    };
    
    const changeQty = (itemIdx, q) => { 
        const items = [...location.items]; 
        const newQty = Math.max(0, parseInt(q) || 0);
        items[itemIdx] = { ...items[itemIdx], qty: newQty };
        // Also scale accessories proportionally if they exist
        if (items[itemIdx].accessories) {
            const oldQty = location.items[itemIdx].qty || 1;
            const ratio = newQty / oldQty;
            items[itemIdx].accessories = items[itemIdx].accessories.map(acc => ({
                ...acc,
                qty: Math.round((acc.qty || 0) * ratio) || acc.qtyPer || 1
            }));
        }
        onUpdate(location.id, items); 
    };
    
    const changeNotes = (itemIdx, notes) => {
        const items = [...location.items];
        items[itemIdx] = { ...items[itemIdx], notes };
        onUpdate(location.id, items);
    };

    const changeSystem = (itemIdx, system) => {
        const items = [...location.items];
        items[itemIdx] = { ...items[itemIdx], system };
        onUpdate(location.id, items);
    };

    const [editingCost, setEditingCost] = useState({}); // { [itemIdx]: string }
    const [editingLabor, setEditingLabor] = useState({}); // { [itemIdx]: string }
    const [editingAccCost, setEditingAccCost] = useState({}); // { [`${itemIdx}-${accIdx}`]: string }
    const [editingAccLabor, setEditingAccLabor] = useState({}); // { [`${itemIdx}-${accIdx}`]: string }

    const focusUnitCost = (itemIdx, currentVal) => {
        setEditingCost(prev => ({ ...prev, [itemIdx]: String(currentVal || 0) }));
    };
    const changeUnitCost = (itemIdx, val) => {
        setEditingCost(prev => ({ ...prev, [itemIdx]: val }));
    };
    const blurUnitCost = (itemIdx) => {
        const val = parseFloat(editingCost[itemIdx]) || 0;
        setEditingCost(prev => { const n = { ...prev }; delete n[itemIdx]; return n; });
        const items = [...location.items];
        items[itemIdx] = { ...items[itemIdx], unitCost: val };
        onUpdate(location.id, items);
    };

    const focusUnitLabor = (itemIdx, currentVal) => {
        setEditingLabor(prev => ({ ...prev, [itemIdx]: String(currentVal || 0) }));
    };
    const changeUnitLabor = (itemIdx, val) => {
        setEditingLabor(prev => ({ ...prev, [itemIdx]: val }));
    };
    const blurUnitLabor = (itemIdx) => {
        const val = parseFloat(editingLabor[itemIdx]) || 0;
        setEditingLabor(prev => { const n = { ...prev }; delete n[itemIdx]; return n; });
        const items = [...location.items];
        items[itemIdx] = { ...items[itemIdx], laborHrsPerUnit: val };
        onUpdate(location.id, items);
    };

    const focusAccCost = (itemIdx, accIdx, currentVal) => {
        setEditingAccCost(prev => ({ ...prev, [`${itemIdx}-${accIdx}`]: String(currentVal || 0) }));
    };
    const changeAccessoryUnitCost = (itemIdx, accIdx, val) => {
        setEditingAccCost(prev => ({ ...prev, [`${itemIdx}-${accIdx}`]: val }));
    };
    const blurAccessoryUnitCost = (itemIdx, accIdx) => {
        const key = `${itemIdx}-${accIdx}`;
        const val = parseFloat(editingAccCost[key]) || 0;
        setEditingAccCost(prev => { const n = { ...prev }; delete n[key]; return n; });
        const items = [...location.items];
        const accessories = [...items[itemIdx].accessories];
        accessories[accIdx] = { ...accessories[accIdx], unitCost: val };
        items[itemIdx] = { ...items[itemIdx], accessories };
        onUpdate(location.id, items);
    };

    const focusAccLabor = (itemIdx, accIdx, currentVal) => {
        setEditingAccLabor(prev => ({ ...prev, [`${itemIdx}-${accIdx}`]: String(currentVal || 0) }));
    };
    const changeAccessoryUnitLabor = (itemIdx, accIdx, val) => {
        setEditingAccLabor(prev => ({ ...prev, [`${itemIdx}-${accIdx}`]: val }));
    };
    const blurAccessoryUnitLabor = (itemIdx, accIdx) => {
        const key = `${itemIdx}-${accIdx}`;
        const val = parseFloat(editingAccLabor[key]) || 0;
        setEditingAccLabor(prev => { const n = { ...prev }; delete n[key]; return n; });
        const items = [...location.items];
        const accessories = [...items[itemIdx].accessories];
        accessories[accIdx] = { ...accessories[accIdx], laborHrsPerUnit: val };
        items[itemIdx] = { ...items[itemIdx], accessories };
        onUpdate(location.id, items);
    };

    const changeAccessoryNotes = (itemIdx, accIdx, notes) => {
        const items = [...location.items];
        items[itemIdx] = { ...items[itemIdx], accessories: items[itemIdx].accessories.map((a, i) => i === accIdx ? { ...a, notes } : a) };
        onUpdate(location.id, items);
    };
    
    const changeAccessoryQty = (itemIdx, accIdx, q) => {
        const items = [...location.items];
        const accessories = [...items[itemIdx].accessories];
        accessories[accIdx] = { ...accessories[accIdx], qty: Math.max(0, parseInt(q) || 0) };
        items[itemIdx] = { ...items[itemIdx], accessories };
        onUpdate(location.id, items);
    };
    
    const removeAccessory = (itemIdx, accIdx) => {
        const items = [...location.items];
        items[itemIdx] = { 
            ...items[itemIdx], 
            accessories: items[itemIdx].accessories.filter((_, i) => i !== accIdx) 
        };
        onUpdate(location.id, items);
    };
    
    const deleteItem = (idx) => {
        onUpdate(location.id, location.items.filter((_, i) => i !== idx));
        setSelectedItems(prev => prev.filter(i => i !== idx));
    };
    
    const convertToAccessory = (itemIdx, parentIdx) => {
        if (itemIdx === parentIdx) return;
        const items = [...location.items];
        const itemToConvert = items[itemIdx];
        const parentItem = items[parentIdx];
        
        // Add as accessory to parent
        const newAccessory = {
            ...itemToConvert,
            qtyPer: itemToConvert.qty
        };
        items[parentIdx] = {
            ...parentItem,
            accessories: [...(parentItem.accessories || []), newAccessory]
        };
        
        // Remove from main list
        const newItems = items.filter((_, i) => i !== itemIdx);
        onUpdate(location.id, newItems);
    };
    
    const promoteAccessoryToItem = (itemIdx, accIdx) => {
        const items = [...location.items];
        const accessory = items[itemIdx].accessories[accIdx];
        
        // Remove from accessories
        items[itemIdx] = {
            ...items[itemIdx],
            accessories: items[itemIdx].accessories.filter((_, i) => i !== accIdx)
        };
        
        // Add as standalone item
        const newItem = { ...accessory };
        delete newItem.qtyPer;
        items.push(newItem);
        
        onUpdate(location.id, items);
    };
    
    const del = (indices) => { 
        onUpdate(location.id, location.items.filter((_, idx) => !indices.includes(idx))); 
        setSelectedItems([]); 
    };
    
    const mainItemCount = (location.items || []).length; // Just main items, not accessories
    const lastClickedIdx = useRef(null);
    const toggleSelect = (idx, e) => {
        if (e && e.shiftKey && lastClickedIdx.current !== null) {
            // Shift+Click: select range between last clicked and current
            const start = Math.min(lastClickedIdx.current, idx);
            const end = Math.max(lastClickedIdx.current, idx);
            const range = [];
            for (let i = start; i <= end; i++) range.push(i);
            setSelectedItems(prev => {
                const combined = new Set([...prev, ...range]);
                return [...combined];
            });
        } else if (e && (e.ctrlKey || e.metaKey)) {
            // Ctrl+Click: toggle individual
            setSelectedItems(prev => prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]);
        } else {
            // Normal click on checkbox: toggle individual
            setSelectedItems(prev => prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]);
        }
        lastClickedIdx.current = idx;
    };
    const selectAll = () => { setSelectedItems(selectedItems.length === mainItemCount ? [] : location.items.map((_, i) => i)); };
    const handleCopy = () => { onCopy(selectedItems.map(idx => ({ ...location.items[idx] }))); };
    const handlePaste = () => { onPaste(location.id); setSelectedItems([]); };
    const handleSavePackage = () => { 
        if (selectedItems.length > 0) {
            onSavePackage(selectedItems.map(idx => ({ ...location.items[idx] })), selectedItems); 
        }
    };
    
    const toggleItemExpand = (idx) => {
        setExpandedItems(prev => ({ ...prev, [idx]: !(prev[idx] ?? true) }));
    };
    
    const togglePackageExpand = (pkgName) => {
        setExpandedPackages(prev => ({ ...prev, [pkgName]: !(prev[pkgName] ?? true) }));
    };
    
    const expandAll = () => {
        const expandedI = {};
        const expandedP = {};
        location.items?.forEach((item, idx) => {
            expandedI[idx] = true;
        });
        groupedItems.packages.forEach(pkg => { expandedP[pkg.name] = true; });
        groupedItems.legacyPackages.forEach(pkg => { expandedP[pkg.name] = true; });
        setExpandedItems(expandedI);
        setExpandedPackages(expandedP);
        setAllExpanded(true);
    };

    const collapseAll = () => {
        const collapsedI = {};
        const collapsedP = {};
        location.items?.forEach((item, idx) => {
            collapsedI[idx] = false;
        });
        groupedItems.packages.forEach(pkg => { collapsedP[pkg.name] = false; });
        groupedItems.legacyPackages.forEach(pkg => { collapsedP[pkg.name] = false; });
        setExpandedItems(collapsedI);
        setExpandedPackages(collapsedP);
        setAllExpanded(false);
    };
    
    // Initialize expanded state
    useEffect(() => {
        if (allExpanded) expandAll();
    }, [location.items]);
    
    useEffect(() => {
        const handleKeyDown = (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedItems.length > 0) { e.preventDefault(); handleCopy(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && clipboard.length > 0) { e.preventDefault(); handlePaste(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [selectedItems, clipboard, location.items]);
    
    return (
        <div>
            <div style={{ marginBottom: '24px' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                        <div style={{ marginTop: '4px' }}>{depth === 0 ? <Icons.Location /> : <Icons.Sublocation />}</div>
                        <div>
                            {locationPath && locationPath.length > 0 && (
                                <div style={{ fontSize: '13px', color: '#6e767d', marginBottom: '4px' }}>
                                    {locationPath.join('  ')}
                                </div>
                            )}
                            <h2 style={{ margin: 0, fontSize: '28px', fontWeight: '700' }}>{location.name}</h2>
                        </div>
                    </div>
                    {directItems > 0 && <button style={{ ...styles.smallButton, backgroundColor: '#2d1a3d', color: '#a78bfa' }} onClick={onSaveTemplate}><Icons.Template /> Save as Template</button>}
                </div>
                <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                    <div style={{ backgroundColor: '#1a2e1a', padding: '16px 20px', borderRadius: '12px', border: '1px solid #2d4a2d' }}>
                        <div style={{ fontSize: '12px', color: '#6e9e6e', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Material</div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#00ba7c' }}>{fmtCost(directCost)}</div>
                        {subCount > 0 && <div style={{ fontSize: '12px', color: '#6e9e6e', marginTop: '4px' }}>+{fmtCost(totals.cost - directCost)} sublocations</div>}
                    </div>
                    <div style={{ backgroundColor: '#1a2a3e', padding: '16px 20px', borderRadius: '12px', border: '1px solid #2d4a6e' }}>
                        <div style={{ fontSize: '12px', color: '#6e8eae', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Labor</div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#1d9bf0' }}>{fmtHrs(directLabor)}</div>
                        {subCount > 0 && <div style={{ fontSize: '12px', color: '#6e8eae', marginTop: '4px' }}>+{fmtHrs(totals.labor - directLabor)} sublocations</div>}
                    </div>
                    <div style={{ backgroundColor: '#1a1f26', padding: '16px 20px', borderRadius: '12px', border: '1px solid #2f3336' }}>
                        <div style={{ fontSize: '12px', color: '#6e767d', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Line Items</div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#e7e9ea' }}>{directItems}</div>
                        {subCount > 0 && <div style={{ fontSize: '12px', color: '#6e767d', marginTop: '4px' }}>{subCount} sublocations</div>}
                    </div>
                </div>
            </div>

            {subCount > 0 && (
                <div style={{ ...styles.card, marginBottom: '24px' }}>
                    <div style={styles.cardTitle}><Icons.Layers /> Sublocations ({subCount})</div>
                    <div style={{ display: 'grid', gap: '8px', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))' }}>
                        {location.children.map(child => {
                            const t = calculateTotals(child, catalogPkgs, projectPkgs);
                            return (
                                <div key={child.id} style={{ backgroundColor: '#0f1419', padding: '12px', borderRadius: '8px', border: '1px solid #2f3336' }}>
                                    <div style={{ fontWeight: '600', marginBottom: '4px' }}>{child.name}</div>
                                    <div style={{ fontSize: '12px', color: '#6e767d', display: 'flex', gap: '12px' }}>
                                        <span style={{ color: '#00ba7c' }}>{fmtCost(t.cost)}</span>
                                        <span style={{ color: '#1d9bf0' }}>{formatHours(t.labor)}</span>
                                        <span>{t.itemCount} items</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {location.items?.length > 0 ? (
                <div style={{ ...styles.card, padding: 0, overflow: 'hidden' }}>
                    <div style={{ padding: '16px 20px', borderBottom: '1px solid #2f3336', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
                        <div style={{ ...styles.cardTitle, marginBottom: 0 }}>
                            <Icons.Package /> Components ({directItems})
                            {(groupedItems.packages.length + groupedItems.legacyPackages.length) > 0 && <span style={styles.badge('green')}>{groupedItems.packages.length + groupedItems.legacyPackages.length} packages</span>}
                            {selectedItems.length > 0 && <span style={styles.badge('blue')}>{selectedItems.length} selected</span>}
                        </div>
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            {hasExpandableContent && (
                                <>
                                    <button style={styles.smallButton} onClick={expandAll} title="Expand All"><Icons.ChevronsDown /> Expand</button>
                                    <button style={styles.smallButton} onClick={collapseAll} title="Collapse All"><Icons.ChevronsUp /> Collapse</button>
                                </>
                            )}
                            {selectedItems.length > 0 && (
                                <>
                                    <button style={styles.smallButton} onClick={handleCopy}><Icons.Copy /> Copy</button>
                                    <button style={{ ...styles.smallButton, backgroundColor: '#1a3d2e', color: '#00ba7c' }} onClick={handleSavePackage}><Icons.Package /> Save as Package</button>
                                    <button style={{ ...styles.smallButton, backgroundColor: '#5c2626', color: '#f87171' }} onClick={() => del(selectedItems)}><Icons.Trash /> Delete</button>
                                </>
                            )}
                            {clipboard.length > 0 && <button style={{ ...styles.smallButton, backgroundColor: '#1a3d2e', color: '#00ba7c' }} onClick={handlePaste}><Icons.Clipboard /> Paste ({clipboard.length})</button>}
                            {templates && templates.length > 0 && <button style={{ ...styles.smallButton, backgroundColor: '#2d1a3d', color: '#a78bfa' }} onClick={onApplyTemplate}><Icons.Template /> Apply Template</button>}
                            <button style={styles.button('primary')} onClick={onSearch}><Icons.Plus /> Add</button>
                        </div>
                    </div>
                    <div style={{ maxHeight: '50vh', overflowY: 'auto', overflowX: 'auto' }}>
                        <table style={{ ...styles.table, minWidth: columns.reduce((a, c) => a + c.width, 0) }}>
                            <colgroup>
                                {columns.map((col, i) => <col key={col.id} style={{ width: col.width }} />)}
                            </colgroup>
                            <thead>
                                <tr>
                                    {columns.map((col, colIndex) => (
                                        <th 
                                            key={col.id}
                                            style={{ 
                                                ...styles.th, 
                                                ...styles.thResizable,
                                                ...compactStyles.th,
                                                cursor: col.fixed ? 'default' : 'grab',
                                                backgroundColor: dragOverIndex === colIndex ? '#2d4a6e' : '#1a1f26'
                                            }}
                                            draggable={!col.fixed}
                                            onDragStart={e => startDrag(colIndex, e)}
                                            onDragOver={e => onDragOver(colIndex, e)}
                                            onDragLeave={onDragLeave}
                                            onDrop={e => onDrop(colIndex, e)}
                                            onDragEnd={onDragEnd}
                                        >
                                            {col.id === 'checkbox' ? (
                                                <input type="checkbox" checked={selectedItems.length === mainItemCount && mainItemCount > 0} onChange={selectAll} />
                                            ) : col.label}
                                            {!col.fixed && (
                                                <div 
                                                    style={styles.resizeHandle} 
                                                    onMouseDown={e => startResize(colIndex, e)}
                                                    onMouseEnter={e => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.backgroundColor = '#1d9bf0'; }}
                                                    onMouseLeave={e => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.backgroundColor = '#4a5568'; }}
                                                />
                                            )}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {/* Render packages first */}
                                {/* Package instances (new format) */}
                                {groupedItems.packages.map(pkg => {
                                    const pkgColor = styles.pkgColor(pkg.name);
                                    const isPkgExpanded = expandedPackages[pkg.name] !== false;
                                    const isSelected = selectedItems.includes(pkg.idx);
                                    const togglePkgSelect = (e) => toggleSelect(pkg.idx, e);

                                    // Handler to change package instance qty
                                    const changePkgQty = (val) => {
                                        const items = [...location.items];
                                        items[pkg.idx] = { ...items[pkg.idx], qty: Math.max(1, parseInt(val) || 1) };
                                        onUpdate(location.id, items);
                                    };

                                    return (
                                        <React.Fragment key={`pkg-${pkg.idx}`}>
                                            {/* Package header row */}
                                            <tr
                                                style={{ backgroundColor: pkgColor.bg, borderLeft: `4px solid ${pkgColor.b}`, cursor: 'context-menu' }}
                                                onContextMenu={e => handleContextMenu(e, pkg.idx, false, null, true, pkg.name)}>
                                                {columns.map((col, colIndex) => {
                                                    const tdS = { ...styles.td, ...compactStyles.td, width: col.width + 'px' };
                                                    if (col.id === 'checkbox') return <td key={col.id} style={tdS}><input type="checkbox" checked={isSelected} onChange={e => togglePkgSelect(e)} /></td>;
                                                    if (col.id === 'expand') return <td key={col.id} style={tdS}><button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => togglePackageExpand(pkg.name)}>{isPkgExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</button></td>;
                                                    if (col.id === 'qty') return <td key={col.id} style={tdS}><input type="number" value={pkg.qty} onChange={e => changePkgQty(e.target.value)} onFocus={e => e.target.select()} style={{ ...styles.inputSmall, ...compactStyles.input, width: '60px', fontWeight: '700' }} min="1" /></td>;
                                                    if (col.id === 'manufacturer' || col.id === 'notes') return <td key={col.id} style={{ ...tdS, fontWeight: '700' }} colSpan={col.id === 'notes' ? 1 : undefined}>
                                                        {col.id === 'notes' ? '' : <><Icons.Package /> <span style={{ color: pkgColor.b }}>{pkg.name}</span> {pkg.isOutOfDate && <span style={{ color: '#f59e0b', fontSize: '11px' }} title="Package definition has been updated"> outdated</span>} {pkg.isMissing && <span style={{ color: '#f87171', fontSize: '11px' }}> missing</span>}</>}
                                                    </td>;
                                                    if (col.id === 'model') return <td key={col.id} style={tdS}><span style={{ ...styles.badge('green'), fontSize: '10px' }}>{pkg.itemCount} items  {pkg.qty}</span></td>;
                                                    if (col.id === 'description') return <td key={col.id} style={tdS}>{pkg.instance.notes || ''}</td>;
                                                    if (col.id === 'extCost') return <td key={col.id} style={{ ...tdS, color: '#00ba7c', fontWeight: '600' }}>{fmtCost(pkg.cost)}</td>;
                                                    if (col.id === 'extLabor' || col.id === 'labor') return <td key={col.id} style={tdS}>{fmtHrs(pkg.labor)}</td>;
                                                    return <td key={col.id} style={tdS}></td>;
                                                })}
                                            </tr>

                                            {/* Expanded package items (read-only, computed from definition) */}
                                            {isPkgExpanded && pkg.expandedItems.map((item, itemIdx) => (
                                                <tr key={`pkg-item-${pkg.idx}-${itemIdx}`} style={{ backgroundColor: '#0d1117', borderLeft: `3px solid ${pkgColor.b}` }}>
                                                    {columns.map(col => {
                                                        const tdS = { ...styles.td, ...compactStyles.td, width: col.width + 'px', color: '#8b98a5', fontSize: '12px' };
                                                        if (col.id === 'checkbox') return <td key={col.id} style={tdS}></td>;
                                                        if (col.id === 'expand') return <td key={col.id} style={tdS}></td>;
                                                        if (col.id === 'qty') return <td key={col.id} style={tdS}>{fmtQty(item.qty)}</td>;
                                                        if (col.id === 'notes') return <td key={col.id} style={tdS}><span style={{ fontSize: '10px', color: '#6e767d' }}>{(item.qtyPerPackage || 1)}{pkg.qty}</span></td>;
                                                        if (col.id === 'manufacturer') return <td key={col.id} style={tdS}>{item.manufacturer}</td>;
                                                        if (col.id === 'model') return <td key={col.id} style={{ ...tdS, color: '#1d9bf0' }}>{item.model}</td>;
                                                        if (col.id === 'description') return <td key={col.id} style={tdS}>{item.description}</td>;
                                                        if (col.id === 'unitCost') return <td key={col.id} style={tdS}>{fmtCost(item.unitCost || 0)}</td>;
                                                        if (col.id === 'unitLabor') return <td key={col.id} style={tdS}>{fmtHrs(item.laborHrsPerUnit || 0)}</td>;
                                                        if (col.id === 'extCost') return <td key={col.id} style={{ ...tdS, color: '#00ba7c' }}>{fmtCost((item.qty || 0) * (item.unitCost || 0))}</td>;
                                                        if (col.id === 'extLabor' || col.id === 'labor') return <td key={col.id} style={tdS}>{fmtHrs((item.qty || 0) * (item.laborHrsPerUnit || 0))}</td>;
                                                        return <td key={col.id} style={tdS}></td>;
                                                    })}
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    );
                                })}

                                {/* Legacy packages (old format, backward compat) */}
                                {groupedItems.legacyPackages.map(pkg => {
                                    const pkgColor = styles.pkgColor(pkg.name);
                                    const isPkgExpanded = expandedPackages[pkg.name] !== false;
                                    const allPkgItemsSelected = pkg.indices.every(idx => selectedItems.includes(idx));

                                    const toggleLegacyPkgSelect = () => {
                                        if (allPkgItemsSelected) {
                                            setSelectedItems(prev => prev.filter(idx => !pkg.indices.includes(idx)));
                                        } else {
                                            setSelectedItems(prev => [...new Set([...prev, ...pkg.indices])]);
                                        }
                                    };

                                    return (
                                        <React.Fragment key={`legacy-pkg-${pkg.name}`}>
                                            <tr style={{ backgroundColor: pkgColor.bg, borderLeft: `4px solid ${pkgColor.b}` }}>
                                                {columns.map((col) => {
                                                    const tdS = { ...styles.td, ...compactStyles.td, width: col.width + 'px' };
                                                    if (col.id === 'checkbox') return <td key={col.id} style={tdS}><input type="checkbox" checked={allPkgItemsSelected} onChange={toggleLegacyPkgSelect} /></td>;
                                                    if (col.id === 'expand') return <td key={col.id} style={tdS}><button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => togglePackageExpand(pkg.name)}>{isPkgExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</button></td>;
                                                    if (col.id === 'manufacturer') return <td key={col.id} style={{ ...tdS, fontWeight: '700' }}><Icons.Package /> <span style={{ color: pkgColor.b }}>{pkg.name}</span> <span style={{ fontSize: '10px', color: '#6e767d' }}>(legacy)</span></td>;
                                                    if (col.id === 'extCost') return <td key={col.id} style={{ ...tdS, color: '#00ba7c', fontWeight: '600' }}>{fmtCost(pkg.cost)}</td>;
                                                    if (col.id === 'extLabor' || col.id === 'labor') return <td key={col.id} style={tdS}>{fmtHrs(pkg.labor)}</td>;
                                                    return <td key={col.id} style={tdS}></td>;
                                                })}
                                            </tr>
                                            {isPkgExpanded && pkg.items.map((item, pkgItemIdx) => {
                                                const i = pkg.indices[pkgItemIdx];
                                                const isItemSelected = selectedItems.includes(i);
                                                const itemTotal = calculateItemTotal(item);
                                                return (
                                                    <tr key={`legacy-pkg-item-${i}`} style={{ backgroundColor: isItemSelected ? '#1d3a5c' : '#0d1117', borderLeft: `3px solid ${pkgColor.b}` }}>
                                                        {columns.map(col => renderItemCell(col, item, i, {
                                                            isSelected: isItemSelected, hasAccessories: item.accessories?.length > 0, isExpanded: expandedItems[i] !== false, itemTotal,
                                                            isPackageItem: true, pkgColor,
                                                            changeQty, changeNotes, changeSystem, toggleSelect, toggleItemExpand
                                                        }))}
                                                    </tr>
                                                );
                                            })}
                                        </React.Fragment>
                                    );
                                })}
                                
                                {/* Render standalone items */}
                                {groupedItems.standalone.map(({ item, idx: i }) => {
                                    const isSelected = selectedItems.includes(i);
                                    const hasAccessories = item.accessories?.length > 0;
                                    const isExpanded = expandedItems[i] !== false;
                                    const itemTotal = calculateItemTotal(item);
                                    
                                    return (
                                        <React.Fragment key={i}>
                                            {/* Main item row */}
                                            <tr 
                                                style={{ backgroundColor: isSelected ? '#1d3a5c' : 'transparent', cursor: 'context-menu' }}
                                                onContextMenu={e => handleContextMenu(e, i, false, null)}>
                                                {columns.map(col => renderItemCell(col, item, i, {
                                                    isSelected, hasAccessories, isExpanded, itemTotal,
                                                    isPackageItem: false, pkgColor: null,
                                                    changeQty, changeNotes, changeSystem, toggleSelect, toggleItemExpand
                                                }))}
                                            </tr>
                                            
                                            {/* Accessory rows */}
                                            {hasAccessories && isExpanded && item.accessories.map((acc, accIdx) => (
                                                <tr 
                                                    key={`${i}-acc-${accIdx}`} 
                                                    style={{ backgroundColor: '#0d1117', cursor: 'context-menu' }}
                                                    onContextMenu={e => handleContextMenu(e, i, true, accIdx)}>
                                                    {columns.map(col => renderAccessoryCell(col, acc, i, accIdx, { pkgColor: null, changeAccessoryQty, changeAccessoryNotes, removeAccessory }))}
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                            <tfoot>
                                <tr style={{ backgroundColor: '#151a21' }}>
                                    <td colSpan={columns.length - 2} style={{ ...styles.td, fontWeight: '700' }}>TOTAL (this location)</td>
                                    <td style={{ ...styles.td, fontWeight: '700', color: '#00ba7c' }}>{fmtCost(directCost)}</td>
                                    <td style={{ ...styles.td, fontWeight: '700', color: '#1d9bf0' }}>{fmtHrs(directLabor)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            ) : (
                <div style={{ ...styles.card, textAlign: 'center', padding: '40px' }}>
                    <div style={{ fontSize: '32px', marginBottom: '12px' }}></div>
                    <h3 style={{ margin: '0 0 8px 0', color: '#8b98a5', fontSize: '16px' }}>No components in this location</h3>
                    <p style={{ margin: '0 0 16px 0', color: '#6e767d', fontSize: '14px' }}>Add components, paste from clipboard, or apply a template</p>
                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }}>
                        {clipboard.length > 0 && <button style={styles.button('success')} onClick={handlePaste}><Icons.Clipboard /> Paste ({clipboard.length})</button>}
                        {templates && templates.length > 0 && <button style={styles.button('purple')} onClick={onApplyTemplate}><Icons.Template /> Apply Template</button>}
                        <button style={styles.button('primary')} onClick={onSearch}><Icons.Plus /> Add Components</button>
                    </div>
                </div>
            )}
            
            {/* Context Menu */}
            {contextMenu && (
                <div style={{ 
                    position: 'fixed', 
                    left: contextMenu.x, 
                    top: contextMenu.y, 
                    backgroundColor: '#1a1f26', 
                    border: '1px solid #2f3336', 
                    borderRadius: '8px', 
                    padding: '4px', 
                    zIndex: 1000,
                    boxShadow: '0 4px 12px rgba(0,0,0,0.4)',
                    minWidth: '180px'
                }}>
                    {contextMenu.isPackage ? (
                        // Package context menu
                        <>
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { onUngroupPackage(contextMenu.packageName); setContextMenu(null); }}>
                                <Icons.Layers /> Ungroup Package
                            </button>
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#f87171' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => {
                                    // New-style: find by name, delete single instance
                                    const newPkg = groupedItems.packages.find(p => p.name === contextMenu.packageName);
                                    if (newPkg) { del([newPkg.idx]); }
                                    else {
                                        // Legacy: find by name, delete all items
                                        const legacyPkg = groupedItems.legacyPackages.find(p => p.name === contextMenu.packageName);
                                        if (legacyPkg) del(legacyPkg.indices);
                                    }
                                    setContextMenu(null);
                                }}>
                                <Icons.Trash /> Delete Package
                            </button>
                        </>
                    ) : contextMenu.isAccessory ? (
                        // Accessory context menu
                        <>
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { promoteAccessoryToItem(contextMenu.itemIdx, contextMenu.accIdx); setContextMenu(null); }}>
                                <Icons.ChevronUp /> Promote to Item
                            </button>
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#f87171' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { removeAccessory(contextMenu.itemIdx, contextMenu.accIdx); setContextMenu(null); }}>
                                <Icons.Trash /> Remove Accessory
                            </button>
                        </>
                    ) : (
                        // Main item context menu
                        <>
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { onAddAccessoryToItem(contextMenu.itemIdx); setContextMenu(null); }}>
                                <Icons.Plus /> Add Accessory
                            </button>
                            {directItems > 1 && (
                                <button 
                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                    onClick={() => { onConvertToAccessory(contextMenu.itemIdx); setContextMenu(null); }}>
                                    <Icons.ChevronDown /> Convert to Accessory
                                </button>
                            )}
                            <div style={{ borderTop: '1px solid #2f3336', margin: '4px 0' }} />
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { onCopy([{ ...location.items[contextMenu.itemIdx] }]); setContextMenu(null); }}>
                                <Icons.Copy /> Copy
                            </button>
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { onSavePackage([{ ...location.items[contextMenu.itemIdx] }], [contextMenu.itemIdx]); setContextMenu(null); }}>
                                <Icons.Package /> Save as New Package
                            </button>
                            {/* Show existing legacy packages to move item into */}
                            {groupedItems.legacyPackages.length > 0 && (
                                <>
                                    <div style={{ padding: '4px 12px', fontSize: '11px', color: '#6e767d', textTransform: 'uppercase' }}>Move to Package</div>
                                    {groupedItems.legacyPackages.map(pkg => {
                                        const pkgColor = styles.pkgColor(pkg.name);
                                        return (
                                            <button
                                                key={pkg.name}
                                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '6px 12px 6px 20px', fontSize: '12px' }}
                                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                                onClick={() => { onMoveToPackage(contextMenu.itemIdx, pkg.name); setContextMenu(null); }}>
                                                <span style={{ width: '8px', height: '8px', borderRadius: '2px', backgroundColor: pkgColor.b, marginRight: '8px' }}></span>
                                                {pkg.name}
                                            </button>
                                        );
                                    })}
                                </>
                            )}
                            <div style={{ borderTop: '1px solid #2f3336', margin: '4px 0' }} />
                            {onAddToCatalog && (
                                <button 
                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#1d9bf0' }}
                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                    onClick={() => { onAddToCatalog(location.items[contextMenu.itemIdx]); setContextMenu(null); }}>
                                    <Icons.Database /> Add to Catalog
                                </button>
                            )}
                            <button 
                                style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#f87171' }}
                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                onClick={() => { deleteItem(contextMenu.itemIdx); setContextMenu(null); }}>
                                <Icons.Trash /> Delete
                            </button>
                        </>
                    )}
                </div>
            )}
        </div>
    );
}

// Catalog Item Editor Modal
function CatalogItemModal({ item, onClose, onSave, categories, catalog }) {
    const [form, setForm] = useState({
        manufacturer: item?.manufacturer || '',
        model: item?.model || '',
        partNumber: item?.partNumber || '',
        description: item?.description || '',
        category: item?.category || '',
        subcategory: item?.subcategory || '',
        unitCost: item?.unitCost || 0,
        laborHrsPerUnit: item?.laborHrsPerUnit || 0,
        uom: item?.uom || 'EA',
        vendor: item?.vendor || '',
        discontinued: item?.discontinued || false,
        phase: item?.phase || '',
        catalogNote: item?.catalogNote || '',
    });
    const [defaultAccessories, setDefaultAccessories] = useState(item?.defaultAccessories || []);
    const [accSearch, setAccSearch] = useState('');
    const [showAccSearch, setShowAccSearch] = useState(false);

    const accSearchResults = useMemo(() => {
        if (accSearch.length < 2 || !catalog) return [];
        const term = accSearch.toLowerCase();
        const currentId = item?.id;
        return catalog.filter(c =>
            c.id !== currentId && !c.deleted &&
            ((c.manufacturer?.toLowerCase().includes(term)) ||
             (c.model?.toLowerCase().includes(term)) ||
             (c.partNumber?.toLowerCase().includes(term)) ||
             (c.description?.toLowerCase().includes(term)))
        ).slice(0, 10);
    }, [catalog, accSearch, item?.id]);

    const addAccessory = (catItem) => {
        if (defaultAccessories.some(a => a.catalogId === catItem.id)) return;
        setDefaultAccessories(prev => [...prev, { catalogId: catItem.id, qtyPer: 1 }]);
        setAccSearch('');
        setShowAccSearch(false);
    };

    const removeAccessory = (catalogId) => {
        setDefaultAccessories(prev => prev.filter(a => a.catalogId !== catalogId));
    };

    const updateAccQty = (catalogId, newQty) => {
        setDefaultAccessories(prev => prev.map(a => a.catalogId === catalogId ? { ...a, qtyPer: Math.max(1, parseInt(newQty) || 1) } : a));
    };

    const [newCategory, setNewCategory] = useState('');
    const [newSubcategory, setNewSubcategory] = useState('');
    const [showNewCategory, setShowNewCategory] = useState(false);
    const [showNewSubcategory, setShowNewSubcategory] = useState(false);

    const existingCategories = [...new Set(categories.map(c => c.category).concat(form.category ? [form.category] : []))].filter(Boolean).sort();
    const existingSubcategories = [...new Set(categories.filter(c => c.category === form.category).map(c => c.subcategory).concat(form.subcategory ? [form.subcategory] : []))].filter(Boolean).sort();

    const handleSubmit = () => {
        if (!form.manufacturer.trim() || !form.model.trim()) return;
        onSave({
            ...item,
            ...form,
            defaultAccessories: defaultAccessories.length > 0 ? defaultAccessories : undefined,
            id: item?.id || generateCatalogId(),
            modifiedAt: new Date().toISOString(),
        });
        onClose();
    };
    
    const inputStyle = { ...styles.input, marginBottom: '12px' };
    const labelStyle = { display: 'block', marginBottom: '4px', fontSize: '12px', color: '#8b98a5', textTransform: 'uppercase' };
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '700px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 20px 0', fontSize: '20px', fontWeight: '700' }}>
                    {item ? 'Edit Catalog Item' : 'Add New Catalog Item'}
                </h2>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div>
                        <label style={labelStyle}>Manufacturer *</label>
                        <input type="text" value={form.manufacturer} onChange={e => setForm({ ...form, manufacturer: e.target.value })} style={inputStyle} placeholder="e.g., Samsung" autoFocus />
                    </div>
                    <div>
                        <label style={labelStyle}>Model *</label>
                        <input type="text" value={form.model} onChange={e => setForm({ ...form, model: e.target.value })} style={inputStyle} placeholder="e.g., QM85C" />
                    </div>
                    <div>
                        <label style={labelStyle}>Part Number</label>
                        <input type="text" value={form.partNumber} onChange={e => setForm({ ...form, partNumber: e.target.value })} style={inputStyle} placeholder="e.g., LH85QMCEBGCXXS" />
                    </div>
                    <div>
                        <label style={labelStyle}>Vendor</label>
                        <input type="text" value={form.vendor} onChange={e => setForm({ ...form, vendor: e.target.value })} style={inputStyle} placeholder="e.g., AVDomotics" />
                    </div>
                    <div style={{ gridColumn: '1 / -1' }}>
                        <label style={labelStyle}>Description</label>
                        <input type="text" value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} style={inputStyle} placeholder="e.g., 85&quot; 4K UHD Display" />
                    </div>
                    <div>
                        <label style={labelStyle}>Category</label>
                        {showNewCategory ? (
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <input type="text" value={newCategory} onChange={e => setNewCategory(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="New category name" autoFocus />
                                <button style={styles.smallButton} onClick={() => { setForm({ ...form, category: newCategory, subcategory: '' }); setShowNewCategory(false); }}>Add</button>
                                <button style={styles.smallButton} onClick={() => setShowNewCategory(false)}>Cancel</button>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <select value={form.category} onChange={e => setForm({ ...form, category: e.target.value, subcategory: '' })} style={{ ...inputStyle, flex: 1, cursor: 'pointer' }}>
                                    <option value="">Select category...</option>
                                    {existingCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <button style={styles.smallButton} onClick={() => setShowNewCategory(true)}><Icons.Plus /></button>
                            </div>
                        )}
                    </div>
                    <div>
                        <label style={labelStyle}>Subcategory</label>
                        {showNewSubcategory ? (
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <input type="text" value={newSubcategory} onChange={e => setNewSubcategory(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="New subcategory name" autoFocus />
                                <button style={styles.smallButton} onClick={() => { setForm({ ...form, subcategory: newSubcategory }); setShowNewSubcategory(false); }}>Add</button>
                                <button style={styles.smallButton} onClick={() => setShowNewSubcategory(false)}>Cancel</button>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <select value={form.subcategory} onChange={e => setForm({ ...form, subcategory: e.target.value })} style={{ ...inputStyle, flex: 1, cursor: 'pointer' }}>
                                    <option value="">Select subcategory...</option>
                                    {existingSubcategories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <button style={styles.smallButton} onClick={() => setShowNewSubcategory(true)}><Icons.Plus /></button>
                            </div>
                        )}
                    </div>
                    <div>
                        <label style={labelStyle}>Unit Cost ($)</label>
                        <input type="number" value={form.unitCost} onChange={e => setForm({ ...form, unitCost: parseFloat(e.target.value) || 0 })} onFocus={e => e.target.select()} style={inputStyle} min="0" step="0.01" />
                    </div>
                    <div>
                        <label style={labelStyle}>Labor Hours</label>
                        <input type="number" value={form.laborHrsPerUnit} onChange={e => setForm({ ...form, laborHrsPerUnit: parseFloat(e.target.value) || 0 })} onFocus={e => e.target.select()} style={inputStyle} min="0" step="0.25" />
                    </div>
                    <div>
                        <label style={labelStyle}>Unit of Measure</label>
                        <select value={form.uom} onChange={e => setForm({ ...form, uom: e.target.value })} style={{ ...inputStyle, cursor: 'pointer' }}>
                            {UOM_OPTIONS.map(u => <option key={u} value={u}>{u}</option>)}
                        </select>
                    </div>
                    <div>
                        <label style={labelStyle}>Phase</label>
                        <select value={form.phase} onChange={e => setForm({ ...form, phase: e.target.value })} style={{ ...inputStyle, cursor: 'pointer' }}>
                            <option value="">Select phase...</option>
                            {PHASE_OPTIONS.map(p => <option key={p.value} value={p.label}>{p.label}</option>)}
                        </select>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <input type="checkbox" checked={form.discontinued} onChange={e => setForm({ ...form, discontinued: e.target.checked })} id="discontinued" />
                        <label htmlFor="discontinued" style={{ fontSize: '14px', color: '#8b98a5', cursor: 'pointer' }}>Discontinued</label>
                    </div>
                </div>

                <div style={{ marginTop: '12px' }}>
                    <label style={labelStyle}>Catalog Note</label>
                    <textarea value={form.catalogNote} onChange={e => setForm({ ...form, catalogNote: e.target.value })} style={{ ...inputStyle, minHeight: '60px', resize: 'vertical', fontFamily: 'inherit' }} placeholder="e.g., Replacement: Samsung QM85R" />
                </div>

                {/* Default Accessories */}
                {catalog && (
                    <div style={{ marginTop: '12px', padding: '16px', backgroundColor: '#161b22', borderRadius: '8px', border: '1px solid #2f3336' }}>
                        <label style={{ ...labelStyle, marginBottom: '8px' }}>Default Accessories</label>
                        <p style={{ fontSize: '12px', color: '#6e767d', margin: '0 0 12px 0' }}>Items added automatically when this component is inserted into a project.</p>
                        {defaultAccessories.length > 0 && (
                            <div style={{ marginBottom: '12px' }}>
                                {defaultAccessories.map(acc => {
                                    const catItem = catalog.find(c => c.id === acc.catalogId);
                                    return (
                                        <div key={acc.catalogId} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px', backgroundColor: '#1a1f26', borderRadius: '6px', marginBottom: '4px', border: '1px solid #2f3336' }}>
                                            <input
                                                type="number"
                                                min="1"
                                                value={acc.qtyPer}
                                                onChange={e => updateAccQty(acc.catalogId, e.target.value)}
                                                onFocus={e => e.target.select()}
                                                style={{ ...styles.inputSmall, width: '50px', textAlign: 'center' }}
                                            />
                                            <span style={{ fontSize: '12px', color: '#6e767d' }}>x</span>
                                            <div style={{ flex: 1, minWidth: 0 }}>
                                                <div style={{ fontSize: '13px', color: '#e7e9ea', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                                    {catItem ? `${catItem.manufacturer} ${catItem.model}` : `Unknown (${acc.catalogId})`}
                                                </div>
                                                {catItem && <div style={{ fontSize: '11px', color: '#6e767d' }}>{catItem.description}</div>}
                                            </div>
                                            {catItem && <span style={{ fontSize: '12px', color: '#00ba7c', flexShrink: 0 }}>{fmtCost(catItem.unitCost)}</span>}
                                            <button
                                                style={{ ...styles.iconButton, color: '#f87171', padding: '4px', flexShrink: 0 }}
                                                onClick={() => removeAccessory(acc.catalogId)}
                                                title="Remove accessory">
                                                <Icons.X />
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {showAccSearch ? (
                            <div>
                                <input
                                    type="text"
                                    value={accSearch}
                                    onChange={e => setAccSearch(e.target.value)}
                                    placeholder="Search catalog for accessory..."
                                    style={{ ...inputStyle, marginBottom: '8px' }}
                                    autoFocus
                                />
                                {accSearchResults.length > 0 && (
                                    <div style={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid #2f3336', borderRadius: '6px' }}>
                                        {accSearchResults.map(c => (
                                            <div
                                                key={c.id}
                                                style={{ padding: '8px 12px', cursor: 'pointer', fontSize: '13px', borderBottom: '1px solid #2f3336', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}
                                                onClick={() => addAccessory(c)}
                                                onMouseEnter={e => e.currentTarget.style.backgroundColor = '#1a1f26'}
                                                onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                            >
                                                <div>
                                                    <span style={{ fontWeight: '600' }}>{c.manufacturer}</span> <span style={{ color: '#1d9bf0' }}>{c.model}</span>
                                                    <div style={{ fontSize: '11px', color: '#6e767d' }}>{c.description}</div>
                                                </div>
                                                <span style={{ color: '#00ba7c', fontSize: '12px', flexShrink: 0, marginLeft: '12px' }}>{fmtCost(c.unitCost)}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                                    <button style={styles.smallButton} onClick={() => { setShowAccSearch(false); setAccSearch(''); }}>Cancel</button>
                                </div>
                            </div>
                        ) : (
                            <button style={{ ...styles.smallButton, color: '#1d9bf0' }} onClick={() => setShowAccSearch(true)}>
                                <Icons.Plus /> Add Accessory
                            </button>
                        )}
                    </div>
                )}

                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px', borderTop: '1px solid #2f3336', paddingTop: '20px' }}>
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button 
                        style={{ ...styles.button('primary'), opacity: (!form.manufacturer.trim() || !form.model.trim()) ? 0.5 : 1 }} 
                        disabled={!form.manufacturer.trim() || !form.model.trim()} 
                        onClick={handleSubmit}
                    >
                        {item ? 'Save Changes' : 'Add to Catalog'}
                    </button>
                </div>
            </div>
        </div>
    );
}

// Catalog Sync Conflict Modal
function CatalogConflictModal({ conflicts, onResolve, onClose }) {
    const [resolutions, setResolutions] = useState({}); // { itemId: 'local' | 'remote' }
    
    const resolveOne = (itemId, choice) => {
        setResolutions(prev => ({ ...prev, [itemId]: choice }));
    };
    
    const resolveAll = (choice) => {
        const all = {};
        conflicts.forEach(c => all[c.local.id] = choice);
        setResolutions(all);
    };
    
    const handleApply = () => {
        const resolved = conflicts.map(c => ({
            item: resolutions[c.local.id] === 'local' ? c.local : c.remote,
            choice: resolutions[c.local.id]
        }));
        onResolve(resolved);
    };
    
    const allResolved = conflicts.every(c => resolutions[c.local.id]);
    
    const formatDate = (dateStr) => {
        const d = new Date(dateStr);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + ' hours ago';
        return Math.floor(diff / 86400000) + ' days ago';
    };
    
    const getChangedFields = (local, remote) => {
        const fields = ['manufacturer', 'model', 'partNumber', 'description', 'category', 'subcategory', 'unitCost', 'laborHrsPerUnit', 'uom', 'vendor', 'discontinued', 'phase'];
        return fields.filter(f => local[f] !== remote[f]);
    };
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '800px', maxHeight: '80vh' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <Icons.AlertTriangle style={{ color: '#f59e0b' }} /> Catalog Sync Conflicts
                </h2>
                <p style={{ color: '#8b98a5', margin: '0 0 20px 0' }}>
                    {conflicts.length} item{conflicts.length !== 1 ? 's were' : ' was'} modified both locally and remotely. Choose which version to keep.
                </p>
                
                <div style={{ maxHeight: '50vh', overflowY: 'auto', marginBottom: '16px' }}>
                    {conflicts.map(conflict => {
                        const changedFields = getChangedFields(conflict.local, conflict.remote);
                        const resolution = resolutions[conflict.local.id];
                        
                        return (
                            <div key={conflict.local.id} style={{ 
                                backgroundColor: '#161b22', 
                                borderRadius: '8px', 
                                border: `1px solid ${resolution ? '#2ea043' : '#f59e0b'}`,
                                padding: '16px',
                                marginBottom: '12px'
                            }}>
                                <div style={{ fontWeight: '600', marginBottom: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span>{conflict.local.manufacturer} {conflict.local.model}</span>
                                    {resolution && <span style={{ ...styles.badge('green'), fontSize: '10px' }}><Icons.Check /> Resolved</span>}
                                </div>
                                
                                <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr>
                                            <th style={{ textAlign: 'left', padding: '6px 8px', borderBottom: '1px solid #30363d', color: '#8b98a5' }}>Field</th>
                                            <th style={{ textAlign: 'left', padding: '6px 8px', borderBottom: '1px solid #30363d', color: '#8b98a5' }}>Your Version</th>
                                            <th style={{ textAlign: 'left', padding: '6px 8px', borderBottom: '1px solid #30363d', color: '#8b98a5' }}>Remote Version</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {changedFields.map(field => (
                                            <tr key={field}>
                                                <td style={{ padding: '6px 8px', borderBottom: '1px solid #21262d', color: '#8b98a5', textTransform: 'capitalize' }}>{field.replace(/([A-Z])/g, ' $1')}</td>
                                                <td style={{ padding: '6px 8px', borderBottom: '1px solid #21262d', backgroundColor: resolution === 'local' ? '#1a3d2e' : 'transparent' }}>
                                                    {typeof conflict.local[field] === 'boolean' ? (conflict.local[field] ? 'Yes' : 'No') : 
                                                     field === 'unitCost' ? fmtCost(conflict.local[field]) : 
                                                     String(conflict.local[field] || '-')}
                                                </td>
                                                <td style={{ padding: '6px 8px', borderBottom: '1px solid #21262d', backgroundColor: resolution === 'remote' ? '#1a3d2e' : 'transparent' }}>
                                                    {typeof conflict.remote[field] === 'boolean' ? (conflict.remote[field] ? 'Yes' : 'No') : 
                                                     field === 'unitCost' ? fmtCost(conflict.remote[field]) : 
                                                     String(conflict.remote[field] || '-')}
                                                </td>
                                            </tr>
                                        ))}
                                        <tr>
                                            <td style={{ padding: '6px 8px', color: '#6e767d' }}>Modified</td>
                                            <td style={{ padding: '6px 8px', color: '#6e767d' }}>{formatDate(conflict.local.modifiedAt)}</td>
                                            <td style={{ padding: '6px 8px', color: '#6e767d' }}>{formatDate(conflict.remote.modifiedAt)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                                    <button 
                                        style={{ ...styles.smallButton, backgroundColor: resolution === 'local' ? '#238636' : '#21262d' }}
                                        onClick={() => resolveOne(conflict.local.id, 'local')}
                                    >
                                        Use Yours
                                    </button>
                                    <button 
                                        style={{ ...styles.smallButton, backgroundColor: resolution === 'remote' ? '#238636' : '#21262d' }}
                                        onClick={() => resolveOne(conflict.local.id, 'remote')}
                                    >
                                        Use Remote
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                </div>
                
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'space-between', borderTop: '1px solid #2f3336', paddingTop: '16px' }}>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        <button style={styles.smallButton} onClick={() => resolveAll('remote')}>Use All Remote</button>
                        <button style={styles.smallButton} onClick={() => resolveAll('local')}>Use All Yours</button>
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        <button style={styles.button('secondary')} onClick={onClose}>Cancel Sync</button>
                        <button 
                            style={{ ...styles.button('primary'), opacity: !allResolved ? 0.5 : 1 }}
                            disabled={!allResolved}
                            onClick={handleApply}
                        >
                            Apply Resolutions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// Labor by Phase Report Component
function LaborByPhaseReport({ locations, catalogPkgs, projectPkgs, hierarchyGroups }) {
    // Rows = locations/groups, Columns = phases
    const data = useMemo(() => {
        // Use hierarchy groups if provided, otherwise one row per leaf location (full path)
        const groups = hierarchyGroups || getLocationsWithItems(locations).map(loc => ({
            name: loc.path || loc.name,
            locations: [loc],
        }));
        // locationMap: { groupName: { phaseName: hours } }
        const locationMap = {};
        const groupNames = groups.map(g => g.name);
        const phaseSet = new Set();

        for (const group of groups) {
            if (!locationMap[group.name]) locationMap[group.name] = {};
            for (const loc of group.locations) {
                const flatItems = getFlattenedItems(loc, catalogPkgs, projectPkgs);
                for (const item of flatItems) {
                    const phase = item.phase || 'Unphased';
                    const hrs = (item.qty || 0) * (item.laborHrsPerUnit || 0);
                    phaseSet.add(phase);
                    locationMap[group.name][phase] = (locationMap[group.name][phase] || 0) + hrs;
                    // Include accessories
                    if (item.accessories) {
                        for (const acc of item.accessories) {
                            const accPhase = acc.phase || phase; // inherit parent phase if empty
                            const accHrs = (acc.qty || 0) * (acc.laborHrsPerUnit || 0);
                            phaseSet.add(accPhase);
                            locationMap[group.name][accPhase] = (locationMap[group.name][accPhase] || 0) + accHrs;
                        }
                    }
                }
            }
        }

        const phases = [...phaseSet].sort((a, b) => a === 'Unphased' ? 1 : b === 'Unphased' ? -1 : a.localeCompare(b));
        return { phases, locationMap, groupNames };
    }, [locations, catalogPkgs, projectPkgs, hierarchyGroups]);

    const exportLaborByPhase = () => {
        const { phases, locationMap, groupNames } = data;
        const header = ['Location', ...phases, 'Total'];
        const rows = groupNames.map(gn => {
            const row = [gn];
            let total = 0;
            for (const phase of phases) {
                const hrs = locationMap[gn][phase] || 0;
                row.push(Math.round(hrs * 100) / 100);
                total += hrs;
            }
            row.push(Math.round(total * 100) / 100);
            return row;
        });
        // Column totals
        const totalsRow = ['TOTAL'];
        let grandTotal = 0;
        for (const phase of phases) {
            let colTotal = 0;
            for (const gn of groupNames) colTotal += locationMap[gn][phase] || 0;
            totalsRow.push(Math.round(colTotal * 100) / 100);
            grandTotal += colTotal;
        }
        totalsRow.push(Math.round(grandTotal * 100) / 100);
        const wsData = [header, ...rows, totalsRow];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Labor by Phase');
        XLSX.writeFile(wb, 'Labor by Phase.xlsx');
    };

    const { phases, locationMap, groupNames } = data;
    if (phases.length === 0) return <p style={{ color: '#8b98a5', fontSize: '13px' }}>No labor data found. Add items with labor hours to see the breakdown.</p>;

    return (
        <div>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                <h3 style={{ margin: 0, fontSize: '20px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    Labor by Phase
                </h3>
                <button style={styles.smallButton} onClick={exportLaborByPhase}><Icons.Download /> Export</button>
            </div>
            <div style={{ overflowX: 'auto', border: '1px solid #2f3336', borderRadius: '8px' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px', tableLayout: 'auto' }}>
                    <thead>
                        <tr style={{ background: '#161b22' }}>
                            <th style={{ ...styles.th, minWidth: '200px' }}>Location</th>
                            {phases.map(phase => <th key={phase} style={{ ...styles.th, minWidth: '90px', textAlign: 'right' }}>{phase}</th>)}
                            <th style={{ ...styles.th, minWidth: '90px', textAlign: 'right', fontWeight: '700' }}>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {groupNames.map(gn => {
                            let rowTotal = 0;
                            return (
                                <tr key={gn} style={{ borderBottom: '1px solid #2f3336' }}>
                                    <td style={{ ...styles.td, fontWeight: '600', whiteSpace: 'nowrap' }}>{gn}</td>
                                    {phases.map(phase => {
                                        const hrs = locationMap[gn][phase] || 0;
                                        rowTotal += hrs;
                                        return <td key={phase} style={{ ...styles.td, textAlign: 'right' }}>{hrs > 0 ? fmtHrs(hrs) : '-'}</td>;
                                    })}
                                    <td style={{ ...styles.td, textAlign: 'right', fontWeight: '600' }}>{fmtHrs(rowTotal)}</td>
                                </tr>
                            );
                        })}
                        <tr style={{ background: '#161b22', fontWeight: '700' }}>
                            <td style={{ ...styles.td }}>TOTAL</td>
                            {phases.map(phase => {
                                let colTotal = 0;
                                for (const gn of groupNames) colTotal += locationMap[gn][phase] || 0;
                                return <td key={phase} style={{ ...styles.td, textAlign: 'right' }}>{fmtHrs(colTotal)}</td>;
                            })}
                            <td style={{ ...styles.td, textAlign: 'right', color: '#1d9bf0' }}>{(() => { let gt = 0; for (const gn of groupNames) for (const phase of phases) gt += locationMap[gn][phase] || 0; return fmtHrs(gt); })()}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    );
}

const CATALOG_COLUMNS = [
    { id: 'checkbox', label: '', width: 36, fixed: true },
    { id: 'favorite', label: '\u2605', width: 40 },
    { id: 'manufacturer', label: 'Manufacturer', width: 130 },
    { id: 'model', label: 'Model', width: 120 },
    { id: 'partNumber', label: 'Part #', width: 130 },
    { id: 'description', label: 'Description', width: 220 },
    { id: 'category', label: 'Category', width: 110 },
    { id: 'subcategory', label: 'Subcategory', width: 120 },
    { id: 'unitCost', label: 'Cost', width: 90 },
    { id: 'laborHrsPerUnit', label: 'Labor', width: 75 },
    { id: 'uom', label: 'UOM', width: 60 },
    { id: 'vendor', label: 'Vendor', width: 110 },
    { id: 'phase', label: 'Phase', width: 90 },
    { id: 'discontinued', label: 'Disc.', width: 60 },
    { id: 'catalogNote', label: 'Note', width: 160 },
    { id: 'actions', label: 'Actions', width: 80, fixed: true },
];

function CatalogView({ catalog, onUpdateCatalog, onRefreshCatalog, onSaveCatalog, syncStatus, catalogDirty, compactMode }) {
    const [search, setSearch] = useState('');
    const [categoryFilter, setCategoryFilter] = useState('');
    const [showAddItem, setShowAddItem] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [confirmDelete, setConfirmDelete] = useState(null);
    const [sortField, setSortField] = useState('manufacturer');
    const [sortDir, setSortDir] = useState('asc');
    const [editMode, setEditMode] = useState(false);

    // Multi-select
    const [selectedIds, setSelectedIds] = useState(new Set());
    const lastClickedRef = useRef(null);
    const [contextMenu, setContextMenu] = useState(null); // { x, y }
    const [bulkEditField, setBulkEditField] = useState(null); // field key to edit
    const [bulkEditValue, setBulkEditValue] = useState('');

    const { columns: catalogCols, startResize: startCatResize } = useFlexibleColumns(CATALOG_COLUMNS);

    // Inline edit handler - updates a single field on a catalog item
    const updateCatalogField = (itemId, field, value) => {
        onUpdateCatalog(catalog.map(c => c.id === itemId ? { ...c, [field]: value, modifiedAt: new Date().toISOString() } : c));
    };

    // Compact styles
    const thStyle = { ...styles.th, ...styles.thResizable, cursor: 'pointer', userSelect: 'none', ...(compactMode ? { padding: '6px 8px', fontSize: '10px' } : {}) };
    const tdStyle = { ...styles.td, ...(compactMode ? { padding: '4px 8px', fontSize: '11px' } : {}) };
    
    // Get unique categories
    const categories = useMemo(() => {
        const cats = [...new Set(catalog.map(c => c.category))].sort();
        return cats;
    }, [catalog]);
    
    // Filter and sort catalog
    const filtered = useMemo(() => {
        let items = catalog.filter(c => !c.deleted);
        
        if (categoryFilter) {
            items = items.filter(c => c.category === categoryFilter);
        }
        
        if (search.length >= 2) {
            const term = search.toLowerCase();
            items = items.filter(c => 
                (c.manufacturer + c.model + c.partNumber + c.description).toLowerCase().includes(term)
            );
        }
        
        items.sort((a, b) => {
            let aVal = a[sortField];
            let bVal = b[sortField];
            // Handle booleans (discontinued)
            if (typeof aVal === 'boolean') { aVal = aVal ? 1 : 0; bVal = bVal ? 1 : 0; }
            // Handle nullish
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();
            if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
            return 0;
        });
        
        return items;
    }, [catalog, search, categoryFilter, sortField, sortDir]);
    
    const handleSort = (field) => {
        if (sortField === field) {
            setSortDir(d => d === 'asc' ? 'desc' : 'asc');
        } else {
            setSortField(field);
            setSortDir('asc');
        }
    };
    
    const handleSave = (item) => {
        const exists = catalog.find(c => c.id === item.id);
        if (exists) {
            onUpdateCatalog(catalog.map(c => c.id === item.id ? item : c));
        } else {
            onUpdateCatalog([...catalog, item]);
        }
    };
    
    const handleDelete = (item) => {
        // Mark as deleted rather than removing (for sync purposes)
        onUpdateCatalog(catalog.map(c => c.id === item.id ? { ...c, deleted: true, modifiedAt: new Date().toISOString() } : c));
        setConfirmDelete(null);
    };
    
    // Multi-select toggle with shift-click range support
    const toggleSelect = (itemId, e) => {
        if (e?.shiftKey && lastClickedRef.current) {
            const idxA = filtered.findIndex(c => c.id === lastClickedRef.current);
            const idxB = filtered.findIndex(c => c.id === itemId);
            if (idxA !== -1 && idxB !== -1) {
                const start = Math.min(idxA, idxB);
                const end = Math.max(idxA, idxB);
                setSelectedIds(prev => {
                    const next = new Set(prev);
                    for (let i = start; i <= end; i++) next.add(filtered[i].id);
                    return next;
                });
            }
        } else {
            setSelectedIds(prev => {
                const next = new Set(prev);
                if (next.has(itemId)) next.delete(itemId); else next.add(itemId);
                return next;
            });
        }
        lastClickedRef.current = itemId;
    };

    const selectAll = () => {
        const visibleIds = filtered.slice(0, 200).map(c => c.id);
        const allSelected = visibleIds.every(id => selectedIds.has(id));
        if (allSelected) {
            setSelectedIds(new Set());
        } else {
            setSelectedIds(new Set(visibleIds));
        }
    };

    // Right-click context menu
    const handleContextMenu = (e) => {
        if (selectedIds.size === 0) return;
        e.preventDefault();
        setContextMenu({ x: e.clientX, y: e.clientY });
    };

    // Close context menu on click outside
    useEffect(() => {
        const close = () => setContextMenu(null);
        if (contextMenu) window.addEventListener('click', close);
        return () => window.removeEventListener('click', close);
    }, [contextMenu]);

    // Bulk edit field definitions
    const BULK_FIELDS = [
        { key: 'category', label: 'Category', type: 'text' },
        { key: 'subcategory', label: 'Subcategory', type: 'text' },
        { key: 'unitCost', label: 'Unit Cost', type: 'number' },
        { key: 'laborHrsPerUnit', label: 'Labor Hours', type: 'number' },
        { key: 'uom', label: 'UOM', type: 'select', options: UOM_OPTIONS },
        { key: 'vendor', label: 'Vendor', type: 'text' },
        { key: 'phase', label: 'Phase', type: 'select', options: ['', ...PHASE_OPTIONS.map(p => p.label)] },
        { key: 'discontinued', label: 'Discontinued', type: 'boolean' },
    ];

    const applyBulkEdit = () => {
        if (!bulkEditField) return;
        const field = BULK_FIELDS.find(f => f.key === bulkEditField);
        if (!field) return;
        let val = bulkEditValue;
        if (field.type === 'number') val = parseFloat(val) || 0;
        if (field.type === 'boolean') val = val === 'true' || val === true;
        const now = new Date().toISOString();
        onUpdateCatalog(catalog.map(c =>
            selectedIds.has(c.id) ? { ...c, [bulkEditField]: val, modifiedAt: now } : c
        ));
        setBulkEditField(null);
        setBulkEditValue('');
    };

    // Bulk delete
    const bulkDelete = () => {
        const now = new Date().toISOString();
        onUpdateCatalog(catalog.map(c =>
            selectedIds.has(c.id) ? { ...c, deleted: true, modifiedAt: now } : c
        ));
        setSelectedIds(new Set());
        setContextMenu(null);
    };

    const SortIcon = ({ field }) => {
        if (sortField !== field) return null;
        return sortDir === 'asc' ? <Icons.ChevronUp /> : <Icons.ChevronDown />;
    };
    
    return (
        <div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: catalogDirty ? '8px' : '24px' }}>
                <h2 style={{ margin: 0, fontSize: '28px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <Icons.Database /> Component Catalog
                    <span style={styles.badge('blue')}>{filtered.length} items</span>
                </h2>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    {syncStatus && (
                        <span style={{ fontSize: '12px', color: syncStatus === 'synced' ? '#00ba7c' : syncStatus === 'offline' || syncStatus === 'local' ? '#f59e0b' : '#8b98a5', display: 'flex', alignItems: 'center', gap: '4px' }}>
                            {syncStatus === 'synced' ? <><Icons.Cloud /> Synced</> :
                             syncStatus === 'offline' || syncStatus === 'local' ? <><Icons.CloudOff /> Local</> :
                             syncStatus === 'loading' ? <><Icons.Sync /> Loading...</> :
                             <><Icons.Sync /> {syncStatus}</>}
                        </span>
                    )}
                    <button
                        style={{ ...styles.smallButton, backgroundColor: editMode ? '#3d2e1a' : '#2f3336', color: editMode ? '#ffad1f' : '#8b98a5' }}
                        onClick={() => setEditMode(!editMode)}
                        title={editMode ? 'Lock fields (read-only)' : 'Unlock fields for inline editing'}
                    >
                        {editMode ? <><Icons.Lock /> Lock</> : <><Icons.Unlock /> Unlock</>}
                    </button>
                    <button style={{ ...styles.smallButton, backgroundColor: '#1a3d2e', color: '#00ba7c' }} onClick={onRefreshCatalog}>
                        <Icons.Sync /> Refresh
                    </button>
                    <button style={styles.button('primary')} onClick={() => setShowAddItem(true)}>
                        <Icons.Plus /> Add Item
                    </button>
                </div>
            </div>
            {catalogDirty && (
                <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '16px' }}>
                    <button
                        style={{ ...styles.button('primary'), padding: '10px 32px', fontSize: '15px', fontWeight: '700', animation: 'pulse 2s infinite', boxShadow: '0 0 16px rgba(29,155,240,0.5)', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px' }}
                        onClick={onSaveCatalog}
                    >
                        <Icons.Save /> Save Changes
                    </button>
                </div>
            )}
            
            <div style={styles.card}>
                <div style={{ display: 'flex', gap: '12px', marginBottom: '16px' }}>
                    <input 
                        type="text" 
                        placeholder="Search components..." 
                        value={search} 
                        onChange={e => setSearch(e.target.value)} 
                        style={{ ...styles.input, flex: 1 }} 
                    />
                    <select 
                        value={categoryFilter} 
                        onChange={e => setCategoryFilter(e.target.value)}
                        style={{ ...styles.input, width: '200px', cursor: 'pointer' }}
                    >
                        <option value="">All Categories</option>
                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                </div>
                
                <div style={{ maxHeight: '60vh', overflowY: 'auto', overflowX: 'auto' }}>
                    <table style={styles.table}>
                        <colgroup>
                            {catalogCols.map(col => <col key={col.id} style={{ width: col.width }} />)}
                        </colgroup>
                        <thead>
                            <tr>
                                {catalogCols.map((col, colIndex) => (
                                    <th
                                        key={col.id}
                                        style={{ ...thStyle, cursor: col.fixed ? 'default' : 'pointer' }}
                                        onClick={() => col.id === 'checkbox' ? selectAll() : (!col.fixed && handleSort(col.id))}
                                    >
                                        {col.id === 'checkbox' ? <input type="checkbox" checked={filtered.slice(0, 200).length > 0 && filtered.slice(0, 200).every(c => selectedIds.has(c.id))} onChange={selectAll} /> : col.label} {col.id !== 'checkbox' && !col.fixed && <SortIcon field={col.id} />}
                                        <div
                                            style={styles.resizeHandle}
                                            onMouseDown={e => startCatResize(colIndex, e)}
                                            onMouseEnter={e => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.backgroundColor = '#1d9bf0'; }}
                                            onMouseLeave={e => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.backgroundColor = '#4a5568'; }}
                                        />
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {filtered.slice(0, 200).map(item => (
                                <tr key={item.id} style={{ opacity: item.discontinued ? 0.5 : 1, backgroundColor: selectedIds.has(item.id) ? '#1d3a5c' : undefined }} onContextMenu={e => { if (selectedIds.has(item.id)) handleContextMenu(e); }}>
                                    {catalogCols.map(col => {
                                        const inlineInput = { ...styles.inputSmall, width: '100%', padding: '2px 4px', fontSize: compactMode ? '10px' : '11px' };
                                        switch (col.id) {
                                            case 'checkbox':
                                                return <td key={col.id} style={{ ...tdStyle, textAlign: 'center' }}><input type="checkbox" checked={selectedIds.has(item.id)} onChange={e => toggleSelect(item.id, e)} /></td>;
                                            case 'favorite':
                                                return <td key={col.id} style={{ ...tdStyle, textAlign: 'center', cursor: 'pointer', color: item.favorite ? '#f59e0b' : '#4a5568' }} onClick={() => updateCatalogField(item.id, 'favorite', !item.favorite)}><Icons.Star filled={!!item.favorite} /></td>;
                                            case 'manufacturer':
                                                return <td key={col.id} style={tdStyle}>{editMode ? <input type="text" value={item.manufacturer} onChange={e => updateCatalogField(item.id, 'manufacturer', e.target.value)} style={inlineInput} /> : item.manufacturer}</td>;
                                            case 'model':
                                                return <td key={col.id} style={tdStyle}>{editMode ? <input type="text" value={item.model} onChange={e => updateCatalogField(item.id, 'model', e.target.value)} style={inlineInput} /> : <strong>{item.model}</strong>}</td>;
                                            case 'partNumber':
                                                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '10px' : '11px', color: '#8b98a5' }}>{editMode ? <input type="text" value={item.partNumber || ''} onChange={e => updateCatalogField(item.id, 'partNumber', e.target.value)} style={inlineInput} /> : item.partNumber}</td>;
                                            case 'description':
                                                return <td key={col.id} style={tdStyle}>{editMode ? <input type="text" value={item.description || ''} onChange={e => updateCatalogField(item.id, 'description', e.target.value)} style={inlineInput} /> : item.description}</td>;
                                            case 'category':
                                                return <td key={col.id} style={tdStyle}><span style={{ ...styles.badge('blue'), fontSize: compactMode ? '10px' : '12px', padding: compactMode ? '2px 6px' : '3px 10px' }}>{item.category}</span></td>;
                                            case 'subcategory':
                                                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '10px' : '11px', color: '#8b98a5' }}>{editMode ? <input type="text" value={item.subcategory || ''} onChange={e => updateCatalogField(item.id, 'subcategory', e.target.value)} style={inlineInput} /> : (item.subcategory || '')}</td>;
                                            case 'unitCost':
                                                return <td key={col.id} style={{ ...tdStyle, color: '#00ba7c' }}>{editMode ? <input type="number" step="0.01" min="0" value={item.unitCost || 0} onChange={e => updateCatalogField(item.id, 'unitCost', parseFloat(e.target.value) || 0)} style={{ ...inlineInput, textAlign: 'right' }} /> : fmtCost(item.unitCost)}</td>;
                                            case 'laborHrsPerUnit':
                                                return <td key={col.id} style={tdStyle}>{editMode ? <input type="number" step="0.25" min="0" value={item.laborHrsPerUnit || 0} onChange={e => updateCatalogField(item.id, 'laborHrsPerUnit', parseFloat(e.target.value) || 0)} style={{ ...inlineInput, textAlign: 'right' }} /> : (item.laborHrsPerUnit + 'h')}</td>;
                                            case 'uom':
                                                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '10px' : '11px', color: '#8b98a5' }}>{editMode ? <select value={item.uom || 'EA'} onChange={e => updateCatalogField(item.id, 'uom', e.target.value)} style={{ ...inlineInput, cursor: 'pointer' }}>{UOM_OPTIONS.map(u => <option key={u} value={u}>{u}</option>)}</select> : (item.uom || 'EA')}</td>;
                                            case 'vendor':
                                                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '10px' : '11px' }}>{editMode ? <input type="text" value={item.vendor || ''} onChange={e => updateCatalogField(item.id, 'vendor', e.target.value)} style={inlineInput} /> : (item.vendor || '')}</td>;
                                            case 'phase':
                                                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '10px' : '11px' }}>{editMode ? <select value={item.phase || ''} onChange={e => updateCatalogField(item.id, 'phase', e.target.value)} style={{ ...inlineInput, cursor: 'pointer' }}><option value=""></option>{PHASE_OPTIONS.map(p => <option key={p.value} value={p.label}>{p.label}</option>)}</select> : (item.phase ? <span style={styles.badge('purple')}>{item.phase}</span> : '')}</td>;
                                            case 'discontinued':
                                                return <td key={col.id} style={{ ...tdStyle, textAlign: 'center' }}>{editMode ? <input type="checkbox" checked={!!item.discontinued} onChange={e => updateCatalogField(item.id, 'discontinued', e.target.checked)} /> : (item.discontinued ? <span style={{ ...styles.badge('red'), fontSize: '9px' }}>Yes</span> : '')}</td>;
                                            case 'catalogNote':
                                                return <td key={col.id} style={{ ...tdStyle, fontSize: compactMode ? '10px' : '11px', color: '#8b98a5' }}>{editMode ? <input type="text" value={item.catalogNote || ''} onChange={e => updateCatalogField(item.id, 'catalogNote', e.target.value)} style={inlineInput} placeholder="Note..." /> : (item.catalogNote || '')}</td>;
                                            case 'actions':
                                                return <td key={col.id} style={tdStyle}><div style={{ display: 'flex', gap: '4px' }}><button style={{ ...styles.iconButton, color: '#8b98a5' }} onClick={() => setEditItem(item)} title="Edit"><Icons.Edit /></button><button style={{ ...styles.iconButton, color: '#f87171' }} onClick={() => setConfirmDelete(item)} title="Delete"><Icons.Trash /></button></div></td>;
                                            default:
                                                return <td key={col.id} style={tdStyle}></td>;
                                        }
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {filtered.length > 200 && (
                        <div style={{ padding: '12px', textAlign: 'center', color: '#6e767d', fontSize: '13px' }}>
                            Showing 200 of {filtered.length} items. Use search to narrow results.
                        </div>
                    )}
                </div>
            </div>
            
            {/* Add/Edit Item Modal */}
            {(showAddItem || editItem) && (
                <CatalogItemModal
                    item={editItem}
                    onClose={() => { setShowAddItem(false); setEditItem(null); }}
                    onSave={handleSave}
                    categories={catalog}
                    catalog={catalog}
                />
            )}
            
            {/* Delete Confirmation */}
            {confirmDelete && (
                <div style={styles.modal} onClick={() => setConfirmDelete(null)}>
                    <div style={{ ...styles.modalContent, width: '400px' }} onClick={e => e.stopPropagation()}>
                        <h2 style={{ margin: '0 0 12px 0', fontSize: '18px', color: '#f87171' }}>Delete Catalog Item?</h2>
                        <p style={{ color: '#8b98a5', marginBottom: '20px' }}>
                            Are you sure you want to delete <strong style={{ color: '#e7e9ea' }}>{confirmDelete.manufacturer} {confirmDelete.model}</strong>?
                        </p>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={styles.button('secondary')} onClick={() => setConfirmDelete(null)}>Cancel</button>
                            <button style={styles.button('danger')} onClick={() => handleDelete(confirmDelete)}>Delete</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Selection count bar */}
            {selectedIds.size > 0 && (
                <div style={{ position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)', backgroundColor: '#1d3a5c', border: '1px solid #1d9bf0', borderRadius: '10px', padding: '10px 20px', display: 'flex', alignItems: 'center', gap: '16px', zIndex: 1000, boxShadow: '0 4px 20px rgba(0,0,0,0.5)' }}>
                    <span style={{ fontWeight: '600', color: '#1d9bf0' }}>{selectedIds.size} selected</span>
                    <span style={{ color: '#6e767d', fontSize: '12px' }}>Right-click for bulk edit</span>
                    <button style={{ ...styles.smallButton, backgroundColor: '#2f3336', color: '#8b98a5' }} onClick={() => setSelectedIds(new Set())}>Clear</button>
                </div>
            )}

            {/* Context menu */}
            {contextMenu && (
                <div style={{ position: 'fixed', left: contextMenu.x, top: contextMenu.y, backgroundColor: '#1a1f26', border: '1px solid #2f3336', borderRadius: '8px', padding: '4px 0', zIndex: 2000, boxShadow: '0 8px 24px rgba(0,0,0,0.6)', minWidth: '200px' }} onClick={e => e.stopPropagation()}>
                    <div style={{ padding: '6px 12px', fontSize: '11px', color: '#6e767d', borderBottom: '1px solid #2f3336', marginBottom: '2px' }}>Bulk Update {selectedIds.size} Items</div>
                    {BULK_FIELDS.map(f => (
                        <div key={f.key} style={{ padding: '8px 16px', cursor: 'pointer', color: '#e7e9ea', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}
                            onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                            onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                            onClick={() => { setBulkEditField(f.key); setBulkEditValue(f.type === 'boolean' ? 'true' : ''); setContextMenu(null); }}
                        >
                            Set {f.label}
                        </div>
                    ))}
                    <div style={{ borderTop: '1px solid #2f3336', marginTop: '2px' }}></div>
                    <div style={{ padding: '8px 16px', cursor: 'pointer', color: '#f87171', fontSize: '13px' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={bulkDelete}
                    >
                        <Icons.Trash /> Delete {selectedIds.size} Items
                    </div>
                </div>
            )}

            {/* Bulk Edit Modal */}
            {bulkEditField && (() => {
                const field = BULK_FIELDS.find(f => f.key === bulkEditField);
                if (!field) return null;
                return (
                    <div style={styles.modal} onClick={() => setBulkEditField(null)}>
                        <div style={{ ...styles.modalContent, width: '420px' }} onClick={e => e.stopPropagation()}>
                            <h2 style={{ margin: '0 0 16px 0', fontSize: '18px' }}>Set {field.label} for {selectedIds.size} Items</h2>
                            {field.type === 'text' && (
                                <input type="text" value={bulkEditValue} onChange={e => setBulkEditValue(e.target.value)} placeholder={`Enter ${field.label}...`} style={styles.input} autoFocus />
                            )}
                            {field.type === 'number' && (
                                <input type="number" step={field.key === 'unitCost' ? '0.01' : '0.25'} min="0" value={bulkEditValue} onChange={e => setBulkEditValue(e.target.value)} placeholder="0" style={styles.input} autoFocus />
                            )}
                            {field.type === 'select' && (
                                <select value={bulkEditValue} onChange={e => setBulkEditValue(e.target.value)} style={{ ...styles.input, cursor: 'pointer' }} autoFocus>
                                    {field.key === 'phase' && <option value=""> None </option>}
                                    {field.options.map(o => <option key={o} value={o}>{o || ' None '}</option>)}
                                </select>
                            )}
                            {field.type === 'boolean' && (
                                <select value={bulkEditValue} onChange={e => setBulkEditValue(e.target.value)} style={{ ...styles.input, cursor: 'pointer' }} autoFocus>
                                    <option value="true">Yes  Mark as Discontinued</option>
                                    <option value="false">No  Mark as Active</option>
                                </select>
                            )}
                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }}>
                                <button style={styles.button('secondary')} onClick={() => setBulkEditField(null)}>Cancel</button>
                                <button style={styles.button('primary')} onClick={applyBulkEdit}>Apply to {selectedIds.size} Items</button>
                            </div>
                        </div>
                    </div>
                );
            })()}
        </div>
    );
}

function PackagesView({ catalogPackages, projectPackages, onUpdateCatalogPackages, onUpdateProjectPackages, catalog, locations, onSyncInstances }) {
    const [selectedPkgId, setSelectedPkgId] = useState(null);
    const [showCreate, setShowCreate] = useState(false);
    const [newName, setNewName] = useState('');
    const [newScope, setNewScope] = useState('catalog');
    const [showAddComponent, setShowAddComponent] = useState(false);
    const [addComponentSearch, setAddComponentSearch] = useState('');
    const [confirmDelete, setConfirmDelete] = useState(null);
    const [editingName, setEditingName] = useState(null);
    const [editNameValue, setEditNameValue] = useState('');
    const [syncPrompt, setSyncPrompt] = useState(null); // { pkgId, pkgName, newVersion, instanceCount }

    // Resizable columns for package detail table
    const PKG_COLUMNS = [
        { id: 'qtyPerPkg', label: 'Qty/Pkg', width: 80 },
        { id: 'manufacturer', label: 'Manufacturer', width: 150 },
        { id: 'model', label: 'Model', width: 180 },
        { id: 'unitCost', label: 'Unit Cost', width: 100 },
        { id: 'labor', label: 'Labor', width: 80 },
        { id: 'ext', label: 'Ext.', width: 90 },
        { id: 'remove', label: '', width: 40, fixed: true },
    ];
    const { columns: pkgCols, startResize: startPkgResize } = useFlexibleColumns(PKG_COLUMNS);

    const allPackages = [...(catalogPackages || []), ...(projectPackages || [])];
    const selectedPkg = allPackages.find(p => p.id === selectedPkgId);
    const selectedScope = selectedPkg ? (selectedPkg.scope === 'project' ? 'project' : 'catalog') : null;

    // Find all instances of selected package across locations
    const instanceCount = selectedPkgId ? findAllPackageInstances(locations || [], selectedPkgId).length : 0;

    const createPackage = () => {
        if (!newName.trim()) return;
        const pkg = {
            id: generatePackageId(),
            name: newName.trim(),
            scope: newScope,
            version: 1,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            items: [],
        };
        if (newScope === 'catalog') {
            onUpdateCatalogPackages(prev => [...prev, pkg]);
        } else {
            onUpdateProjectPackages(prev => ({ ...prev, packages: [...(prev.packages || []), pkg] }));
        }
        setSelectedPkgId(pkg.id);
        setNewName('');
        setShowCreate(false);
    };

    const updatePackage = (pkgId, updater) => {
        const pkg = allPackages.find(p => p.id === pkgId);
        if (!pkg) return;
        const scope = pkg.scope === 'project' ? 'project' : 'catalog';
        if (scope === 'catalog') {
            onUpdateCatalogPackages(prev => prev.map(p => p.id === pkgId ? { ...(typeof updater === 'function' ? updater(p) : updater), updatedAt: new Date().toISOString() } : p));
        } else {
            onUpdateProjectPackages(prev => ({
                ...prev,
                packages: (prev.packages || []).map(p => p.id === pkgId ? { ...(typeof updater === 'function' ? updater(p) : updater), updatedAt: new Date().toISOString() } : p),
            }));
        }
    };

    const deletePackage = (pkgId) => {
        const pkg = allPackages.find(p => p.id === pkgId);
        if (!pkg) return;
        const scope = pkg.scope === 'project' ? 'project' : 'catalog';
        if (scope === 'catalog') {
            onUpdateCatalogPackages(prev => prev.filter(p => p.id !== pkgId));
        } else {
            onUpdateProjectPackages(prev => ({
                ...prev,
                packages: (prev.packages || []).filter(p => p.id !== pkgId),
            }));
        }
        if (selectedPkgId === pkgId) setSelectedPkgId(null);
        setConfirmDelete(null);
    };

    const promoteToCatalog = (pkgId) => {
        const pkg = (projectPackages || []).find(p => p.id === pkgId);
        if (!pkg) return;
        const promoted = { ...pkg, scope: 'catalog', updatedAt: new Date().toISOString() };
        onUpdateCatalogPackages(prev => [...prev, promoted]);
        onUpdateProjectPackages(prev => ({
            ...prev,
            packages: (prev.packages || []).filter(p => p.id !== pkgId),
        }));
    };

    const duplicatePackage = (pkgId) => {
        const pkg = allPackages.find(p => p.id === pkgId);
        if (!pkg) return;
        const newPkg = {
            ...pkg,
            id: generatePackageId(),
            name: pkg.name + ' (Copy)',
            version: 1,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            items: (pkg.items || []).map(item => ({ ...item })),
        };
        const scope = pkg.scope === 'project' ? 'project' : 'catalog';
        if (scope === 'catalog') {
            onUpdateCatalogPackages(prev => [...prev, newPkg]);
        } else {
            onUpdateProjectPackages(prev => ({ ...prev, packages: [...(prev.packages || []), newPkg] }));
        }
        setSelectedPkgId(newPkg.id);
        setEditingName(newPkg.id);
        setEditNameValue(newPkg.name);
    };

    const triggerSyncPrompt = (pkgId) => {
        const pkg = [...(catalogPackages || []), ...(projectPackages || [])].find(p => p.id === pkgId);
        if (!pkg) return;
        const instances = findAllPackageInstances(locations || [], pkgId);
        // Only show prompt if there are existing instances that would be affected
        if (instances.length > 0) {
            setSyncPrompt({ pkgId, pkgName: pkg.name, newVersion: (pkg.version || 1) + 1, instanceCount: instances.length });
        }
    };

    const handleSyncAll = () => {
        if (!syncPrompt || !onSyncInstances) return;
        onSyncInstances(syncPrompt.pkgId, syncPrompt.newVersion);
        setSyncPrompt(null);
    };

    const removeComponent = (pkgId, itemIdx) => {
        triggerSyncPrompt(pkgId);
        updatePackage(pkgId, p => ({
            ...p,
            version: (p.version || 1) + 1,
            items: p.items.filter((_, i) => i !== itemIdx),
        }));
    };

    const updateComponentField = (pkgId, itemIdx, field, value) => {
        updatePackage(pkgId, p => ({
            ...p,
            items: p.items.map((item, i) => i === itemIdx ? { ...item, [field]: value } : item),
        }));
    };

    const addComponentFromCatalog = (catalogItem) => {
        if (!selectedPkgId) return;
        const newItem = {
            manufacturer: catalogItem.manufacturer || '',
            model: catalogItem.model || '',
            partNumber: catalogItem.partNumber || '',
            description: catalogItem.description || '',
            category: catalogItem.category || '',
            subcategory: catalogItem.subcategory || '',
            unitCost: catalogItem.unitCost || 0,
            laborHrsPerUnit: catalogItem.laborHrsPerUnit || 0,
            uom: catalogItem.uom || 'EA',
            vendor: catalogItem.vendor || '',
            qtyPerPackage: 1,
            qty: 1,
        };
        triggerSyncPrompt(selectedPkgId);
        updatePackage(selectedPkgId, p => ({
            ...p,
            version: (p.version || 1) + 1,
            items: [...(p.items || []), newItem],
        }));
        setShowAddComponent(false);
        setAddComponentSearch('');
    };

    const filteredCatalog = addComponentSearch.length >= 2 ? (catalog || []).filter(item => {
        const q = addComponentSearch.toLowerCase();
        return (item.manufacturer || '').toLowerCase().includes(q) ||
            (item.model || '').toLowerCase().includes(q) ||
            (item.partNumber || '').toLowerCase().includes(q) ||
            (item.description || '').toLowerCase().includes(q);
    }).slice(0, 50) : [];

    const startRenamePkg = (pkg) => {
        setEditingName(pkg.id);
        setEditNameValue(pkg.name);
    };

    const finishRename = () => {
        if (editingName && editNameValue.trim()) {
            updatePackage(editingName, p => ({ ...p, name: editNameValue.trim() }));
        }
        setEditingName(null);
        setEditNameValue('');
    };

    const renderPkgList = (pkgs, label, scope) => (
        <div style={{ marginBottom: '16px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 12px', borderBottom: '1px solid #2f3336' }}>
                <span style={{ fontSize: '11px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', color: '#8b98a5' }}>{label}</span>
                <span style={styles.badge(scope === 'catalog' ? 'blue' : 'green')}>{pkgs.length}</span>
            </div>
            {pkgs.map(pkg => {
                const c = styles.pkgColor(pkg.name);
                const cost = (pkg.items || []).reduce((s, i) => s + ((i.qtyPerPackage || i.qty || 1) * (i.unitCost || 0)), 0);
                const isSelected = selectedPkgId === pkg.id;
                return (
                    <div key={pkg.id} onClick={() => setSelectedPkgId(pkg.id)}
                        style={{ padding: '10px 12px', cursor: 'pointer', borderLeft: `3px solid ${isSelected ? c.b : 'transparent'}`, backgroundColor: isSelected ? '#1a1f2e' : 'transparent', display: 'flex', alignItems: 'center', gap: '10px', transition: 'background 0.15s' }}
                        onMouseEnter={e => { if (!isSelected) e.currentTarget.style.backgroundColor = '#161b22'; }}
                        onMouseLeave={e => { if (!isSelected) e.currentTarget.style.backgroundColor = 'transparent'; }}>
                        <span style={{ width: '8px', height: '8px', borderRadius: '2px', backgroundColor: c.b, flexShrink: 0 }} />
                        <div style={{ flex: 1, minWidth: 0 }}>
                            {editingName === pkg.id ? (
                                <input type="text" value={editNameValue} onChange={e => setEditNameValue(e.target.value)} onBlur={finishRename} onKeyDown={e => { if (e.key === 'Enter') finishRename(); if (e.key === 'Escape') { setEditingName(null); setEditNameValue(''); } }} style={{ ...styles.input, padding: '2px 6px', fontSize: '13px', width: '100%' }} autoFocus />
                            ) : (
                                <div style={{ fontSize: '13px', fontWeight: '600', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{pkg.name}</div>
                            )}
                            <div style={{ fontSize: '11px', color: '#6e767d', marginTop: '2px' }}>{(pkg.items || []).length} items  {fmtCost(cost)}</div>
                        </div>
                    </div>
                );
            })}
        </div>
    );

    const pkgCost = selectedPkg ? (selectedPkg.items || []).reduce((s, i) => s + ((i.qtyPerPackage || i.qty || 1) * (i.unitCost || 0)), 0) : 0;
    const pkgLabor = selectedPkg ? (selectedPkg.items || []).reduce((s, i) => s + ((i.qtyPerPackage || i.qty || 1) * (i.laborHrsPerUnit || 0)), 0) : 0;

    return (
        <div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h2 style={{ margin: 0, fontSize: '28px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '12px' }}><Icons.Package /> Packages <span style={styles.badge('green')}>{allPackages.length}</span></h2>
                <button style={styles.button('primary')} onClick={() => setShowCreate(true)}><Icons.Plus /> New Package</button>
            </div>

            {showCreate && (
                <div style={{ ...styles.card, marginBottom: '20px' }}>
                    <h3 style={{ margin: '0 0 12px 0', fontSize: '16px' }}>Create New Package</h3>
                    <div style={{ display: 'flex', gap: '12px', alignItems: 'center', marginBottom: '12px' }}>
                        <input type="text" placeholder="Package name" value={newName} onChange={e => setNewName(e.target.value)} onKeyDown={e => { if (e.key === 'Enter') createPackage(); }} style={{ ...styles.input, flex: 1 }} autoFocus />
                    </div>
                    <div style={{ display: 'flex', gap: '16px', alignItems: 'center', marginBottom: '12px' }}>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', fontSize: '13px' }}>
                            <input type="radio" name="pkg-scope" checked={newScope === 'catalog'} onChange={() => setNewScope('catalog')} /> Catalog (global)
                        </label>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', fontSize: '13px' }}>
                            <input type="radio" name="pkg-scope" checked={newScope === 'project'} onChange={() => setNewScope('project')} /> Project-specific
                        </label>
                    </div>
                    <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                        <button style={styles.button('secondary')} onClick={() => { setShowCreate(false); setNewName(''); }}>Cancel</button>
                        <button style={styles.button('primary')} onClick={createPackage} disabled={!newName.trim()}>Create</button>
                    </div>
                </div>
            )}

            <div style={{ display: 'flex', gap: '0', border: '1px solid #2f3336', borderRadius: '12px', overflow: 'hidden', minHeight: '500px', backgroundColor: '#0d1117' }}>
                {/* Left panel: Package list */}
                <div style={{ width: '260px', borderRight: '1px solid #2f3336', overflowY: 'auto', flexShrink: 0 }}>
                    {(catalogPackages || []).length === 0 && (projectPackages || []).length === 0 ? (
                        <div style={{ padding: '40px 20px', textAlign: 'center', color: '#6e767d' }}>
                            <div style={{ fontSize: '36px', marginBottom: '12px' }}></div>
                            <div style={{ fontSize: '13px' }}>No packages yet</div>
                            <div style={{ fontSize: '12px', marginTop: '4px' }}>Click "New Package" to get started</div>
                        </div>
                    ) : (
                        <>
                            {(catalogPackages || []).length > 0 && renderPkgList(catalogPackages, 'Catalog Packages', 'catalog')}
                            {(projectPackages || []).length > 0 && renderPkgList(projectPackages, 'Project Packages', 'project')}
                        </>
                    )}
                </div>

                {/* Right panel: Package detail */}
                <div style={{ flex: 1, overflowY: 'auto', padding: '20px' }}>
                    {!selectedPkg ? (
                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', color: '#6e767d' }}>
                            <Icons.Package />
                            <div style={{ fontSize: '14px', marginTop: '12px' }}>Select a package to view details</div>
                        </div>
                    ) : (
                        <div>
                            {/* Header */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '20px' }}>
                                <div>
                                    <h3 style={{ margin: '0 0 6px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <span style={{ width: '12px', height: '12px', borderRadius: '3px', backgroundColor: styles.pkgColor(selectedPkg.name).b }} />
                                        {selectedPkg.name}
                                    </h3>
                                    <div style={{ display: 'flex', gap: '12px', fontSize: '12px', color: '#8b98a5' }}>
                                        <span style={styles.badge(selectedScope === 'catalog' ? 'blue' : 'green')}>{selectedScope === 'catalog' ? 'Catalog' : 'Project'}</span>
                                        <span>v{selectedPkg.version || 1}</span>
                                        <span>Used in {instanceCount} location{instanceCount !== 1 ? 's' : ''}</span>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button style={styles.button('secondary')} onClick={() => startRenamePkg(selectedPkg)} title="Rename"><Icons.Edit /></button>
                                    <button style={styles.button('secondary')} onClick={() => duplicatePackage(selectedPkg.id)} title="Duplicate package"><Icons.Copy /></button>
                                    {selectedScope === 'project' && (
                                        <button style={{ ...styles.button('secondary'), fontSize: '11px' }} onClick={() => promoteToCatalog(selectedPkg.id)} title="Promote to catalog package">
                                            Promote to Catalog
                                        </button>
                                    )}
                                    <button style={{ ...styles.button('secondary'), color: '#f87171', borderColor: '#f8717140' }} onClick={() => setConfirmDelete(selectedPkg.id)} title="Delete package"><Icons.Trash /></button>
                                </div>
                            </div>

                            {/* Stats bar */}
                            <div style={{ display: 'flex', gap: '20px', padding: '12px 16px', backgroundColor: '#161b22', borderRadius: '8px', marginBottom: '16px', fontSize: '13px' }}>
                                <div><span style={{ color: '#8b98a5' }}>Components: </span><strong>{(selectedPkg.items || []).length}</strong></div>
                                <div><span style={{ color: '#8b98a5' }}>Unit Cost: </span><strong style={{ color: '#00ba7c' }}>{fmtCost(pkgCost)}</strong></div>
                                <div><span style={{ color: '#8b98a5' }}>Labor: </span><strong>{pkgLabor.toFixed(1)} hrs</strong></div>
                            </div>

                            {/* Components table */}
                            {(selectedPkg.items || []).length > 0 && (
                                <div style={{ overflowX: 'auto', marginBottom: '16px' }}>
                                    <table style={{ ...styles.table, tableLayout: 'fixed', width: pkgCols.reduce((s, c) => s + c.width, 0) + 'px' }}>
                                        <thead>
                                            <tr>
                                                {pkgCols.map((col, colIndex) => (
                                                    <th key={col.id} style={{ ...styles.th, width: col.width + 'px', position: 'relative' }}>
                                                        {col.label}
                                                        {!col.fixed && (
                                                            <div
                                                                style={styles.resizeHandle}
                                                                onMouseDown={e => startPkgResize(colIndex, e)}
                                                                onMouseEnter={e => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.backgroundColor = '#1d9bf0'; }}
                                                                onMouseLeave={e => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.backgroundColor = '#4a5568'; }}
                                                            />
                                                        )}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {selectedPkg.items.map((item, i) => {
                                                const qpp = item.qtyPerPackage || item.qty || 1;
                                                const ext = qpp * (item.unitCost || 0);
                                                return (
                                                    <tr key={i}>
                                                        {pkgCols.map(col => {
                                                            if (col.id === 'qtyPerPkg') return <td key={col.id} style={styles.td}><input type="number" min="1" value={qpp} onChange={e => updateComponentField(selectedPkg.id, i, 'qtyPerPackage', Math.max(1, parseInt(e.target.value) || 1))} onFocus={e => e.target.select()} style={{ ...styles.inputSmall, width: '100%', boxSizing: 'border-box' }} /></td>;
                                                            if (col.id === 'manufacturer') return <td key={col.id} style={styles.td}>{item.manufacturer}</td>;
                                                            if (col.id === 'model') return <td key={col.id} style={{ ...styles.td, fontWeight: '600' }}>{item.model}</td>;
                                                            if (col.id === 'unitCost') return <td key={col.id} style={styles.td}><input type="number" min="0" step="0.01" value={item.unitCost || 0} onChange={e => updateComponentField(selectedPkg.id, i, 'unitCost', parseFloat(e.target.value) || 0)} onFocus={e => e.target.select()} style={{ ...styles.inputSmall, width: '100%', boxSizing: 'border-box' }} /></td>;
                                                            if (col.id === 'labor') return <td key={col.id} style={styles.td}><input type="number" min="0" step="0.1" value={item.laborHrsPerUnit || 0} onChange={e => updateComponentField(selectedPkg.id, i, 'laborHrsPerUnit', parseFloat(e.target.value) || 0)} onFocus={e => e.target.select()} style={{ ...styles.inputSmall, width: '100%', boxSizing: 'border-box' }} /></td>;
                                                            if (col.id === 'ext') return <td key={col.id} style={{ ...styles.td, color: '#00ba7c', fontWeight: '600' }}>{fmtCost(ext)}</td>;
                                                            if (col.id === 'remove') return <td key={col.id} style={styles.td}><button style={{ background: 'none', border: 'none', color: '#f87171', cursor: 'pointer', padding: '2px 6px', borderRadius: '4px', fontSize: '13px' }} onClick={() => removeComponent(selectedPkg.id, i)} title="Remove component"></button></td>;
                                                            return null;
                                                        })}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {/* Add Component */}
                            {showAddComponent ? (
                                <div style={{ ...styles.card, padding: '16px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                        <h4 style={{ margin: 0, fontSize: '14px' }}>Add Component from Catalog</h4>
                                        <button style={{ background: 'none', border: 'none', color: '#8b98a5', cursor: 'pointer', fontSize: '18px' }} onClick={() => { setShowAddComponent(false); setAddComponentSearch(''); }}></button>
                                    </div>
                                    <input type="text" placeholder="Search catalog by name, model, or part number..." value={addComponentSearch} onChange={e => setAddComponentSearch(e.target.value)} style={{ ...styles.input, marginBottom: '8px' }} autoFocus />
                                    {addComponentSearch.length >= 2 && (
                                        <div style={{ maxHeight: '250px', overflowY: 'auto', border: '1px solid #2f3336', borderRadius: '8px' }}>
                                            {filteredCatalog.length === 0 ? (
                                                <div style={{ padding: '16px', textAlign: 'center', color: '#6e767d', fontSize: '13px' }}>No results</div>
                                            ) : filteredCatalog.map((item, i) => (
                                                <div key={i} onClick={() => addComponentFromCatalog(item)} style={{ padding: '8px 12px', cursor: 'pointer', borderBottom: '1px solid #2f3336', display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '13px' }}
                                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#161b22'}
                                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                                                    <div>
                                                        <span style={{ color: '#8b98a5' }}>{item.manufacturer}</span>{' '}
                                                        <strong>{item.model}</strong>
                                                        {item.partNumber && <span style={{ color: '#6e767d', marginLeft: '8px', fontSize: '11px' }}>{item.partNumber}</span>}
                                                    </div>
                                                    <span style={{ color: '#00ba7c', fontWeight: '600' }}>{fmtCost(item.unitCost || 0)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <button style={styles.button('secondary')} onClick={() => setShowAddComponent(true)}>
                                    <Icons.Plus /> Add Component
                                </button>
                            )}

                            {/* Delete confirmation */}
                            {confirmDelete === selectedPkg.id && (
                                <div style={{ ...styles.card, marginTop: '16px', borderColor: '#f8717140', padding: '16px' }}>
                                    <div style={{ marginBottom: '12px', fontSize: '14px' }}>
                                        Delete <strong>{selectedPkg.name}</strong>?
                                        {instanceCount > 0 && <span style={{ color: '#f59e0b' }}> This package is used in {instanceCount} location{instanceCount !== 1 ? 's' : ''}. Those instances will show as "missing".</span>}
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                        <button style={styles.button('secondary')} onClick={() => setConfirmDelete(null)}>Cancel</button>
                                        <button style={{ ...styles.button('primary'), backgroundColor: '#f87171' }} onClick={() => deletePackage(selectedPkg.id)}>Delete</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>

            {/* Sync Prompt Modal */}
            {syncPrompt && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setSyncPrompt(null)}>
                    <div style={{ ...styles.card, maxWidth: '440px', width: '90%', padding: '24px' }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ margin: '0 0 12px 0', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icons.Package /> Update Package Instances?
                        </h3>
                        <p style={{ margin: '0 0 16px 0', color: '#8b98a5', fontSize: '14px', lineHeight: '1.5' }}>
                            You've modified <strong style={{ color: '#e7e9ea' }}>{syncPrompt.pkgName}</strong>.
                            There {syncPrompt.instanceCount === 1 ? 'is' : 'are'} <strong style={{ color: '#e7e9ea' }}>{syncPrompt.instanceCount}</strong> instance{syncPrompt.instanceCount !== 1 ? 's' : ''} of this package across your project locations.
                        </p>
                        <p style={{ margin: '0 0 20px 0', color: '#8b98a5', fontSize: '13px' }}>
                            Update all instances to use the new definition (v{syncPrompt.newVersion}), or skip to leave them on the previous version.
                        </p>
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                            <button style={styles.button('secondary')} onClick={() => setSyncPrompt(null)}>Skip</button>
                            <button style={styles.button('primary')} onClick={handleSyncAll}>Update All Instances</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// All Locations View - shows all locations with items in a unified workspace
function AllLocationsView({
    locations,
    onUpdate,
    onSearch,
    clipboard,
    onCopy,
    onPaste,
    onSavePackage,
    catalog,
    onAddAccessoryToItem,
    onConvertToAccessory,
    onUngroupPackage,
    onMoveToPackage,
    expandedLocations,
    onToggleLocationExpand,
    onExpandAllLocations,
    onCollapseAllLocations,
    compactMode,
    onAddToCatalog,
    catalogPkgs,
    projectPkgs
}) {
    const [selectedItems, setSelectedItems] = useState({}); // { locationId: [indices] }
    const [expandedItems, setExpandedItems] = useState({}); // { locationId: { itemIdx: bool } }
    const [expandedPackages, setExpandedPackages] = useState({}); // { locationId: { pkgName: bool } }
    const [contextMenu, setContextMenu] = useState(null);

    // Resizable columns
    const ALL_LOC_COLUMNS = [
        { id: 'checkbox', label: '', width: 40, fixed: true },
        { id: 'expand', label: '', width: 30, fixed: true },
        { id: 'qty', label: 'Qty', width: 75 },
        { id: 'notes', label: 'Notes', width: 120 },
        { id: 'system', label: 'System', width: 100 },
        { id: 'manufacturer', label: 'Manufacturer', width: 120 },
        { id: 'model', label: 'Model', width: 140 },
        { id: 'description', label: 'Description', width: 200 },
        { id: 'unitCost', label: 'Unit $', width: 80 },
        { id: 'unitLabor', label: 'Unit Hrs', width: 70 },
        { id: 'extCost', label: 'Ext. $', width: 90 },
        { id: 'extLabor', label: 'Ext. Hrs', width: 80 },
    ];
    const { columns: allLocCols, startResize: startAllLocResize } = useFlexibleColumns(ALL_LOC_COLUMNS);

    // Compact mode styles
    const compactStyles = {
        td: compactMode ? { padding: '4px 8px', fontSize: '11px' } : {},
        th: compactMode ? { padding: '6px 8px', fontSize: '10px' } : {},
        input: compactMode ? { padding: '2px 6px', fontSize: '11px' } : {},
    };

    // Combined styles for easy use
    const tdStyle = { ...styles.td, ...compactStyles.td };
    const thStyle = { ...styles.th, ...compactStyles.th };
    const inputStyle = { ...styles.inputSmall, ...compactStyles.input };
    
    // Get only locations that have items directly in them (not empty parent folders)
    const allLocations = useMemo(() => getLocationsWithItems(locations), [locations]);
    
    // Calculate item totals
    const calculateItemTotal = (item) => {
        let cost = (item.qty || 0) * (item.unitCost || 0);
        let labor = (item.qty || 0) * (item.laborHrsPerUnit || 0);
        if (item.accessories) {
            item.accessories.forEach(acc => {
                cost += (acc.qty || 0) * (acc.unitCost || 0);
                labor += (acc.qty || 0) * (acc.laborHrsPerUnit || 0);
            });
        }
        return { cost, labor };
    };
    
    // Group items by package for a location
    const getGroupedItems = (location) => {
        const items = location.items || [];
        const packageInstances = [];
        const legacyPackages = {};
        const standalone = [];

        items.forEach((item, idx) => {
            if (item.type === 'package') {
                const resolved = resolvePackageInstance(item, catalogPkgs, projectPkgs);
                packageInstances.push({
                    instance: item, idx, resolved, name: item.packageName, qty: item.qty || 1,
                    isOutOfDate: resolved?.isOutOfDate || false, isMissing: resolved?.isMissing || false,
                    cost: resolved?.totalCost || 0, labor: resolved?.totalLabor || 0,
                    itemCount: resolved?.expandedItems?.length || 0, expandedItems: resolved?.expandedItems || [],
                });
            } else if (item.packageName) {
                if (!legacyPackages[item.packageName]) {
                    legacyPackages[item.packageName] = { name: item.packageName, items: [], indices: [] };
                }
                legacyPackages[item.packageName].items.push(item);
                legacyPackages[item.packageName].indices.push(idx);
            } else {
                standalone.push({ item, idx });
            }
        });

        // Calculate legacy package totals
        const legacyPkgList = Object.values(legacyPackages).map(pkg => {
            let cost = 0, labor = 0;
            pkg.items.forEach(item => { const t = calculateItemTotal(item); cost += t.cost; labor += t.labor; });
            const itemCount = pkg.items.reduce((count, item) => count + 1 + (item.accessories?.length || 0), 0);
            return { ...pkg, cost, labor, itemCount };
        });

        return { packages: packageInstances, legacyPackages: legacyPkgList, standalone };
    };
    
    // Change handlers
    const changeQty = (locationId, itemIdx, q) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            const newQty = Math.max(0, parseInt(q) || 0);
            const oldQty = newItems[itemIdx].qty || 1;
            newItems[itemIdx] = { ...newItems[itemIdx], qty: newQty };
            if (newItems[itemIdx].accessories) {
                const ratio = newQty / oldQty;
                newItems[itemIdx].accessories = newItems[itemIdx].accessories.map(acc => ({
                    ...acc,
                    qty: Math.round((acc.qty || 0) * ratio) || acc.qtyPer || 1
                }));
            }
            return newItems;
        });
    };
    
    const changeNotes = (locationId, itemIdx, notes) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = { ...newItems[itemIdx], notes };
            return newItems;
        });
    };

    const changeSystem = (locationId, itemIdx, system) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = { ...newItems[itemIdx], system };
            return newItems;
        });
    };

    const changeAccessoryQty = (locationId, itemIdx, accIdx, q) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = {
                ...newItems[itemIdx],
                accessories: newItems[itemIdx].accessories.map((a, i) => i === accIdx ? { ...a, qty: Math.max(0, parseInt(q) || 0) } : a)
            };
            return newItems;
        });
    };
    
    const changeAccessoryNotes = (locationId, itemIdx, accIdx, notes) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = {
                ...newItems[itemIdx],
                accessories: newItems[itemIdx].accessories.map((a, i) => i === accIdx ? { ...a, notes } : a)
            };
            return newItems;
        });
    };
    
    const removeAccessory = (locationId, itemIdx, accIdx) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = {
                ...newItems[itemIdx],
                accessories: newItems[itemIdx].accessories.filter((_, i) => i !== accIdx)
            };
            return newItems;
        });
    };

    // Local editing state for unit cost / labor inputs (prevents re-render loop)
    const [editingCost, setEditingCost] = useState({});
    const [editingLabor, setEditingLabor] = useState({});

    const focusUnitCost = (locationId, itemIdx, currentVal) => {
        setEditingCost(prev => ({ ...prev, [`${locationId}-${itemIdx}`]: String(currentVal || 0) }));
    };
    const changeUnitCost = (locationId, itemIdx, val) => {
        setEditingCost(prev => ({ ...prev, [`${locationId}-${itemIdx}`]: val }));
    };
    const blurUnitCost = (locationId, itemIdx) => {
        const key = `${locationId}-${itemIdx}`;
        const val = parseFloat(editingCost[key]) || 0;
        setEditingCost(prev => { const n = { ...prev }; delete n[key]; return n; });
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = { ...newItems[itemIdx], unitCost: val };
            return newItems;
        });
    };

    const focusUnitLabor = (locationId, itemIdx, currentVal) => {
        setEditingLabor(prev => ({ ...prev, [`${locationId}-${itemIdx}`]: String(currentVal || 0) }));
    };
    const changeUnitLabor = (locationId, itemIdx, val) => {
        setEditingLabor(prev => ({ ...prev, [`${locationId}-${itemIdx}`]: val }));
    };
    const blurUnitLabor = (locationId, itemIdx) => {
        const key = `${locationId}-${itemIdx}`;
        const val = parseFloat(editingLabor[key]) || 0;
        setEditingLabor(prev => { const n = { ...prev }; delete n[key]; return n; });
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = { ...newItems[itemIdx], laborHrsPerUnit: val };
            return newItems;
        });
    };

    // Accessory cost/labor editing
    const [editingAccCost, setEditingAccCost] = useState({});
    const [editingAccLabor, setEditingAccLabor] = useState({});

    const focusAccCost = (locationId, itemIdx, accIdx, currentVal) => {
        setEditingAccCost(prev => ({ ...prev, [`${locationId}-${itemIdx}-${accIdx}`]: String(currentVal || 0) }));
    };
    const changeAccCost = (locationId, itemIdx, accIdx, val) => {
        setEditingAccCost(prev => ({ ...prev, [`${locationId}-${itemIdx}-${accIdx}`]: val }));
    };
    const blurAccCost = (locationId, itemIdx, accIdx) => {
        const key = `${locationId}-${itemIdx}-${accIdx}`;
        const val = parseFloat(editingAccCost[key]) || 0;
        setEditingAccCost(prev => { const n = { ...prev }; delete n[key]; return n; });
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = { ...newItems[itemIdx], accessories: newItems[itemIdx].accessories.map((a, ai) => ai === accIdx ? { ...a, unitCost: val } : a) };
            return newItems;
        });
    };

    const focusAccLabor = (locationId, itemIdx, accIdx, currentVal) => {
        setEditingAccLabor(prev => ({ ...prev, [`${locationId}-${itemIdx}-${accIdx}`]: String(currentVal || 0) }));
    };
    const changeAccLabor = (locationId, itemIdx, accIdx, val) => {
        setEditingAccLabor(prev => ({ ...prev, [`${locationId}-${itemIdx}-${accIdx}`]: val }));
    };
    const blurAccLabor = (locationId, itemIdx, accIdx) => {
        const key = `${locationId}-${itemIdx}-${accIdx}`;
        const val = parseFloat(editingAccLabor[key]) || 0;
        setEditingAccLabor(prev => { const n = { ...prev }; delete n[key]; return n; });
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            newItems[itemIdx] = { ...newItems[itemIdx], accessories: newItems[itemIdx].accessories.map((a, ai) => ai === accIdx ? { ...a, laborHrsPerUnit: val } : a) };
            return newItems;
        });
    };

    const removeItem = (locationId, itemIdx) => {
        onUpdate(locationId, (items) => items.filter((_, i) => i !== itemIdx));
        setSelectedItems(prev => ({ ...prev, [locationId]: (prev[locationId] || []).filter(i => i !== itemIdx) }));
    };
    
    const promoteAccessoryToItem = (locationId, itemIdx, accIdx) => {
        onUpdate(locationId, (items) => {
            const newItems = [...items];
            const parentItem = newItems[itemIdx];
            const accessory = parentItem.accessories[accIdx];
            
            // Create new standalone item from accessory
            const newItem = {
                ...accessory,
                accessories: [],
                packageName: parentItem.packageName, // Keep in same package if applicable
            };
            
            // Remove accessory from parent
            newItems[itemIdx] = {
                ...parentItem,
                accessories: parentItem.accessories.filter((_, i) => i !== accIdx)
            };
            
            // Insert new item after parent
            newItems.splice(itemIdx + 1, 0, newItem);
            return newItems;
        });
    };
    
    // Selection handlers
    const lastClickedRef = useRef({ locationId: null, idx: null });
    const toggleSelect = (locationId, idx, e) => {
        if (e && e.shiftKey && lastClickedRef.current.locationId === locationId && lastClickedRef.current.idx !== null) {
            // Shift+Click: select range within same location
            const start = Math.min(lastClickedRef.current.idx, idx);
            const end = Math.max(lastClickedRef.current.idx, idx);
            const range = [];
            for (let i = start; i <= end; i++) range.push(i);
            setSelectedItems(prev => {
                const current = prev[locationId] || [];
                const combined = new Set([...current, ...range]);
                return { ...prev, [locationId]: [...combined] };
            });
        } else {
            setSelectedItems(prev => {
                const current = prev[locationId] || [];
                return {
                    ...prev,
                    [locationId]: current.includes(idx) ? current.filter(i => i !== idx) : [...current, idx]
                };
            });
        }
        lastClickedRef.current = { locationId, idx };
    };
    
    const selectAllInLocation = (locationId, itemCount) => {
        setSelectedItems(prev => {
            const current = prev[locationId] || [];
            if (current.length === itemCount) {
                return { ...prev, [locationId]: [] };
            }
            return { ...prev, [locationId]: Array.from({ length: itemCount }, (_, i) => i) };
        });
    };
    
    // Expand/collapse handlers
    const toggleItemExpand = (locationId, idx) => {
        setExpandedItems(prev => ({
            ...prev,
            [locationId]: { ...(prev[locationId] || {}), [idx]: !(prev[locationId]?.[idx] ?? true) }
        }));
    };
    
    const togglePackageExpand = (locationId, pkgName) => {
        setExpandedPackages(prev => ({
            ...prev,
            [locationId]: { ...(prev[locationId] || {}), [pkgName]: !(prev[locationId]?.[pkgName] ?? true) }
        }));
    };
    
    // Copy/paste handlers
    const handleCopy = (locationId) => {
        const loc = allLocations.find(l => l.id === locationId);
        if (!loc) return;
        const indices = selectedItems[locationId] || [];
        onCopy(indices.map(idx => ({ ...loc.items[idx] })));
    };
    
    const handlePaste = (locationId) => {
        onPaste(locationId);
        setSelectedItems(prev => ({ ...prev, [locationId]: [] }));
    };
    
    const handleSavePackage = (locationId) => {
        const loc = allLocations.find(l => l.id === locationId);
        if (!loc) return;
        const indices = selectedItems[locationId] || [];
        if (indices.length > 0) {
            onSavePackage(indices.map(idx => ({ ...loc.items[idx] })), indices, locationId);
        }
    };
    
    // Context menu
    const handleContextMenu = (e, locationId, itemIdx, isAccessory = false, accIdx = null) => {
        e.preventDefault();
        setContextMenu({ x: e.clientX, y: e.clientY, locationId, itemIdx, isAccessory, accIdx });
    };
    
    // Close context menu on click outside
    useEffect(() => {
        const handleClick = () => setContextMenu(null);
        if (contextMenu) window.addEventListener('click', handleClick);
        return () => window.removeEventListener('click', handleClick);
    }, [contextMenu]);
    
    // Get total selected count
    const totalSelected = Object.values(selectedItems).reduce((sum, arr) => sum + arr.length, 0);
    
    if (allLocations.length === 0) {
        return (
            <div style={styles.emptyState}>
                <div style={{ fontSize: '64px', marginBottom: '16px' }}></div>
                <h3 style={{ color: '#8b98a5', fontSize: '20px' }}>No locations created yet</h3>
                <p style={{ margin: '0', maxWidth: '400px' }}>Create locations in the sidebar to get started.</p>
            </div>
        );
    }
    
    return (
        <div style={{ padding: '24px' }}>
            {/* Header */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '20px' }}>
                <h2 style={{ margin: 0, fontSize: '24px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <Icons.Layers /> All Locations
                    <span style={{ ...styles.badge('blue'), fontSize: '12px' }}>{allLocations.length} locations</span>
                </h2>
                <div style={{ display: 'flex', gap: '8px' }}>
                    {clipboard.length > 0 && (
                        <span style={{ ...styles.badge('green'), padding: '6px 12px' }}>
                            <Icons.Clipboard /> {clipboard.length} copied
                        </span>
                    )}
                    <button style={styles.smallButton} onClick={onExpandAllLocations} title="Expand all locations">
                        <Icons.ChevronsDown /> Expand All
                    </button>
                    <button style={styles.smallButton} onClick={onCollapseAllLocations} title="Collapse all locations">
                        <Icons.ChevronsUp /> Collapse All
                    </button>
                </div>
            </div>
            
            {/* Location sections */}
            {allLocations.map(location => {
                const isExpanded = expandedLocations[location.id] !== false;
                const groupedItems = getGroupedItems(location);
                const totals = calculateTotals(location, catalogPkgs, projectPkgs);
                const locationSelected = selectedItems[location.id] || [];
                const mainItemCount = (location.items || []).length;
                
                return (
                    <div key={location.id} style={{ marginBottom: compactMode ? '8px' : '16px', backgroundColor: '#161b22', borderRadius: compactMode ? '8px' : '12px', border: '1px solid #30363d', overflow: 'hidden' }}>
                        {/* Location header */}
                        <div 
                            style={{ 
                                padding: compactMode ? '8px 12px' : '16px 20px', 
                                backgroundColor: '#1c2128', 
                                borderBottom: isExpanded ? '1px solid #30363d' : 'none',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: compactMode ? '8px' : '12px'
                            }}
                            onClick={() => onToggleLocationExpand(location.id)}
                        >
                            <button style={{ ...styles.iconButton, padding: compactMode ? '2px' : '4px' }}>
                                {isExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                            </button>
                            <Icons.Location />
                            <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ fontWeight: '600', fontSize: compactMode ? '13px' : '15px', display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                                    {location.name}
                                    {compactMode && location.path !== location.name && (
                                        <span style={{ fontSize: '11px', color: '#6e767d', fontWeight: '400' }}>{location.path}</span>
                                    )}
                                </div>
                                {!compactMode && location.path !== location.name && (
                                    <div style={{ fontSize: '12px', color: '#6e767d', marginTop: '2px' }}>{location.path}</div>
                                )}
                            </div>
                            <div style={{ display: 'flex', gap: compactMode ? '10px' : '16px', alignItems: 'center', flexShrink: 0 }}>
                                <span style={{ ...styles.badge('blue'), fontSize: compactMode ? '10px' : '11px', padding: compactMode ? '2px 6px' : '3px 10px' }}>{totals.itemCount} items</span>
                                <span style={{ color: '#00ba7c', fontWeight: '600', fontSize: compactMode ? '12px' : '14px' }}>{fmtCost(totals.cost)}</span>
                                <span style={{ color: '#8b98a5', fontSize: compactMode ? '11px' : '13px' }}>{fmtHrs(totals.labor)}</span>
                            </div>
                        </div>
                        
                        {/* Location content */}
                        {isExpanded && (
                            <div style={{ padding: compactMode ? '8px' : '16px' }}>
                                {/* Toolbar */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: compactMode ? '6px' : '12px', flexWrap: 'wrap' }}>
                                    {locationSelected.length > 0 && (
                                        <>
                                            <span style={{ fontSize: compactMode ? '11px' : '13px', color: '#8b98a5' }}>{locationSelected.length} selected</span>
                                            <button style={{ ...styles.smallButton, backgroundColor: '#1d2d3d', color: '#58a6ff', padding: compactMode ? '4px 8px' : undefined, fontSize: compactMode ? '11px' : undefined }} onClick={() => handleCopy(location.id)}>
                                                <Icons.Copy /> Copy
                                            </button>
                                            <button style={{ ...styles.smallButton, backgroundColor: '#1a3d2e', color: '#00ba7c', padding: compactMode ? '4px 8px' : undefined, fontSize: compactMode ? '11px' : undefined }} onClick={() => handleSavePackage(location.id)}>
                                                <Icons.Package /> Save as Package
                                            </button>
                                        </>
                                    )}
                                    {clipboard.length > 0 && (
                                        <button style={{ ...styles.smallButton, backgroundColor: '#1a3d2e', color: '#00ba7c', padding: compactMode ? '4px 8px' : undefined, fontSize: compactMode ? '11px' : undefined }} onClick={() => handlePaste(location.id)}>
                                            <Icons.Clipboard /> Paste ({clipboard.length})
                                        </button>
                                    )}
                                    <button style={{ ...styles.smallButton, marginLeft: 'auto', padding: compactMode ? '4px 8px' : undefined, fontSize: compactMode ? '11px' : undefined }} onClick={() => onSearch(location.id)}>
                                        <Icons.Plus /> Add Component
                                    </button>
                                </div>
                                
                                {/* Items table */}
                                <div style={{ overflowX: 'auto' }}>
                                    <table style={styles.table}>
                                        <thead>
                                            <tr>
                                                {allLocCols.map((col, colIndex) => (
                                                    <th key={col.id} style={{ ...thStyle, ...styles.thResizable, width: col.width + 'px' }}>
                                                        {col.id === 'checkbox' ? (
                                                            <input
                                                                type="checkbox"
                                                                checked={locationSelected.length === mainItemCount && mainItemCount > 0}
                                                                onChange={() => selectAllInLocation(location.id, mainItemCount)}
                                                            />
                                                        ) : col.label}
                                                        {!col.fixed && (
                                                            <div
                                                                style={styles.resizeHandle}
                                                                onMouseDown={e => startAllLocResize(colIndex, e)}
                                                                onMouseEnter={e => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.backgroundColor = '#1d9bf0'; }}
                                                                onMouseLeave={e => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.backgroundColor = '#4a5568'; }}
                                                            />
                                                        )}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {/* Package instances (new format) */}
                                            {groupedItems.packages.map(pkg => {
                                                const pkgColor = styles.pkgColor(pkg.name);
                                                const isPkgExpanded = expandedPackages[location.id]?.[pkg.name] !== false;
                                                const isSelected = locationSelected.includes(pkg.idx);

                                                const changePkgQty = (val) => {
                                                    onUpdate(location.id, items => {
                                                        const newItems = [...items];
                                                        newItems[pkg.idx] = { ...newItems[pkg.idx], qty: Math.max(1, parseInt(val) || 1) };
                                                        return newItems;
                                                    });
                                                };

                                                return (
                                                    <React.Fragment key={`pkg-${pkg.idx}`}>
                                                        <tr style={{ backgroundColor: pkgColor.bg, borderLeft: `4px solid ${pkgColor.b}` }}>
                                                            <td style={tdStyle}><input type="checkbox" checked={isSelected} onChange={e => toggleSelect(location.id, pkg.idx, e)} /></td>
                                                            <td style={tdStyle}><button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => togglePackageExpand(location.id, pkg.name)}>{isPkgExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</button></td>
                                                            <td style={tdStyle}><input type="number" value={pkg.qty} onChange={e => changePkgQty(e.target.value)} onFocus={e => e.target.select()} style={{ ...inputStyle, width: '60px', fontWeight: '700' }} min="1" /></td>
                                                            <td style={tdStyle}></td>
                                                            <td style={tdStyle}></td>
                                                            <td style={{ ...tdStyle, fontWeight: '700' }}><Icons.Package /> <span style={{ color: pkgColor.b }}>{pkg.name}</span> {pkg.isOutOfDate && <span style={{ color: '#f59e0b', fontSize: '11px' }}></span>}</td>
                                                            <td style={tdStyle}><span style={{ ...styles.badge('green'), fontSize: '10px' }}>{pkg.itemCount} items  {pkg.qty}</span></td>
                                                            <td style={tdStyle}>{pkg.instance.notes || ''}</td>
                                                            <td style={tdStyle}></td>
                                                            <td style={tdStyle}></td>
                                                            <td style={{ ...tdStyle, color: '#00ba7c', fontWeight: '600' }}>{fmtCost(pkg.cost)}</td>
                                                            <td style={tdStyle}>{fmtHrs(pkg.labor)}</td>
                                                        </tr>
                                                        {isPkgExpanded && pkg.expandedItems.map((item, itemIdx) => (
                                                            <tr key={`pkg-item-${pkg.idx}-${itemIdx}`} style={{ backgroundColor: '#0d1117', borderLeft: `3px solid ${pkgColor.b}` }}>
                                                                <td style={tdStyle}></td>
                                                                <td style={tdStyle}></td>
                                                                <td style={{ ...tdStyle, color: '#8b98a5', fontSize: '12px' }}>{fmtQty(item.qty)}</td>
                                                                <td style={{ ...tdStyle, fontSize: '10px', color: '#6e767d' }}>{(item.qtyPerPackage || 1)}{pkg.qty}</td>
                                                                <td style={tdStyle}></td>
                                                                <td style={{ ...tdStyle, fontSize: '12px', color: '#8b98a5' }}> {item.manufacturer}</td>
                                                                <td style={{ ...tdStyle, color: '#1d9bf0', fontSize: '12px' }}>{item.model}</td>
                                                                <td style={{ ...tdStyle, fontSize: '12px', color: '#8b98a5' }}>{item.description}</td>
                                                                <td style={{ ...tdStyle, fontSize: '12px', color: '#6e767d' }}>{fmtCost(item.unitCost || 0)}</td>
                                                                <td style={{ ...tdStyle, fontSize: '12px', color: '#6e767d' }}>{fmtHrs(item.laborHrsPerUnit || 0)}</td>
                                                                <td style={{ ...tdStyle, fontSize: '12px', color: '#00ba7c' }}>{fmtCost((item.qty || 0) * (item.unitCost || 0))}</td>
                                                                <td style={{ ...tdStyle, fontSize: '12px', color: '#6e767d' }}>{fmtHrs((item.qty || 0) * (item.laborHrsPerUnit || 0))}</td>
                                                            </tr>
                                                        ))}
                                                    </React.Fragment>
                                                );
                                            })}

                                            {/* Legacy packages (old format) */}
                                            {groupedItems.legacyPackages.map(pkg => {
                                                const pkgColor = styles.pkgColor(pkg.name);
                                                const isPkgExpanded = expandedPackages[location.id]?.[pkg.name] !== false;
                                                return (
                                                    <React.Fragment key={`legacy-${pkg.name}`}>
                                                        <tr style={{ backgroundColor: pkgColor.bg, borderLeft: `4px solid ${pkgColor.b}` }}>
                                                            <td style={tdStyle}><input type="checkbox" checked={pkg.indices.every(idx => locationSelected.includes(idx))} onChange={() => {
                                                                const allSelected = pkg.indices.every(idx => locationSelected.includes(idx));
                                                                setSelectedItems(prev => ({ ...prev, [location.id]: allSelected ? (prev[location.id] || []).filter(i => !pkg.indices.includes(i)) : [...new Set([...(prev[location.id] || []), ...pkg.indices])] }));
                                                            }} /></td>
                                                            <td style={tdStyle}><button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => togglePackageExpand(location.id, pkg.name)}>{isPkgExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</button></td>
                                                            <td colSpan="5" style={{ ...tdStyle, fontWeight: '700' }}><Icons.Package /> <span style={{ color: pkgColor.b }}>{pkg.name}</span> <span style={{ fontSize: '10px', color: '#6e767d' }}>(legacy)</span></td>
                                                            <td style={tdStyle}></td>
                                                            <td style={tdStyle}></td>
                                                            <td style={tdStyle}></td>
                                                            <td style={{ ...tdStyle, color: '#00ba7c', fontWeight: '600' }}>{fmtCost(pkg.cost)}</td>
                                                            <td style={tdStyle}>{fmtHrs(pkg.labor)}</td>
                                                        </tr>
                                                        {isPkgExpanded && pkg.items.map((item, pkgItemIdx) => {
                                                            const i = pkg.indices[pkgItemIdx];
                                                            const isItemSelected = locationSelected.includes(i);
                                                            const itemTotal = calculateItemTotal(item);
                                                            return (
                                                                <tr key={`legacy-item-${i}`} style={{ backgroundColor: isItemSelected ? '#1d3a5c' : '#0d1117', borderLeft: `3px solid ${pkgColor.b}` }} onContextMenu={e => handleContextMenu(e, location.id, i)}>
                                                                    <td style={{ ...tdStyle, paddingLeft: '24px' }}><input type="checkbox" checked={isItemSelected} onChange={e => toggleSelect(location.id, i, e)} /></td>
                                                                    <td style={tdStyle}></td>
                                                                    <td style={tdStyle}><input type="number" value={item.qty} onChange={e => changeQty(location.id, i, e.target.value)} onFocus={e => e.target.select()} style={{ ...inputStyle, width: '60px' }} min="0" /></td>
                                                                    <td style={tdStyle}><input type="text" value={item.notes || ''} onChange={e => changeNotes(location.id, i, e.target.value)} placeholder="..." style={{ ...inputStyle, width: '100%', fontSize: '11px' }} /></td>
                                                                    <td style={tdStyle}><select value={item.system || ''} onChange={e => changeSystem(location.id, i, e.target.value)} style={{ ...inputStyle, width: '100%', cursor: 'pointer', fontSize: '11px' }}><option value=""></option>{SYSTEM_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}</select></td>
                                                                    <td style={{ ...tdStyle, fontSize: '12px', color: '#8b98a5' }}> {item.manufacturer}</td>
                                                                    <td style={tdStyle}><strong>{item.model}</strong></td>
                                                                    <td style={{ ...tdStyle, fontSize: '12px' }}>{item.description}</td>
                                                                    <td style={tdStyle}><input type="number" step="0.01" min="0" value={editingCost[`${location.id}-${i}`] !== undefined ? editingCost[`${location.id}-${i}`] : (item.unitCost || 0)} onChange={e => changeUnitCost(location.id, i, e.target.value)} onBlur={() => blurUnitCost(location.id, i)} onFocus={e => { focusUnitCost(location.id, i, item.unitCost); e.target.select(); }} style={{ ...inputStyle, width: '70px', textAlign: 'right' }} /></td>
                                                                    <td style={tdStyle}><input type="number" step="0.25" min="0" value={editingLabor[`${location.id}-${i}`] !== undefined ? editingLabor[`${location.id}-${i}`] : (item.laborHrsPerUnit || 0)} onChange={e => changeUnitLabor(location.id, i, e.target.value)} onBlur={() => blurUnitLabor(location.id, i)} onFocus={e => { focusUnitLabor(location.id, i, item.laborHrsPerUnit); e.target.select(); }} style={{ ...inputStyle, width: '60px', textAlign: 'right' }} /></td>
                                                                    <td style={{ ...tdStyle, color: '#00ba7c', fontWeight: '600', fontSize: '12px' }}>{fmtCost(itemTotal.cost)}</td>
                                                                    <td style={{ ...tdStyle, fontSize: '12px' }}>{fmtHrs(itemTotal.labor)}</td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </React.Fragment>
                                                );
                                            })}
                                            
                                            {/* Standalone items */}
                                            {groupedItems.standalone.map(({ item, idx: i }) => {
                                                const isSelected = locationSelected.includes(i);
                                                const hasAccessories = item.accessories?.length > 0;
                                                const isExpanded = expandedItems[location.id]?.[i] !== false;
                                                const itemTotal = calculateItemTotal(item);
                                                
                                                return (
                                                    <React.Fragment key={i}>
                                                        <tr 
                                                            style={{ backgroundColor: isSelected ? '#1d3a5c' : 'transparent' }}
                                                            onContextMenu={e => handleContextMenu(e, location.id, i)}
                                                        >
                                                            <td style={tdStyle}>
                                                                <input type="checkbox" checked={isSelected} onChange={e => toggleSelect(location.id, i, e)} />
                                                            </td>
                                                            <td style={tdStyle}>
                                                                {hasAccessories && (
                                                                    <button style={{ ...styles.iconButton, padding: '2px' }} onClick={() => toggleItemExpand(location.id, i)}>
                                                                        {isExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                                                                    </button>
                                                                )}
                                                            </td>
                                                            <td style={tdStyle}>
                                                                <input type="number" value={item.qty} onChange={e => changeQty(location.id, i, e.target.value)} onFocus={e => e.target.select()} style={{ ...inputStyle, width: '60px' }} min="0" />
                                                            </td>
                                                            <td style={tdStyle}>
                                                                <input type="text" value={item.notes || ''} onChange={e => changeNotes(location.id, i, e.target.value)} placeholder="..." style={{ ...inputStyle, width: '100%', fontSize: '11px' }} />
                                                            </td>
                                                            <td style={tdStyle}>
                                                                <select value={item.system || ''} onChange={e => changeSystem(location.id, i, e.target.value)} style={{ ...inputStyle, width: '100%', cursor: 'pointer', fontSize: '11px' }}><option value=""></option>{SYSTEM_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}</select>
                                                            </td>
                                                            <td style={{ ...tdStyle, fontSize: '12px' }}>{item.manufacturer}</td>
                                                            <td style={tdStyle}><strong>{item.model}</strong></td>
                                                            <td style={{ ...tdStyle, fontSize: '12px' }}>
                                                                {item.description}
                                                                {hasAccessories && <span style={{ ...styles.badge('orange'), marginLeft: '6px', fontSize: '9px' }}>{item.accessories.length}</span>}
                                                            </td>
                                                            <td style={tdStyle}><input type="number" step="0.01" min="0" value={editingCost[`${location.id}-${i}`] !== undefined ? editingCost[`${location.id}-${i}`] : (item.unitCost || 0)} onChange={e => changeUnitCost(location.id, i, e.target.value)} onBlur={() => blurUnitCost(location.id, i)} onFocus={e => { focusUnitCost(location.id, i, item.unitCost); e.target.select(); }} style={{ ...inputStyle, width: '70px', textAlign: 'right' }} /></td>
                                                            <td style={tdStyle}><input type="number" step="0.25" min="0" value={editingLabor[`${location.id}-${i}`] !== undefined ? editingLabor[`${location.id}-${i}`] : (item.laborHrsPerUnit || 0)} onChange={e => changeUnitLabor(location.id, i, e.target.value)} onBlur={() => blurUnitLabor(location.id, i)} onFocus={e => { focusUnitLabor(location.id, i, item.laborHrsPerUnit); e.target.select(); }} style={{ ...inputStyle, width: '60px', textAlign: 'right' }} /></td>
                                                            <td style={{ ...tdStyle, color: '#00ba7c', fontWeight: '600', fontSize: '12px' }}>{fmtCost(itemTotal.cost)}</td>
                                                            <td style={{ ...tdStyle, fontSize: '12px' }}>{fmtHrs(itemTotal.labor)}</td>
                                                        </tr>

                                                        {/* Accessories */}
                                                        {hasAccessories && isExpanded && item.accessories.map((acc, accIdx) => {
                                                            const accCostKey = `${location.id}-${i}-${accIdx}`;
                                                            const accLaborKey = `${location.id}-${i}-${accIdx}`;
                                                            return (
                                                            <tr key={`acc-${accIdx}`} style={{ backgroundColor: '#0d1117' }}
                                                                onContextMenu={e => handleContextMenu(e, location.id, i, true, accIdx)}>
                                                                <td style={tdStyle}></td>
                                                                <td style={tdStyle}></td>
                                                                <td style={{ ...tdStyle, paddingLeft: '24px' }}>
                                                                    <input type="number" value={acc.qty} onChange={e => changeAccessoryQty(location.id, i, accIdx, e.target.value)} onFocus={e => e.target.select()} style={{ ...inputStyle, width: '60px' }} min="0" />
                                                                </td>
                                                                <td style={tdStyle}>
                                                                    <input type="text" value={acc.notes || ''} onChange={e => changeAccessoryNotes(location.id, i, accIdx, e.target.value)} placeholder="..." style={{ ...inputStyle, width: '100%', fontSize: '10px' }} />
                                                                </td>
                                                                <td style={tdStyle}></td>
                                                                <td style={{ ...tdStyle, fontSize: '11px', color: '#8b98a5' }}> {acc.manufacturer}</td>
                                                                <td style={{ ...tdStyle, fontSize: '11px', color: '#8b98a5' }}>{acc.model}</td>
                                                                <td style={{ ...tdStyle, fontSize: '11px', color: '#8b98a5' }}>{acc.description}</td>
                                                                <td style={tdStyle}><input type="number" step="0.01" min="0" value={editingAccCost[accCostKey] !== undefined ? editingAccCost[accCostKey] : (acc.unitCost || 0)} onChange={e => changeAccCost(location.id, i, accIdx, e.target.value)} onBlur={() => blurAccCost(location.id, i, accIdx)} onFocus={e => { focusAccCost(location.id, i, accIdx, acc.unitCost); e.target.select(); }} style={{ ...inputStyle, width: '70px', textAlign: 'right', fontSize: '10px' }} /></td>
                                                                <td style={tdStyle}><input type="number" step="0.25" min="0" value={editingAccLabor[accLaborKey] !== undefined ? editingAccLabor[accLaborKey] : (acc.laborHrsPerUnit || 0)} onChange={e => changeAccLabor(location.id, i, accIdx, e.target.value)} onBlur={() => blurAccLabor(location.id, i, accIdx)} onFocus={e => { focusAccLabor(location.id, i, accIdx, acc.laborHrsPerUnit); e.target.select(); }} style={{ ...inputStyle, width: '60px', textAlign: 'right', fontSize: '10px' }} /></td>
                                                                <td style={{ ...tdStyle, fontSize: '11px', color: '#6e9e6e' }}>{fmtCost((acc.qty || 0) * (acc.unitCost || 0))}</td>
                                                                <td style={{ ...tdStyle, fontSize: '11px' }}>
                                                                    <span style={{ color: '#8b98a5' }}>{fmtHrs((acc.qty || 0) * (acc.laborHrsPerUnit || 0))}</span>
                                                                    <button style={{ ...styles.iconButton, marginLeft: '4px', color: '#6e767d', padding: '2px' }} onClick={() => removeAccessory(location.id, i, accIdx)}>
                                                                        <Icons.X />
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        );
                                                        })}
                                                    </React.Fragment>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                );
            })}
            
            {/* Context Menu */}
            {contextMenu && !contextMenu.isAccessory && (
                <div style={{
                    position: 'fixed',
                    top: contextMenu.y,
                    left: contextMenu.x,
                    backgroundColor: '#21262d',
                    border: '1px solid #30363d',
                    borderRadius: '8px',
                    padding: '4px',
                    zIndex: 1000,
                    minWidth: '200px',
                    boxShadow: '0 8px 24px rgba(0,0,0,0.4)'
                }}>
                    {(() => {
                        const location = allLocations.find(l => l.id === contextMenu.locationId);
                        const item = location?.items[contextMenu.itemIdx];
                        const itemCount = location?.items?.length || 0;
                        const groupedItems = location ? getGroupedItems(location) : { packages: [], standalone: [] };
                        
                        return (
                            <>
                                <button 
                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                    onClick={() => { onAddAccessoryToItem(contextMenu.locationId, contextMenu.itemIdx); setContextMenu(null); }}>
                                    <Icons.Plus /> Add Accessory
                                </button>
                                {itemCount > 1 && (
                                    <button 
                                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                        onClick={() => { onConvertToAccessory(contextMenu.locationId, contextMenu.itemIdx); setContextMenu(null); }}>
                                        <Icons.ChevronDown /> Convert to Accessory
                                    </button>
                                )}
                                <div style={{ borderTop: '1px solid #30363d', margin: '4px 0' }} />
                                <button 
                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                    onClick={() => { onCopy([{ ...item }]); setContextMenu(null); }}>
                                    <Icons.Copy /> Copy
                                </button>
                                <button 
                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                    onClick={() => { onSavePackage([{ ...item }], [contextMenu.itemIdx], contextMenu.locationId); setContextMenu(null); }}>
                                    <Icons.Package /> Save as New Package
                                </button>
                                {groupedItems.legacyPackages.length > 0 && (
                                    <>
                                        <div style={{ padding: '4px 12px', fontSize: '11px', color: '#6e767d', textTransform: 'uppercase' }}>Move to Package</div>
                                        {groupedItems.legacyPackages.map(pkg => {
                                            const pkgColor = styles.pkgColor(pkg.name);
                                            return (
                                                <button
                                                    key={pkg.name}
                                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '6px 12px 6px 20px', fontSize: '12px' }}
                                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                                    onClick={() => { onMoveToPackage(contextMenu.locationId, contextMenu.itemIdx, pkg.name); setContextMenu(null); }}>
                                                    <span style={{ width: '8px', height: '8px', borderRadius: '2px', backgroundColor: pkgColor.b, marginRight: '8px' }}></span>
                                                    {pkg.name}
                                                </button>
                                            );
                                        })}
                                    </>
                                )}
                                <div style={{ borderTop: '1px solid #30363d', margin: '4px 0' }} />
                                {onAddToCatalog && (
                                    <button 
                                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#1d9bf0' }}
                                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                        onClick={() => { onAddToCatalog(item); setContextMenu(null); }}>
                                        <Icons.Database /> Add to Catalog
                                    </button>
                                )}
                                <button 
                                    style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#f85149' }}
                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                    onClick={() => { removeItem(contextMenu.locationId, contextMenu.itemIdx); setContextMenu(null); }}>
                                    <Icons.Trash /> Delete
                                </button>
                            </>
                        );
                    })()}
                </div>
            )}
            
            {/* Accessory Context Menu */}
            {contextMenu && contextMenu.isAccessory && (
                <div style={{
                    position: 'fixed',
                    top: contextMenu.y,
                    left: contextMenu.x,
                    backgroundColor: '#21262d',
                    border: '1px solid #30363d',
                    borderRadius: '8px',
                    padding: '4px',
                    zIndex: 1000,
                    minWidth: '180px',
                    boxShadow: '0 8px 24px rgba(0,0,0,0.4)'
                }}>
                    <button 
                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={() => { promoteAccessoryToItem(contextMenu.locationId, contextMenu.itemIdx, contextMenu.accIdx); setContextMenu(null); }}>
                        <Icons.ChevronUp /> Promote to Item
                    </button>
                    <button 
                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#f85149' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={() => { removeAccessory(contextMenu.locationId, contextMenu.itemIdx, contextMenu.accIdx); setContextMenu(null); }}>
                        <Icons.Trash /> Remove Accessory
                    </button>
                </div>
            )}
        </div>
    );
}

// Project status badge colors
const PROJECT_STATUSES = {
    developing: { label: 'Developing', color: '#f59e0b', bg: '#3d2e1a' },
    'proposal-submitted': { label: 'Proposal Submitted', color: '#a78bfa', bg: '#2d1a3d' },
    active: { label: 'Active', color: '#1d9bf0', bg: '#1d3a5c' },
    completed: { label: 'Completed', color: '#00ba7c', bg: '#1a3d2e' },
    lost: { label: 'Lost', color: '#f87171', bg: '#3d1a1a' },
    archived: { label: 'Archived', color: '#6e767d', bg: '#1a1f26' },
};

function NewProjectModal({ onClose, onCreate }) {
    const [name, setName] = useState('');
    const [client, setClient] = useState('');
    const [projectNumber, setProjectNumber] = useState('');
    const [dueDate, setDueDate] = useState('');
    const [notes, setNotes] = useState('');
    
    const handleSubmit = () => {
        if (!name.trim()) return;
        onCreate({ name: name.trim(), client, projectNumber, dueDate, notes });
        onClose();
    };
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '500px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 20px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.Plus /> New Project
                </h2>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Project Name *</label>
                        <input 
                            type="text" 
                            value={name} 
                            onChange={e => setName(e.target.value)} 
                            style={styles.input} 
                            placeholder="e.g., Corporate HQ AV Refresh"
                            autoFocus
                            onKeyDown={e => e.key === 'Enter' && handleSubmit()}
                        />
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                        <div>
                            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Client</label>
                            <input type="text" value={client} onChange={e => setClient(e.target.value)} style={styles.input} placeholder="Client name" />
                        </div>
                        <div>
                            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Project Number</label>
                            <input type="text" value={projectNumber} onChange={e => setProjectNumber(e.target.value)} style={styles.input} placeholder="e.g., P-2024-001" />
                        </div>
                    </div>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Due Date</label>
                        <input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} style={styles.input} />
                    </div>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Notes</label>
                        <textarea value={notes} onChange={e => setNotes(e.target.value)} style={{ ...styles.textarea, minHeight: '80px' }} placeholder="Project notes..." />
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px' }}>
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button style={{ ...styles.button('primary'), opacity: !name.trim() ? 0.5 : 1 }} disabled={!name.trim()} onClick={handleSubmit}>Create Project</button>
                </div>
            </div>
        </div>
    );
}

function EditProjectModal({ project, onClose, onSave }) {
    const [name, setName] = useState(project.name || '');
    const [client, setClient] = useState(project.client || '');
    const [projectNumber, setProjectNumber] = useState(project.projectNumber || '');
    const [dueDate, setDueDate] = useState(project.dueDate || '');
    const [notes, setNotes] = useState(project.notes || '');
    const [status, setStatus] = useState(project.status || 'developing');
    
    const handleSubmit = () => {
        if (!name.trim()) return;
        onSave({ 
            ...project, 
            name: name.trim(), 
            client, 
            projectNumber, 
            dueDate, 
            notes,
            status,
            updatedAt: new Date().toISOString()
        });
        onClose();
    };
    
    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '500px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 20px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.Edit /> Edit Project
                </h2>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Project Name *</label>
                        <input 
                            type="text" 
                            value={name} 
                            onChange={e => setName(e.target.value)} 
                            style={styles.input} 
                            placeholder="e.g., Corporate HQ AV Refresh"
                            autoFocus
                            onKeyDown={e => e.key === 'Enter' && handleSubmit()}
                        />
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                        <div>
                            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Client</label>
                            <input type="text" value={client} onChange={e => setClient(e.target.value)} style={styles.input} placeholder="Client name" />
                        </div>
                        <div>
                            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Project Number</label>
                            <input type="text" value={projectNumber} onChange={e => setProjectNumber(e.target.value)} style={styles.input} placeholder="e.g., P-2024-001" />
                        </div>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                        <div>
                            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Due Date</label>
                            <input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} style={styles.input} />
                        </div>
                        <div>
                            <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Status</label>
                            <select 
                                value={status} 
                                onChange={e => setStatus(e.target.value)} 
                                style={{ ...styles.input, cursor: 'pointer' }}>
                                {Object.entries(PROJECT_STATUSES).map(([key, val]) => (
                                    <option key={key} value={key}>{val.label}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Notes</label>
                        <textarea value={notes} onChange={e => setNotes(e.target.value)} style={{ ...styles.textarea, minHeight: '80px' }} placeholder="Project notes..." />
                    </div>
                </div>
                {project.revisions?.length > 0 && (
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Revision History</label>
                        <div style={{ maxHeight: '150px', overflowY: 'auto', border: '1px solid #2f3336', borderRadius: '8px' }}>
                            {project.revisions.map(rev => (
                                <div key={rev.id} style={{ padding: '8px 12px', borderBottom: '1px solid #2f3336', fontSize: '13px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span style={{ fontWeight: '600', color: rev.id === project.currentRevision ? '#f59e0b' : '#e7e9ea' }}>{rev.label}</span>
                                        <span style={{ color: '#6e767d', fontSize: '11px' }}>{new Date(rev.createdAt).toLocaleDateString()}</span>
                                    </div>
                                    {rev.createdBy && <div style={{ color: '#6e767d', fontSize: '11px', marginTop: '1px' }}>by {rev.createdBy}</div>}
                                    {rev.notes && <div style={{ color: '#8b98a5', fontSize: '12px', marginTop: '2px' }}>{rev.notes}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px' }}>
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button style={{ ...styles.button('primary'), opacity: !name.trim() ? 0.5 : 1 }} disabled={!name.trim()} onClick={handleSubmit}>Save Changes</button>
                </div>
            </div>
        </div>
    );
}

function RevisionPromptModal({ project, onClose, onCreateRevision }) {
    const [label, setLabel] = useState('');
    const [notes, setNotes] = useState('');

    const suggestedLabel = useMemo(() => {
        const revisions = project.revisions || [];
        const revCount = revisions.filter(r => r.label.startsWith('Rev')).length;
        if (revisions.length === 0) return 'Rev 1';
        return 'Rev ' + (revCount + 1);
    }, [project.revisions]);

    useEffect(() => { setLabel(suggestedLabel); }, [suggestedLabel]);

    const handleSubmit = () => {
        if (!label.trim()) return;
        onCreateRevision({ label: label.trim(), notes: notes.trim() });
        onClose();
    };

    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '450px' }} onClick={e => e.stopPropagation()}>
                <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <Icons.Edit /> New Revision Required
                </h2>
                <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>
                    This project has been submitted. Changes require a revision or change order label.
                </p>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Revision Label *</label>
                        <input
                            type="text" value={label} onChange={e => setLabel(e.target.value)}
                            style={styles.input} placeholder="e.g., Rev 1, CO-1"
                            autoFocus onKeyDown={e => e.key === 'Enter' && handleSubmit()}
                        />
                    </div>
                    <div>
                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', color: '#8b98a5' }}>Notes (optional)</label>
                        <textarea value={notes} onChange={e => setNotes(e.target.value)} style={{ ...styles.input, minHeight: '60px', resize: 'vertical' }} placeholder="Reason for changes..." />
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }}>
                    <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                    <button style={{ ...styles.button('primary'), opacity: !label.trim() ? 0.5 : 1 }} disabled={!label.trim()} onClick={handleSubmit}>Create Revision</button>
                </div>
            </div>
        </div>
    );
}

function ProjectsHome({ projects, onOpen, onCreate, onOpenCatalog, onOpenTeam, team, checkouts, onEdit, onDuplicate, onDelete, onUpdateStatus, getProjectTotals, searchTerm, onSearchChange, filter, onFilterChange, session, syncStatus, onLogout }) {
    const [contextMenu, setContextMenu] = useState(null);
    const [confirmDelete, setConfirmDelete] = useState(null);
    const [sortCol, setSortCol] = useState('updatedAt');
    const [sortDir, setSortDir] = useState('desc');

    const handleSort = (col) => {
        if (sortCol === col) { setSortDir(d => d === 'asc' ? 'desc' : 'asc'); }
        else { setSortCol(col); setSortDir(col === 'name' || col === 'client' || col === 'projectNumber' ? 'asc' : 'desc'); }
    };

    const SortIcon = ({ col }) => {
        if (sortCol !== col) return <span style={{ color: '#4a5568', marginLeft: '4px' }}></span>;
        return <span style={{ color: '#1d9bf0', marginLeft: '4px' }}>{sortDir === 'asc' ? '' : ''}</span>;
    };

    // Filter and search projects
    const filteredProjects = useMemo(() => {
        let result = projects.filter(p => {
            // Status filter
            if (filter === 'active' && (p.status === 'archived' || p.status === 'completed' || p.status === 'lost')) return false;
            if (filter === 'submitted' && p.status !== 'proposal-submitted') return false;
            if (filter === 'completed' && p.status !== 'completed') return false;
            if (filter === 'lost' && p.status !== 'lost') return false;
            if (filter === 'archived' && p.status !== 'archived') return false;

            // Search
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                return p.name.toLowerCase().includes(term) ||
                       p.client?.toLowerCase().includes(term) ||
                       p.projectNumber?.toLowerCase().includes(term);
            }
            return true;
        });

        // Sort
        const dir = sortDir === 'asc' ? 1 : -1;
        result.sort((a, b) => {
            let va, vb;
            switch (sortCol) {
                case 'name': va = (a.name || '').toLowerCase(); vb = (b.name || '').toLowerCase(); break;
                case 'client': va = (a.client || '').toLowerCase(); vb = (b.client || '').toLowerCase(); break;
                case 'projectNumber': va = (a.projectNumber || '').toLowerCase(); vb = (b.projectNumber || '').toLowerCase(); break;
                case 'status': va = (a.status || ''); vb = (b.status || ''); break;
                case 'material': { const ta = getProjectTotals(a); const tb = getProjectTotals(b); va = ta.cost; vb = tb.cost; break; }
                case 'labor': { const ta = getProjectTotals(a); const tb = getProjectTotals(b); va = ta.labor; vb = tb.labor; break; }
                case 'updatedAt': default: va = a.updatedAt || ''; vb = b.updatedAt || ''; break;
            }
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
        });
        return result;
    }, [projects, filter, searchTerm, sortCol, sortDir]);
    
    // Close context menu on click outside
    useEffect(() => {
        const handleClick = () => setContextMenu(null);
        if (contextMenu) window.addEventListener('click', handleClick);
        return () => window.removeEventListener('click', handleClick);
    }, [contextMenu]);
    
    const statusCounts = useMemo(() => {
        const counts = { all: projects.length, active: 0, submitted: 0, completed: 0, lost: 0, archived: 0 };
        projects.forEach(p => {
            if (p.status === 'archived') counts.archived++;
            else if (p.status === 'lost') counts.lost++;
            else if (p.status === 'completed') counts.completed++;
            if (p.status === 'proposal-submitted') counts.submitted++;
            if (p.status !== 'archived' && p.status !== 'completed' && p.status !== 'lost') counts.active++;
        });
        return counts;
    }, [projects]);
    
    return (
        <div style={{ minHeight: '100vh', backgroundColor: '#0f1419' }}>
            {/* Header */}
            <header style={{ ...styles.header, borderBottom: '1px solid #2f3336', justifyContent: 'space-between' }}>
                <div style={styles.logo}>
                    <Icons.Layers /> AV Estimator
                    <span style={{ fontSize: '10px', color: '#4a5568', fontWeight: '400', marginLeft: '4px', alignSelf: 'flex-end', marginBottom: '2px' }}>v{APP_VERSION}</span>
                </div>
                {session && (
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <span style={{ fontSize: '12px', color: syncStatus === 'synced' ? '#00ba7c' : syncStatus === 'syncing' ? '#f59e0b' : syncStatus === 'error' ? '#f87171' : '#6e767d' }}>
                            {syncStatus === 'synced' ? '\u2601 Synced' : syncStatus === 'syncing' ? '\u2601 Syncing...' : syncStatus === 'error' ? '\u2601 Sync error' : '\u2601'}
                        </span>
                        <button onClick={onOpenTeam} style={{ background: 'none', border: `1px solid ${team ? '#1d9bf0' : '#30363d'}`, borderRadius: '6px', color: team ? '#1d9bf0' : '#8b98a5', padding: '6px 12px', fontSize: '12px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <Icons.Users /> {team ? team.name : 'Team'}
                        </button>
                        <span style={{ fontSize: '13px', color: '#8b98a5' }}>{session.user?.email}</span>
                        <button onClick={onLogout} style={{ background: 'none', border: '1px solid #30363d', borderRadius: '6px', color: '#8b98a5', padding: '6px 12px', fontSize: '12px', cursor: 'pointer' }}>Sign Out</button>
                    </div>
                )}
            </header>
            
            {/* Main content */}
            <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px 24px' }}>
                {/* Title and actions */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                    <div>
                        <h1 style={{ margin: '0 0 4px 0', fontSize: '28px', fontWeight: '700', color: '#e7e9ea' }}>Projects</h1>
                        <p style={{ margin: 0, color: '#6e767d', fontSize: '14px' }}>{projects.length} total projects</p>
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        <button style={styles.button('secondary')} onClick={onOpenCatalog}>
                            <Icons.Layers /> Catalog
                        </button>
                        <button style={styles.button('primary')} onClick={onCreate}>
                            <Icons.Plus /> New Project
                        </button>
                    </div>
                </div>
                
                {/* Filters and search */}
                <div style={{ display: 'flex', gap: '12px', marginBottom: '24px', flexWrap: 'wrap' }}>
                    <div style={{ display: 'flex', gap: '4px', backgroundColor: '#1a1f26', borderRadius: '8px', padding: '4px' }}>
                        {[
                            { key: 'active', label: 'Active' },
                            { key: 'submitted', label: 'Submitted' },
                            { key: 'completed', label: 'Completed' },
                            { key: 'lost', label: 'Lost' },
                            { key: 'archived', label: 'Archived' },
                            { key: 'all', label: 'All' },
                        ].map(f => (
                            <button 
                                key={f.key}
                                style={{ 
                                    ...styles.smallButton, 
                                    backgroundColor: filter === f.key ? '#2f3336' : 'transparent',
                                    color: filter === f.key ? '#e7e9ea' : '#6e767d'
                                }}
                                onClick={() => onFilterChange(f.key)}>
                                {f.label} ({statusCounts[f.key]})
                            </button>
                        ))}
                    </div>
                    <input 
                        type="text" 
                        value={searchTerm} 
                        onChange={e => onSearchChange(e.target.value)} 
                        placeholder="Search projects..." 
                        style={{ ...styles.input, width: '250px' }} 
                    />
                </div>
                
                {/* Projects table */}
                {filteredProjects.length > 0 ? (
                    <div style={{ backgroundColor: '#1a1f26', borderRadius: '12px', border: '1px solid #2f3336', overflow: 'hidden' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid #2f3336' }}>
                                    {[
                                        { id: 'name', label: 'Project', align: 'left', pad: '10px 16px' },
                                        { id: 'client', label: 'Client', align: 'left' },
                                        { id: 'projectNumber', label: 'Project #', align: 'left' },
                                        { id: 'status', label: 'Status', align: 'center' },
                                        { id: 'material', label: 'Material', align: 'right' },
                                        { id: 'labor', label: 'Labor', align: 'right' },
                                        { id: 'updatedAt', label: 'Last Updated', align: 'left' },
                                    ].map(col => (
                                        <th
                                            key={col.id}
                                            style={{ padding: col.pad || '10px 12px', textAlign: col.align, fontSize: '11px', color: '#6e767d', fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none', whiteSpace: 'nowrap' }}
                                            onClick={() => handleSort(col.id)}
                                        >
                                            {col.label}<SortIcon col={col.id} />
                                        </th>
                                    ))}
                                    <th style={{ padding: '10px 12px', width: '40px' }}></th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredProjects.map(project => {
                                    const totals = getProjectTotals(project);
                                    const status = PROJECT_STATUSES[project.status] || PROJECT_STATUSES.developing;
                                    const checkout = checkouts[project.id];
                                    const updDate = project.updatedAt ? new Date(project.updatedAt) : null;
                                    return (
                                        <tr
                                            key={project.id}
                                            style={{ borderBottom: '1px solid #2f3336', cursor: 'pointer', transition: 'background-color 0.1s' }}
                                            onClick={() => onOpen(project.id)}
                                            onContextMenu={e => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, project }); }}
                                            onMouseEnter={e => e.currentTarget.style.backgroundColor = '#1e2530'}
                                            onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                                        >
                                            <td style={{ padding: '12px 16px' }}>
                                                <div style={{ fontWeight: '600', color: '#e7e9ea', fontSize: '14px' }}>{project.name}</div>
                                                {checkout && (
                                                    <div style={{ fontSize: '11px', color: checkout.userId === session?.user?.id ? '#00ba7c' : '#f59e0b', marginTop: '2px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                        <Icons.Lock /> {checkout.userId === session?.user?.id ? 'Checked out by you' : `Checked out by ${checkout.email}`}
                                                    </div>
                                                )}
                                            </td>
                                            <td style={{ padding: '12px 12px', color: '#8b98a5', fontSize: '13px' }}>{project.client || ''}</td>
                                            <td style={{ padding: '12px 12px', color: '#8b98a5', fontSize: '13px' }}>{project.projectNumber || ''}</td>
                                            <td style={{ padding: '12px 12px', textAlign: 'center' }}>
                                                <span style={{ ...styles.badge(''), backgroundColor: status.bg, color: status.color, fontSize: '11px' }}>{status.label}</span>
                                            </td>
                                            <td style={{ padding: '12px 12px', textAlign: 'right', color: '#00ba7c', fontWeight: '600', fontSize: '13px' }}>{fmtCost(totals.cost)}</td>
                                            <td style={{ padding: '12px 12px', textAlign: 'right', color: '#1d9bf0', fontWeight: '600', fontSize: '13px' }}>{fmtHrs(totals.labor)}</td>
                                            <td style={{ padding: '12px 12px' }}>
                                                <div style={{ color: '#e7e9ea', fontSize: '12px', whiteSpace: 'nowrap' }}>{updDate ? updDate.toLocaleDateString() + ' ' + updDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</div>
                                                {project.updatedBy && <div style={{ color: '#6e767d', fontSize: '11px', marginTop: '1px' }}>{project.updatedBy}</div>}
                                            </td>
                                            <td style={{ padding: '12px 8px', textAlign: 'center' }}>
                                                <button
                                                    style={{ ...styles.iconButton, color: '#6e767d', padding: '4px' }}
                                                    onClick={e => { e.stopPropagation(); onEdit(project); }}
                                                    title="Edit project info">
                                                    <Icons.Edit />
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                ) : (
                    <div style={{ textAlign: 'center', padding: '60px 20px' }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}></div>
                        <h3 style={{ color: '#8b98a5', fontSize: '18px', margin: '0 0 8px 0' }}>
                            {searchTerm ? 'No projects match your search' : 'No projects yet'}
                        </h3>
                        <p style={{ color: '#6e767d', margin: '0 0 20px 0' }}>
                            {searchTerm ? 'Try a different search term' : 'Create your first project to get started'}
                        </p>
                        {!searchTerm && (
                            <button style={styles.button('primary')} onClick={onCreate}>
                                <Icons.Plus /> New Project
                            </button>
                        )}
                    </div>
                )}
            </div>
            
            {/* Context menu */}
            {contextMenu && (
                <div style={{ 
                    position: 'fixed', 
                    left: contextMenu.x, 
                    top: contextMenu.y, 
                    backgroundColor: '#1a1f26', 
                    border: '1px solid #2f3336', 
                    borderRadius: '8px', 
                    padding: '4px',
                    zIndex: 1000,
                    boxShadow: '0 4px 12px rgba(0,0,0,0.4)',
                    minWidth: '180px'
                }}>
                    <button 
                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={() => { onOpen(contextMenu.project.id); setContextMenu(null); }}>
                        <Icons.Layers /> Open Project
                    </button>
                    <button 
                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={() => { onEdit(contextMenu.project); setContextMenu(null); }}>
                        <Icons.Edit /> Edit Project Info
                    </button>
                    <button 
                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={() => { onDuplicate(contextMenu.project.id); setContextMenu(null); }}>
                        <Icons.Duplicate /> Duplicate
                    </button>
                    <div style={{ borderTop: '1px solid #2f3336', margin: '4px 0' }} />
                    <div style={{ padding: '4px 12px', fontSize: '11px', color: '#6e767d', textTransform: 'uppercase' }}>Set Status</div>
                    {Object.entries(PROJECT_STATUSES).map(([key, val]) => (
                        <button 
                            key={key}
                            style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '6px 12px', color: val.color }}
                            onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                            onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                            onClick={() => { onUpdateStatus(contextMenu.project.id, key); setContextMenu(null); }}>
                            {val.label}
                        </button>
                    ))}
                    <div style={{ borderTop: '1px solid #2f3336', margin: '4px 0' }} />
                    <button 
                        style={{ ...styles.smallButton, width: '100%', justifyContent: 'flex-start', backgroundColor: 'transparent', padding: '8px 12px', color: '#f87171' }}
                        onMouseEnter={e => e.currentTarget.style.backgroundColor = '#2f3336'}
                        onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}
                        onClick={() => { setConfirmDelete(contextMenu.project); setContextMenu(null); }}>
                        <Icons.Trash /> Delete Project
                    </button>
                </div>
            )}
            
            {/* Confirm delete modal */}
            {confirmDelete && (
                <div style={styles.modal} onClick={() => setConfirmDelete(null)}>
                    <div style={{ ...styles.modalContent, width: '400px' }} onClick={e => e.stopPropagation()}>
                        <h2 style={{ margin: '0 0 12px 0', fontSize: '18px', color: '#f87171' }}>Delete Project?</h2>
                        <p style={{ color: '#8b98a5', marginBottom: '20px' }}>
                            Are you sure you want to delete <strong style={{ color: '#e7e9ea' }}>"{confirmDelete.name}"</strong>? This action cannot be undone.
                        </p>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={styles.button('secondary')} onClick={() => setConfirmDelete(null)}>Cancel</button>
                            <button style={styles.button('danger')} onClick={() => { onDelete(confirmDelete.id); setConfirmDelete(null); }}>Delete</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function LoginScreen({ onAuth }) {
    const [mode, setMode] = useState('signin'); // 'signin' or 'signup'
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setMessage('');
        if (!email.trim() || !password) { setError('Email and password are required'); return; }
        if (mode === 'signup' && password !== confirmPassword) { setError('Passwords do not match'); return; }
        if (password.length < 6) { setError('Password must be at least 6 characters'); return; }

        setLoading(true);
        try {
            if (mode === 'signup') {
                const { data, error: err } = await supabase.auth.signUp({ email: email.trim(), password });
                if (err) throw err;
                if (data.user && !data.session) {
                    setMessage('Check your email for a confirmation link.');
                } else if (data.session) {
                    onAuth(data.session);
                }
            } else {
                const { data, error: err } = await supabase.auth.signInWithPassword({ email: email.trim(), password });
                if (err) throw err;
                onAuth(data.session);
            }
        } catch (err) {
            setError(err.message || 'Authentication failed');
        }
        setLoading(false);
    };

    const inputStyle = { width: '100%', padding: '12px 16px', background: '#0d1117', border: '1px solid #30363d', borderRadius: '8px', color: '#e7e9ea', fontSize: '15px', outline: 'none' };

    return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#0d1117', padding: '20px' }}>
            <div style={{ width: '100%', maxWidth: '400px' }}>
                <div style={{ textAlign: 'center', marginBottom: '32px' }}>
                    <div style={{ fontSize: '48px', marginBottom: '8px' }}>
                        <svg width="48" height="48" viewBox="0 0 192 192" fill="none"><rect width="192" height="192" rx="40" fill="#1d9bf0"/><text x="96" y="125" textAnchor="middle" fill="white" fontSize="90" fontWeight="bold" fontFamily="system-ui">AV</text></svg>
                    </div>
                    <h1 style={{ color: '#e7e9ea', fontSize: '24px', fontWeight: '700', margin: '8px 0 4px' }}>AV Estimator</h1>
                    <p style={{ color: '#8b98a5', fontSize: '14px' }}>{mode === 'signin' ? 'Sign in to your account' : 'Create a new account'}</p>
                </div>
                <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email address" style={inputStyle} autoFocus />
                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" style={inputStyle} />
                    {mode === 'signup' && (
                        <input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} placeholder="Confirm password" style={inputStyle} />
                    )}
                    {error && <div style={{ color: '#f87171', fontSize: '13px', padding: '8px 12px', background: '#3d1a1a', borderRadius: '6px' }}>{error}</div>}
                    {message && <div style={{ color: '#00ba7c', fontSize: '13px', padding: '8px 12px', background: '#1a3d2e', borderRadius: '6px' }}>{message}</div>}
                    <button type="submit" disabled={loading} style={{ padding: '12px', background: '#1d9bf0', color: 'white', border: 'none', borderRadius: '8px', fontSize: '15px', fontWeight: '600', cursor: loading ? 'wait' : 'pointer', opacity: loading ? 0.7 : 1 }}>
                        {loading ? 'Please wait...' : mode === 'signin' ? 'Sign In' : 'Create Account'}
                    </button>
                </form>
                <div style={{ textAlign: 'center', marginTop: '20px' }}>
                    <button onClick={() => { setMode(mode === 'signin' ? 'signup' : 'signin'); setError(''); setMessage(''); }} style={{ background: 'none', border: 'none', color: '#1d9bf0', cursor: 'pointer', fontSize: '14px' }}>
                        {mode === 'signin' ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
                    </button>
                </div>
            </div>
        </div>
    );
}

function TeamModal({ team, session, onClose, onTeamUpdate }) {
    const [mode, setMode] = useState(team ? 'view' : 'choose'); // 'choose', 'create', 'join', 'view'
    const [teamName, setTeamName] = useState('');
    const [inviteCode, setInviteCode] = useState('');
    const [members, setMembers] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [copied, setCopied] = useState(false);

    // Load members when viewing team
    useEffect(() => {
        if (team && supabase) {
            supabase.rpc('get_team_members', { p_team_id: team.id })
                .then(({ data, error }) => {
                    if (data) setMembers(data);
                    else if (error) {
                        // Fallback to basic query without emails
                        supabase.from('team_members')
                            .select('user_id, role, joined_at')
                            .eq('team_id', team.id)
                            .then(({ data }) => { if (data) setMembers(data); });
                    }
                });
        }
    }, [team]);

    const createTeam = async () => {
        if (!teamName.trim() || !supabase || !session) return;
        setLoading(true);
        setError('');
        try {
            // Create team
            const { data: newTeam, error: teamErr } = await supabase
                .from('teams')
                .insert({ name: teamName.trim(), created_by: session.user.id })
                .select()
                .single();
            if (teamErr) throw teamErr;

            // Add creator as owner
            const { error: memberErr } = await supabase
                .from('team_members')
                .insert({ team_id: newTeam.id, user_id: session.user.id, role: 'owner' });
            if (memberErr) throw memberErr;

            // Migrate existing projects to team
            const { error: projErr } = await supabase
                .from('projects')
                .update({ team_id: newTeam.id })
                .eq('user_id', session.user.id);
            if (projErr) console.error('Project migration error:', projErr);

            // Migrate user_settings to team
            const { error: settErr } = await supabase
                .from('user_settings')
                .update({ team_id: newTeam.id })
                .eq('user_id', session.user.id);
            if (settErr) console.error('Settings migration error:', settErr);

            onTeamUpdate({ id: newTeam.id, name: newTeam.name, invite_code: newTeam.invite_code, role: 'owner' });
            onClose();
        } catch (e) {
            setError(e.message || 'Failed to create team');
        }
        setLoading(false);
    };

    const joinTeam = async () => {
        if (!inviteCode.trim() || !supabase) return;
        setLoading(true);
        setError('');
        try {
            const { data: teamId, error: rpcErr } = await supabase
                .rpc('join_team_by_code', { code: inviteCode.trim().toLowerCase() });
            if (rpcErr) throw rpcErr;

            // Fetch team details
            const { data: teamData } = await supabase
                .from('teams')
                .select('id, name, invite_code')
                .eq('id', teamId)
                .single();

            if (teamData) {
                // Migrate user's existing projects to team
                await supabase.from('projects')
                    .update({ team_id: teamData.id })
                    .eq('user_id', session.user.id);

                await supabase.from('user_settings')
                    .update({ team_id: teamData.id })
                    .eq('user_id', session.user.id);

                onTeamUpdate({ id: teamData.id, name: teamData.name, invite_code: teamData.invite_code, role: 'member' });
            }
            onClose();
        } catch (e) {
            setError(e.message?.includes('Invalid') ? 'Invalid invite code' : (e.message || 'Failed to join team'));
        }
        setLoading(false);
    };

    const leaveTeam = async () => {
        if (!supabase || !team) return;
        setLoading(true);
        try {
            // Unlink projects from team (keep them as user's own)
            await supabase.from('projects')
                .update({ team_id: null })
                .eq('user_id', session.user.id)
                .eq('team_id', team.id);

            await supabase.from('user_settings')
                .update({ team_id: null })
                .eq('user_id', session.user.id);

            await supabase.from('team_members')
                .delete()
                .eq('team_id', team.id)
                .eq('user_id', session.user.id);

            onTeamUpdate(null);
            onClose();
        } catch (e) {
            setError(e.message || 'Failed to leave team');
        }
        setLoading(false);
    };

    const copyCode = () => {
        if (team?.invite_code) {
            navigator.clipboard.writeText(team.invite_code);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        }
    };

    const inputStyle = { ...styles.input, marginBottom: '12px' };

    return (
        <div style={styles.modal} onClick={onClose}>
            <div style={{ ...styles.modalContent, width: '450px' }} onClick={e => e.stopPropagation()}>
                {/* View existing team */}
                {mode === 'view' && team && (
                    <>
                        <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icons.Users /> {team.name}
                        </h2>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{ display: 'block', fontSize: '12px', color: '#8b98a5', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Invite Code</label>
                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                <code style={{ flex: 1, padding: '10px 14px', backgroundColor: '#1a1f26', borderRadius: '8px', border: '1px solid #2f3336', fontSize: '18px', fontFamily: 'monospace', letterSpacing: '0.15em', color: '#1d9bf0' }}>{team.invite_code}</code>
                                <button style={{ ...styles.smallButton, padding: '10px 14px' }} onClick={copyCode}>
                                    {copied ? <><Icons.Check /> Copied</> : <><Icons.Copy /> Copy</>}
                                </button>
                            </div>
                            <p style={{ fontSize: '12px', color: '#6e767d', marginTop: '6px' }}>Share this code with teammates so they can join</p>
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{ display: 'block', fontSize: '12px', color: '#8b98a5', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Members ({members.length})</label>
                            {members.map(m => (
                                <div key={m.user_id} style={{ padding: '8px 12px', backgroundColor: '#1a1f26', borderRadius: '6px', marginBottom: '4px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ fontSize: '13px', color: '#e7e9ea' }}>{m.user_id === session.user.id ? `${session.user.email} (you)` : (m.email || m.user_id.slice(0, 8) + '...')}</span>
                                    <span style={{ ...styles.badge(m.role === 'owner' ? 'blue' : 'green'), fontSize: '10px' }}>{m.role}</span>
                                </div>
                            ))}
                        </div>

                        {error && <p style={{ color: '#f87171', fontSize: '13px', marginBottom: '12px' }}>{error}</p>}

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', borderTop: '1px solid #2f3336', paddingTop: '16px' }}>
                            <button style={{ ...styles.button('secondary'), color: '#f87171' }} onClick={leaveTeam} disabled={loading}>
                                {loading ? 'Leaving...' : 'Leave Team'}
                            </button>
                            <button style={styles.button('secondary')} onClick={onClose}>Close</button>
                        </div>
                    </>
                )}

                {/* Choose create or join */}
                {mode === 'choose' && (
                    <>
                        <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icons.Users /> Team Setup
                        </h2>
                        <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '20px' }}>Teams let you share projects, packages, and catalog customizations with your coworkers.</p>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '20px' }}>
                            <button
                                style={{ padding: '16px', backgroundColor: '#1a1f26', border: '2px solid #2f3336', borderRadius: '10px', cursor: 'pointer', textAlign: 'left', color: '#e7e9ea' }}
                                onClick={() => setMode('create')}
                                onMouseEnter={e => e.currentTarget.style.borderColor = '#1d9bf0'}
                                onMouseLeave={e => e.currentTarget.style.borderColor = '#2f3336'}
                            >
                                <div style={{ fontWeight: '600', marginBottom: '4px' }}>Create a Team</div>
                                <div style={{ fontSize: '13px', color: '#8b98a5' }}>Start a new team and invite your coworkers</div>
                            </button>
                            <button
                                style={{ padding: '16px', backgroundColor: '#1a1f26', border: '2px solid #2f3336', borderRadius: '10px', cursor: 'pointer', textAlign: 'left', color: '#e7e9ea' }}
                                onClick={() => setMode('join')}
                                onMouseEnter={e => e.currentTarget.style.borderColor = '#00ba7c'}
                                onMouseLeave={e => e.currentTarget.style.borderColor = '#2f3336'}
                            >
                                <div style={{ fontWeight: '600', marginBottom: '4px' }}>Join a Team</div>
                                <div style={{ fontSize: '13px', color: '#8b98a5' }}>Enter an invite code from your team owner</div>
                            </button>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'flex-end' }}>
                            <button style={styles.button('secondary')} onClick={onClose}>Cancel</button>
                        </div>
                    </>
                )}

                {/* Create team */}
                {mode === 'create' && (
                    <>
                        <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700' }}>Create a Team</h2>
                        <label style={{ display: 'block', fontSize: '12px', color: '#8b98a5', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Team Name</label>
                        <input
                            type="text"
                            value={teamName}
                            onChange={e => setTeamName(e.target.value)}
                            style={inputStyle}
                            placeholder="e.g., AV Design Team"
                            autoFocus
                            onKeyDown={e => e.key === 'Enter' && createTeam()}
                        />
                        <p style={{ fontSize: '12px', color: '#6e767d', marginBottom: '16px' }}>Your existing projects will be shared with the team.</p>
                        {error && <p style={{ color: '#f87171', fontSize: '13px', marginBottom: '12px' }}>{error}</p>}
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={styles.button('secondary')} onClick={() => { setMode('choose'); setError(''); }}>Back</button>
                            <button style={{ ...styles.button('primary'), opacity: !teamName.trim() ? 0.5 : 1 }} onClick={createTeam} disabled={!teamName.trim() || loading}>
                                {loading ? 'Creating...' : 'Create Team'}
                            </button>
                        </div>
                    </>
                )}

                {/* Join team */}
                {mode === 'join' && (
                    <>
                        <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700' }}>Join a Team</h2>
                        <label style={{ display: 'block', fontSize: '12px', color: '#8b98a5', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Invite Code</label>
                        <input
                            type="text"
                            value={inviteCode}
                            onChange={e => setInviteCode(e.target.value)}
                            style={{ ...inputStyle, fontFamily: 'monospace', fontSize: '16px', letterSpacing: '0.1em' }}
                            placeholder="e.g., a1b2c3d4"
                            autoFocus
                            onKeyDown={e => e.key === 'Enter' && joinTeam()}
                        />
                        <p style={{ fontSize: '12px', color: '#6e767d', marginBottom: '16px' }}>Ask your team owner for the invite code.</p>
                        {error && <p style={{ color: '#f87171', fontSize: '13px', marginBottom: '12px' }}>{error}</p>}
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={styles.button('secondary')} onClick={() => { setMode('choose'); setError(''); }}>Back</button>
                            <button style={{ ...styles.button('primary'), backgroundColor: '#00ba7c', opacity: !inviteCode.trim() ? 0.5 : 1 }} onClick={joinTeam} disabled={!inviteCode.trim() || loading}>
                                {loading ? 'Joining...' : 'Join Team'}
                            </button>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
}

function App() {
    // Auth state
    const [session, setSession] = useState(null);
    const [authLoading, setAuthLoading] = useState(true);
    const [syncStatus, setSyncStatus] = useState('idle'); // 'idle', 'syncing', 'synced', 'error'
    const syncTimer = React.useRef(null);

    // Auth listener
    useEffect(() => {
        if (!supabase) { setAuthLoading(false); return; }
        supabase.auth.getSession().then(({ data: { session } }) => {
            setSession(session);
            setAuthLoading(false);
        });
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            setSession(session);
        });
        return () => subscription.unsubscribe();
    }, []);

    // Fetch team membership on login
    useEffect(() => {
        if (!supabase || !session) { setTeam(null); return; }
        const fetchTeam = async () => {
            try {
                const { data: membership } = await supabase
                    .from('team_members')
                    .select('team_id, role')
                    .eq('user_id', session.user.id)
                    .limit(1)
                    .single();
                if (membership) {
                    const { data: teamData } = await supabase
                        .from('teams')
                        .select('id, name, invite_code')
                        .eq('id', membership.team_id)
                        .single();
                    if (teamData) {
                        setTeam({ ...teamData, role: membership.role });
                    }
                }
            } catch (e) {
                // No team membership  that's fine
            }
        };
        fetchTeam();
    }, [session]);

    // Multi-project state
    const [projects, setProjects] = useState([]);
    const [activeProjectId, setActiveProjectId] = useState(null);
    const [showProjectsHome, setShowProjectsHome] = useState(true);
    const [showNewProjectModal, setShowNewProjectModal] = useState(false);
    const [showDashboardCatalog, setShowDashboardCatalog] = useState(false);
    const [team, setTeam] = useState(null);
    const [showTeamModal, setShowTeamModal] = useState(false);
    const hasLoaded = React.useRef(false);
    const [editingProject, setEditingProject] = useState(null);
    const [showProjectSettings, setShowProjectSettings] = useState(false);
    const [showRevisionPrompt, setShowRevisionPrompt] = useState(false);
    const [pendingMutation, setPendingMutation] = useState(null);
    const [projectSearchTerm, setProjectSearchTerm] = useState('');
    const [projectFilter, setProjectFilter] = useState('active');
    
    // Current project state (when a project is open)
    const [tab, setTab] = useState('project');
    const [catalog, setCatalog] = useState([]);
    const [catalogSyncStatus, setCatalogSyncStatus] = useState('loading');
    const [catalogDirty, setCatalogDirty] = useState(false);
    const [catalogConflicts, setCatalogConflicts] = useState(null);
    const [packages, setPackages] = useState([]);
    
    // Load catalog on mount. If first-time (no localStorage) and team becomes available, reload to get Supabase customizations.
    const catalogInitializedRef = React.useRef(false);
    useEffect(() => {
        loadCatalogData();
    }, []);
    useEffect(() => {
        // When team becomes available, reload catalog only if it hasn't been initialized from localStorage
        // (i.e., first-time setup where we need Supabase customizations)
        if (team && !catalogInitializedRef.current) {
            loadCatalogData();
        }
        loadPackagesData();
    }, [team]);
    
    // Helper to apply team customizations (edits, deletions, favorites, notes) to base catalog
    const applyCatalogCustomizations = (baseCatalog, customizations) => {
        if (!customizations?.length) return baseCatalog;
        const customMap = {};
        customizations.forEach(c => { customMap[c.catalog_item_id] = c; });
        return baseCatalog.map(item => {
            const custom = customMap[item.id];
            if (custom) {
                let merged = { ...item, favorite: custom.favorite, catalogNote: custom.catalog_note, deleted: !!custom.deleted };
                if (custom.custom_fields) {
                    try {
                        const fields = typeof custom.custom_fields === 'string' ? JSON.parse(custom.custom_fields) : custom.custom_fields;
                        merged = { ...merged, ...fields };
                    } catch (e) { console.error('Failed to parse custom_fields', e); }
                }
                return merged;
            }
            return item;
        });
    };

    const loadCatalogData = async () => {
        // localStorage is the primary source of truth for the catalog.
        // On first ever load (no localStorage), build from av_catalog.json + Supabase.
        // On subsequent loads (browser refresh), just use localStorage directly.
        // Use the in-app refresh button to pull latest from Supabase.
        const saved = localStorage.getItem('av-estimator-catalog');
        if (saved) {
            try {
                const localCatalog = JSON.parse(saved);
                if (localCatalog?.length > 0) {
                    setCatalog(localCatalog);
                    setCatalogSyncStatus(supabase && session ? 'synced' : 'local');
                    setCatalogDirty(false);
                    catalogInitializedRef.current = true;
                    return;
                }
            } catch (e) {}
        }

        // First-time load: build catalog from base JSON + Supabase customizations
        setCatalogSyncStatus('syncing');
        let result = null;
        try {
            const response = await fetch(getDataUrl(CONFIG.CATALOG_FILE));
            if (response.ok) {
                result = await response.json();
            }
        } catch (e) {
            console.log('Failed to fetch base catalog');
        }

        if (!result) {
            result = DEFAULT_CATALOG;
            setCatalog(result);
            setCatalogSyncStatus('offline');
            setCatalogDirty(false);
            return;
        }

        // Apply team customizations from Supabase if available
        if (supabase && session && team) {
            try {
                const { data: customizations, error } = await supabase
                    .from('catalog_customizations')
                    .select('*')
                    .eq('team_id', team.id)
                    .limit(5000);
                if (!error && customizations?.length > 0) {
                    result = applyCatalogCustomizations(result, customizations);
                }
            } catch (e) {
                console.log('Failed to load team customizations');
            }
        }

        setCatalog(result);
        localStorage.setItem('av-estimator-catalog', JSON.stringify(result));
        setCatalogSyncStatus(supabase && session ? 'synced' : 'local');
        setCatalogDirty(false);
    };
    
    const loadPackagesData = async () => {
        try {
            const response = await fetch(getDataUrl(CONFIG.PACKAGES_FILE));
            if (response.ok) {
                const data = await response.json();
                setPackages(data);
                localStorage.setItem('av-estimator-packages', JSON.stringify(data));
                return;
            }
        } catch (e) {
            console.log('Failed to fetch remote packages, using local');
        }
        
        // Fall back to localStorage
        const saved = localStorage.getItem('av-estimator-packages');
        if (saved) {
            try {
                setPackages(JSON.parse(saved));
                return;
            } catch (e) {}
        }
        
        // Empty packages
        setPackages([]);
    };
    
    // Refresh catalog: pull coworker changes from Supabase and merge with local catalog.
    // localStorage/in-memory catalog is the base; Supabase customizations with newer timestamps win.
    const refreshCatalog = async () => {
        if (!supabase || !session || !team) {
            showToast('Catalog is up to date (local only)');
            return;
        }
        setCatalogSyncStatus('syncing');
        try {
            // Build a map of current local catalog for merging
            const localMap = {};
            catalog.forEach(c => { localMap[c.id] = c; });

            // Fetch team customizations from Supabase
            const { data: customizations, error } = await supabase
                .from('catalog_customizations')
                .select('*')
                .eq('team_id', team.id)
                .limit(5000);

            if (error) {
                console.error('Refresh error:', error);
                setCatalogSyncStatus('offline');
                showToast('Could not refresh catalog');
                return;
            }

            if (customizations?.length > 0) {
                // Apply Supabase customizations, but only if they're newer than local edits
                let updatedCount = 0;
                customizations.forEach(custom => {
                    const local = localMap[custom.catalog_item_id];
                    if (!local) return;
                    const localTime = local.modifiedAt ? new Date(local.modifiedAt).getTime() : 0;
                    const remoteTime = custom.updated_at ? new Date(custom.updated_at).getTime() : 0;
                    // Remote is newer  apply Supabase customization over local
                    if (remoteTime > localTime) {
                        let merged = { ...local, favorite: custom.favorite, catalogNote: custom.catalog_note, deleted: !!custom.deleted };
                        if (custom.custom_fields) {
                            try {
                                const fields = typeof custom.custom_fields === 'string' ? JSON.parse(custom.custom_fields) : custom.custom_fields;
                                merged = { ...merged, ...fields };
                            } catch (e) {}
                        }
                        // Preserve the remote timestamp as modifiedAt so future refreshes know
                        merged.modifiedAt = custom.updated_at;
                        localMap[custom.catalog_item_id] = merged;
                        updatedCount++;
                    }
                });
                if (updatedCount > 0) {
                    const updated = catalog.map(c => localMap[c.id] || c);
                    setCatalog(updated);
                    localStorage.setItem('av-estimator-catalog', JSON.stringify(updated));
                    showToast(`Catalog refreshed: ${updatedCount} item${updatedCount !== 1 ? 's' : ''} updated from team`);
                } else {
                    showToast('Catalog is up to date');
                }
            } else {
                showToast('Catalog is up to date');
            }
            setCatalogSyncStatus('synced');
            setCatalogDirty(false);
        } catch (e) {
            console.error('Refresh error:', e);
            setCatalogSyncStatus('offline');
            showToast('Could not refresh catalog');
        }
    };
    
    const [selected, setSelected] = useState(null);
    const [viewMode, setViewMode] = useState('single'); // 'single' or 'all'
    const [compactMode, setCompactMode] = useState(true); // Compact layout toggle - default to compact
    const [showSearch, setShowSearch] = useState(false);
    const [searchTargetLocation, setSearchTargetLocation] = useState(null); // For all-locations mode
    const [showAddLocation, setShowAddLocation] = useState(false);
    const [showAddSublocation, setShowAddSublocation] = useState(false);
    const [showDuplicate, setShowDuplicate] = useState(false);
    const [duplicateTarget, setDuplicateTarget] = useState(null); // Location to duplicate (null = use selected)
    const [showDelete, setShowDelete] = useState(false);
    const [clipboard, setClipboard] = useState([]);
    const [locationSearch, setLocationSearch] = useState('');
    const [expandedLocations, setExpandedLocations] = useState({});
    const [expandedWorkspaceLocations, setExpandedWorkspaceLocations] = useState({}); // For all-locations view
    const [templates, setTemplates] = useState([]);
    const [multiSelectLocations, setMultiSelectLocations] = useState([]);
    const lastMultiSelectLocRef = useRef(null);
    const [deleteTargets, setDeleteTargets] = useState([]); // For delete modal - can be single or multiple
    const [showSavePackage, setShowSavePackage] = useState(false);
    const [showSaveTemplate, setShowSaveTemplate] = useState(false);
    const [showApplyTemplate, setShowApplyTemplate] = useState(false);
    const [pendingPackageItems, setPendingPackageItems] = useState([]);
    const [pendingPackageIndices, setPendingPackageIndices] = useState([]);
    const [pendingPackageLocationId, setPendingPackageLocationId] = useState(null); // For all-locations mode
    const [toast, setToast] = useState(null);
    
    // Accessory modal states
    const [pendingComponents, setPendingComponents] = useState(null); // { comps, qty } - components waiting for accessory prompt
    const [accessoryPromptComponent, setAccessoryPromptComponent] = useState(null); // Component with accessories to prompt
    const [showConvertToAccessory, setShowConvertToAccessory] = useState(false);
    const [convertItemIdx, setConvertItemIdx] = useState(null);
    const [convertLocationId, setConvertLocationId] = useState(null); // For all-locations view
    const [showAddAccessoryModal, setShowAddAccessoryModal] = useState(false);
    const [addAccessoryItemIdx, setAddAccessoryItemIdx] = useState(null);
    const [addAccessoryLocationId, setAddAccessoryLocationId] = useState(null); // For all-locations view
    
    // BOM table resizable columns
    const { columns: bomCols, startResize: startBomResize } = useFlexibleColumns([
        { id: 'qty', label: 'Qty', width: 60 },
        { id: 'manufacturer', label: 'Manufacturer', width: 120 },
        { id: 'model', label: 'Model', width: 120 },
        { id: 'partNumber', label: 'Part Number', width: 130 },
        { id: 'description', label: 'Description', width: 220 },
        { id: 'unitCost', label: 'Unit Cost', width: 90 },
        { id: 'laborHrsPerUnit', label: 'Unit Labor', width: 90 },
        { id: 'extCost', label: 'Ext. Cost', width: 90 },
        { id: 'extLabor', label: 'Ext. Labor', width: 90 },
    ]);

    // Report state
    const [showLaborByPhase, setShowLaborByPhase] = useState(true);
    const [reportHierarchyDepth, setReportHierarchyDepth] = useState(-1);

    // History for undo/redo
    const [history, setHistory] = useState([]);
    const [historyIndex, setHistoryIndex] = useState(-1);
    const isUndoRedo = React.useRef(false);
    
    // Stable default project to prevent infinite re-renders
    const defaultProject = useMemo(() => ({ name: 'New Project', locations: [] }), []);
    
    // Get active project
    const project = projects.find(p => p.id === activeProjectId) || defaultProject;
    
    // Update project helper
    // Check if a mutation requires a revision before proceeding
    const requiresRevision = (proj) => {
        const postSubmissionStatuses = ['proposal-submitted', 'active', 'completed'];
        return postSubmissionStatuses.includes(proj?.status) && !proj?.currentRevision;
    };

    const setProjectDirect = (updater) => {
        setProjects(prev => prev.map(p => {
            if (p.id === activeProjectId) {
                const newProject = typeof updater === 'function' ? updater(p) : updater;
                return { ...newProject, updatedAt: new Date().toISOString(), updatedBy: session?.user?.email || '' };
            }
            return p;
        }));
    };

    const setProject = (updater) => {
        if (projectReadOnly) {
            showToast('Project is read-only  checked out by ' + (checkedOutBy || 'another user'));
            return;
        }
        const currentProject = projects.find(p => p.id === activeProjectId);
        if (currentProject && requiresRevision(currentProject)) {
            setPendingMutation(() => () => setProjectDirect(updater));
            setShowRevisionPrompt(true);
            return;
        }
        setProjectDirect(updater);
    };

    // Handle revision creation from the modal
    const createRevision = ({ label, notes }) => {
        const revision = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            label,
            notes,
            createdAt: new Date().toISOString(),
            createdBy: session?.user?.email || 'unknown',
        };
        // First, add the revision to the project and set it as current
        setProjectDirect(p => ({
            ...p,
            revisions: [...(p.revisions || []), revision],
            currentRevision: revision.id,
        }));

        // Log to Supabase for team changelog
        if (supabase && session && team && activeProjectId) {
            const revisionNumber = (project?.revisions?.length || 0) + 1;
            supabase.from('project_revisions').insert({
                project_id: activeProjectId,
                team_id: team.id,
                user_id: session.user.id,
                user_email: session.user.email,
                revision_number: revisionNumber,
                note: `${label}${notes ? ': ' + notes : ''}`,
            }).then(({ error }) => {
                if (error) console.error('Revision log error:', error);
            });
        }

        // Then execute the pending mutation
        if (pendingMutation) {
            setTimeout(() => {
                pendingMutation();
                setPendingMutation(null);
            }, 50);
        }
    };

    // Close current revision (next change will prompt for new one)
    const closeRevision = () => {
        setProjectDirect(p => ({ ...p, currentRevision: null }));
    };
    
    // Create new project
    const createProject = (projectData) => {
        const newProject = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            name: projectData.name || 'Untitled Project',
            client: projectData.client || '',
            status: 'developing',
            locations: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            dueDate: projectData.dueDate || null,
            notes: projectData.notes || '',
            projectNumber: projectData.projectNumber || '',
            revisions: [],
            currentRevision: null,
        };
        setProjects(prev => [newProject, ...prev]);
        return newProject.id;
    };
    
    // Open a project
    const [projectReadOnly, setProjectReadOnly] = useState(false);
    const [checkedOutBy, setCheckedOutBy] = useState(null);
    const [checkouts, setCheckouts] = useState({}); // { projectId: { email, userId } }

    // Fetch checkout status for all projects (when on dashboard)
    useEffect(() => {
        if (!supabase || !session || !team || !showProjectsHome) return;
        const fetchCheckouts = async () => {
            const { data } = await supabase
                .from('projects')
                .select('id, checked_out_by, checked_out_email')
                .eq('team_id', team.id)
                .not('checked_out_by', 'is', null);
            if (data) {
                const map = {};
                data.forEach(p => { map[p.id] = { email: p.checked_out_email, userId: p.checked_out_by }; });
                setCheckouts(map);
            }
        };
        fetchCheckouts();
    }, [showProjectsHome, session, team]);

    const openProject = async (projectId) => {
        setProjectReadOnly(false);
        setCheckedOutBy(null);

        // Attempt checkout if on a team
        if (supabase && session && team) {
            try {
                const { data: success } = await supabase.rpc('checkout_project', {
                    p_project_id: projectId,
                    p_email: session.user.email
                });
                if (success === false) {
                    // Someone else has it checked out  open read-only
                    const { data: projRow } = await supabase
                        .from('projects')
                        .select('checked_out_email, checked_out_by')
                        .eq('id', projectId)
                        .single();
                    setProjectReadOnly(true);
                    setCheckedOutBy(projRow?.checked_out_email || 'another user');
                }
            } catch (e) {
                console.error('Checkout error:', e);
            }
        }

        setActiveProjectId(projectId);
        setShowProjectsHome(false);
        setSelected(null);
        setHistory([]);
        setHistoryIndex(-1);
    };

    // Close current project and return to home
    const closeProject = async () => {
        // Check in the project
        if (supabase && session && activeProjectId && !projectReadOnly) {
            try {
                await supabase.rpc('checkin_project', { p_project_id: activeProjectId });
            } catch (e) {
                console.error('Checkin error:', e);
            }
        }
        setActiveProjectId(null);
        setShowProjectsHome(true);
        setSelected(null);
        setProjectReadOnly(false);
        setCheckedOutBy(null);
    };
    
    // Duplicate a project
    const duplicateProject = (projectId) => {
        const source = projects.find(p => p.id === projectId);
        if (!source) return;
        const newProject = {
            ...JSON.parse(JSON.stringify(source)),
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            name: source.name + ' (Copy)',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            status: 'developing',
        };
        setProjects(prev => [newProject, ...prev]);
        showToast('Project duplicated');
    };
    
    // Delete a project
    const deleteProject = (projectId) => {
        setProjects(prev => prev.filter(p => p.id !== projectId));
        if (activeProjectId === projectId) {
            closeProject();
        }
        // Delete from Supabase
        if (supabase && session) {
            supabase.from('projects').delete().eq('id', projectId).then(({ error }) => {
                if (error) console.error('Failed to delete from Supabase:', error);
            });
        }
        showToast('Project deleted');
    };
    
    // Update project status
    const updateProjectStatus = (projectId, status) => {
        setProjects(prev => prev.map(p =>
            p.id === projectId ? { ...p, status, updatedAt: new Date().toISOString(), updatedBy: session?.user?.email || '' } : p
        ));
    };

    // Save project (for editing)
    const saveProject = (updatedProject) => {
        setProjects(prev => prev.map(p =>
            p.id === updatedProject.id ? { ...updatedProject, updatedAt: new Date().toISOString(), updatedBy: session?.user?.email || '' } : p
        ));
        showToast('Project updated');
    };
    
    // Calculate project totals
    const getProjectTotals = (proj) => {
        let cost = 0, labor = 0, items = 0;
        const catalogPkgs = packages;
        const projectPkgs = proj.packages || [];
        const calc = (locs) => {
            for (const loc of locs) {
                if (loc.items) {
                    const flatItems = getFlattenedItems(loc, catalogPkgs, projectPkgs);
                    for (const item of flatItems) {
                        cost += (item.qty || 0) * (item.unitCost || 0);
                        labor += (item.qty || 0) * (item.laborHrsPerUnit || 0);
                        items += 1;
                        if (item.accessories) {
                            for (const acc of item.accessories) {
                                cost += (acc.qty || 0) * (acc.unitCost || 0);
                                labor += (acc.qty || 0) * (acc.laborHrsPerUnit || 0);
                                items += 1;
                            }
                        }
                    }
                }
                if (loc.children) calc(loc.children);
            }
        };
        calc(proj.locations || []);
        return { cost, labor, items };
    };

    // Wrapper to update catalog + sync full catalog to Supabase for teams
    const catalogSyncTimer = React.useRef(null);
    const updateCatalog = (newCatalog) => {
        const updated = typeof newCatalog === 'function' ? newCatalog(catalog) : newCatalog;
        setCatalog(updated);
        setCatalogDirty(true);
        // Immediately save to localStorage so a page refresh won't lose changes
        localStorage.setItem('av-estimator-catalog', JSON.stringify(updated));
    };

    const saveCatalog = async () => {
        // Save to localStorage immediately
        localStorage.setItem('av-estimator-catalog', JSON.stringify(catalog));

        // Sync to Supabase if on a team
        if (supabase && session && team) {
            setCatalogSyncStatus('syncing');
            try {
                const modified = catalog.filter(c => c.modifiedAt || c.favorite || c.catalogNote || c.deleted);
                if (modified.length > 0) {
                    const customizations = modified.map(c => ({
                        team_id: team.id,
                        catalog_item_id: c.id,
                        favorite: !!c.favorite,
                        catalog_note: c.catalogNote || '',
                        deleted: !!c.deleted,
                        custom_fields: JSON.stringify({
                            manufacturer: c.manufacturer,
                            model: c.model,
                            partNumber: c.partNumber,
                            description: c.description,
                            category: c.category,
                            subcategory: c.subcategory,
                            unitCost: c.unitCost,
                            laborHrsPerUnit: c.laborHrsPerUnit,
                            uom: c.uom,
                            vendor: c.vendor,
                            phase: c.phase || '',
                            discontinued: !!c.discontinued,
                        }),
                        updated_at: new Date().toISOString(),
                    }));
                    const { error: upsertError } = await supabase.from('catalog_customizations').upsert(customizations, { onConflict: 'team_id,catalog_item_id' });
                    if (upsertError) {
                        console.error('Catalog upsert error:', upsertError);
                    }
                }
                // Don't reload from Supabase after save  our in-memory catalog is the source of truth.
                // Reloading was causing deleted items to repopulate when the Supabase columns
                // weren't set up or the round-trip hadn't completed yet.
                // Coworkers will get updates when they open/refresh the catalog via loadCatalogData.
                setCatalogSyncStatus('synced');
            } catch (e) {
                console.error('Catalog sync error:', e);
                setCatalogSyncStatus('offline');
            }
        }
        setCatalogDirty(false);
        showToast('Catalog saved');
    };

    // Auto-save to localStorage + Supabase sync (skip until initial load completes)
    useEffect(() => {
        if (!hasLoaded.current) return;
        const data = { projects, packages, templates, activeProjectId };
        localStorage.setItem('av-estimator-data-v2', JSON.stringify(data));

        // Debounced sync to Supabase
        if (supabase && session) {
            clearTimeout(syncTimer.current);
            syncTimer.current = setTimeout(async () => {
                setSyncStatus('syncing');
                try {
                    // Upsert each project
                    for (const p of projects) {
                        const { error } = await supabase.from('projects').upsert({
                            id: p.id,
                            user_id: session.user.id,
                            team_id: team?.id || null,
                            data: p,
                            updated_at: p.updatedAt || new Date().toISOString(),
                        });
                        if (error) throw error;
                    }
                    // Sync packages/templates
                    await supabase.from('user_settings').upsert({
                        user_id: session.user.id,
                        team_id: team?.id || null,
                        packages,
                        templates,
                        updated_at: new Date().toISOString(),
                    });
                    setSyncStatus('synced');
                } catch (err) {
                    console.error('Sync error:', err);
                    setSyncStatus('error');
                }
            }, 2000);
        }
    }, [projects, packages, templates, activeProjectId, team]);
    
    // Save catalog to localStorage when it changes
    useEffect(() => {
        localStorage.setItem('av-estimator-catalog', JSON.stringify(catalog));
    }, [catalog]);
    
    // Load from localStorage on mount
    useEffect(() => {
        const saved = localStorage.getItem('av-estimator-data-v2');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.projects?.length > 0) {
                    // Migrate old statuses to new ones
                    const statusMap = { bidding: 'developing', won: 'active', 'in-progress': 'active' };
                    const migratedProjects = data.projects.map(p =>
                        statusMap[p.status] ? { ...p, status: statusMap[p.status] } : p
                    );
                    setProjects(migratedProjects);
                }
                if (data.activeProjectId) {
                    setActiveProjectId(data.activeProjectId);
                    setShowProjectsHome(false);
                }
                // Migrate package definitions to new format
                let loadedPackages = data.packages?.length > 0 ? migratePackageDefinitions(data.packages) : [];
                if (loadedPackages.length > 0) setPackages(loadedPackages);

                // Migrate old packageName items to package instances
                let allNewDefs = [];
                const pkgMigratedProjects = migratedProjects.map(p => {
                    const { project: mp, newPackageDefs } = migrateProjectPackages(p, [...loadedPackages, ...allNewDefs]);
                    allNewDefs = [...allNewDefs, ...newPackageDefs];
                    return mp;
                });
                if (allNewDefs.length > 0) {
                    loadedPackages = [...loadedPackages, ...allNewDefs];
                    setPackages(loadedPackages);
                }
                if (pkgMigratedProjects.some((p, i) => p !== migratedProjects[i])) {
                    setProjects(pkgMigratedProjects);
                }

                if (data.templates) setTemplates(data.templates);
            } catch (e) { console.error('Failed to load saved data', e); }
        } else {
            // Migrate from old single-project format
            const oldSaved = localStorage.getItem('av-estimator-data');
            if (oldSaved) {
                try {
                    const oldData = JSON.parse(oldSaved);
                    if (oldData.project?.locations?.length > 0) {
                        const migratedProject = {
                            ...oldData.project,
                            id: Date.now().toString(),
                            status: 'developing',
                            client: '',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                        };
                        setProjects([migratedProject]);
                    }
                    if (oldData.packages?.length > 0) setPackages(oldData.packages);
                    if (oldData.templates) setTemplates(oldData.templates);
                } catch (e) { console.error('Failed to migrate old data'); }
            }
        }
        hasLoaded.current = true;
    }, []);

    // Sync with Supabase after login
    useEffect(() => {
        if (!supabase || !session || !hasLoaded.current) return;
        const syncFromSupabase = async () => {
            setSyncStatus('syncing');
            try {
                // Pull remote projects  filter by team or user
                let projQuery = supabase.from('projects').select('id, data, updated_at');
                if (team) {
                    projQuery = projQuery.eq('team_id', team.id);
                } else {
                    projQuery = projQuery.eq('user_id', session.user.id);
                }
                const { data: remoteRows, error: projErr } = await projQuery;
                if (!projErr && remoteRows?.length > 0) {
                    const remote = remoteRows.map(r => r.data);
                    setProjects(prev => {
                        const merged = {};
                        [...prev, ...remote].forEach(p => {
                            if (!merged[p.id] || new Date(p.updatedAt) > new Date(merged[p.id].updatedAt)) {
                                merged[p.id] = p;
                            }
                        });
                        return Object.values(merged);
                    });
                }

                // Pull remote packages/templates  filter by team or user
                let settQuery = supabase.from('user_settings').select('packages, templates');
                if (team) {
                    settQuery = settQuery.eq('team_id', team.id);
                } else {
                    settQuery = settQuery.eq('user_id', session.user.id);
                }
                const { data: settings } = await settQuery.single();
                if (settings) {
                    if (settings.packages?.length > 0) setPackages(prev => prev.length > 0 ? prev : settings.packages);
                    if (settings.templates && Object.keys(settings.templates).length > 0) setTemplates(prev => Object.keys(prev).length > 0 ? prev : settings.templates);
                }

                // Pull catalog customizations if on a team (includes edits, deletions, favorites, notes)
                if (team) {
                    const { data: customizations } = await supabase
                        .from('catalog_customizations')
                        .select('*')
                        .eq('team_id', team.id)
                        .limit(5000);
                    if (customizations?.length > 0) {
                        setCatalog(prev => {
                            const customMap = {};
                            customizations.forEach(c => { customMap[c.catalog_item_id] = c; });
                            return prev.map(item => {
                                const custom = customMap[item.id];
                                if (custom) {
                                    let merged = { ...item, favorite: custom.favorite, catalogNote: custom.catalog_note, deleted: !!custom.deleted };
                                    // Apply full field overrides if custom_fields exists
                                    if (custom.custom_fields) {
                                        try {
                                            const fields = typeof custom.custom_fields === 'string' ? JSON.parse(custom.custom_fields) : custom.custom_fields;
                                            merged = { ...merged, ...fields };
                                        } catch (e) { console.error('Failed to parse custom_fields', e); }
                                    }
                                    return merged;
                                }
                                return item;
                            });
                        });
                    }
                }

                setSyncStatus('synced');
            } catch (err) {
                console.error('Supabase sync error:', err);
                setSyncStatus('error');
            }
        };
        syncFromSupabase();
    }, [session, team]);

    // Save to history for undo
    useEffect(() => {
        if (!isUndoRedo.current && activeProjectId && project.locations?.length > 0) {
            setHistory(prev => {
                const newHist = prev.slice(0, historyIndex + 1);
                newHist.push(JSON.stringify(project));
                return newHist.slice(-30); // Keep last 30 states
            });
            setHistoryIndex(prev => Math.min(prev + 1, 29));
        }
        isUndoRedo.current = false;
    }, [activeProjectId, projects]);
    
    const undo = () => {
        if (historyIndex > 0) {
            isUndoRedo.current = true;
            setHistoryIndex(historyIndex - 1);
            setProject(JSON.parse(history[historyIndex - 1]));
            showToast('Undo');
        }
    };
    
    const redo = () => {
        if (historyIndex < history.length - 1) {
            isUndoRedo.current = true;
            setHistoryIndex(historyIndex + 1);
            setProject(JSON.parse(history[historyIndex + 1]));
            showToast('Redo');
        }
    };
    
    const showToast = (msg) => {
        setToast(msg);
        setTimeout(() => setToast(null), 2000);
    };

    // Export to Esticom - one xlsx per location
    const exportToEsticom = () => {
        const XLSX = window.XLSX;
        if (!XLSX) {
            showToast('Export library not loaded. Check your internet connection.');
            return;
        }

        const sanitizeFilename = (str) => {
            return str.replace(/[<>:"/\\|?*]/g, '-').replace(/\s*>\s*/g, ' - ').trim();
        };

        if (reportHierarchyDepth !== -1) {
            // Grouped export: one file per hierarchy group with merged items
            const groups = getGroupedByHierarchy(project.locations, reportHierarchyDepth, packages, project.packages || []);
            if (groups.length === 0) { showToast('No locations with components to export'); return; }
            groups.forEach((group, index) => {
                setTimeout(() => {
                    // Merge all items from all locations in this group into a virtual location
                    const mergedItems = [];
                    for (const loc of group.locations) {
                        const flat = getFlattenedItems(loc, packages, project.packages || []);
                        mergedItems.push(...flat);
                    }
                    const virtualLocation = { name: group.name, items: mergedItems };
                    const wb = generateEsticomWorkbook(virtualLocation, packages, project.packages);
                    const filename = sanitizeFilename(group.name) + '.xlsx';
                    XLSX.writeFile(wb, filename);
                }, index * 150);
            });
            showToast(`Exporting ${groups.length} Esticom file${groups.length > 1 ? 's' : ''} (grouped)...`);
        } else {
            // Default: per leaf location
            const locationsWithItems = getLocationsWithItems(project.locations);
            if (locationsWithItems.length === 0) { showToast('No locations with components to export'); return; }
            locationsWithItems.forEach((location, index) => {
                setTimeout(() => {
                    const wb = generateEsticomWorkbook(location, packages, project.packages);
                    const filename = sanitizeFilename(location.path || location.name) + '.xlsx';
                    XLSX.writeFile(wb, filename);
                }, index * 150);
            });
            showToast(`Exporting ${locationsWithItems.length} Esticom file${locationsWithItems.length > 1 ? 's' : ''}...`);
        }
    };

    const buildConsolidatedBOMSheet = (locsList) => {
        const partMap = {};
        for (const location of locsList) {
            const flatItems = getFlattenedItems(location, packages, project.packages);
            for (const item of flatItems) {
                const key = item.partNumber || (item.manufacturer + '|' + item.model);
                if (partMap[key]) { partMap[key].qty += (item.qty || 0); }
                else { partMap[key] = { qty: item.qty || 0, model: item.model || '', manufacturer: item.manufacturer || '', supplier: item.vendor || '', partNumber: item.partNumber || '', uom: item.uom || 'EA', unitCost: item.unitCost || 0, phase: item.phase || '' }; }
                if (item.accessories) {
                    for (const acc of item.accessories) {
                        const accKey = acc.partNumber || (acc.manufacturer + '|' + acc.model);
                        if (partMap[accKey]) { partMap[accKey].qty += (acc.qty || 0); }
                        else { partMap[accKey] = { qty: acc.qty || 0, model: acc.model || '', manufacturer: acc.manufacturer || '', supplier: acc.vendor || '', partNumber: acc.partNumber || '', uom: acc.uom || 'EA', unitCost: acc.unitCost || 0, phase: acc.phase || '' }; }
                    }
                }
            }
        }
        return partMap;
    };

    const exportConsolidatedBOM = () => {
        const XLSX = window.XLSX;
        if (!XLSX) { showToast('Export library not loaded. Check your internet connection.'); return; }
        const projectName = (project.name || 'Project').replace(/[<>:"/\\|?*]/g, '-').trim();

        // Always export as single file, single sheet with all project items consolidated
        const locationsWithItems = getLocationsWithItems(project.locations);
        if (locationsWithItems.length === 0) { showToast('No locations with components to export'); return; }
        const partMap = buildConsolidatedBOMSheet(locationsWithItems);
        const wb = XLSX.utils.book_new();
        const data = [[], ['BILL OF MATERIALS - ' + projectName, '', '', '', '', '', '', '', ''], [], [], ['QTY', 'Model', 'Manufacturer', 'Supplier', 'Part Number', 'UOM', 'Item Cost', 'Total Cost', 'Phase'], []];
        for (const part of Object.values(partMap)) { data.push([part.qty, part.model, part.manufacturer, part.supplier, part.partNumber, part.uom, part.unitCost, (part.qty || 0) * (part.unitCost || 0), part.phase]); }
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!merges'] = [{ s: { r: 1, c: 0 }, e: { r: 1, c: 8 } }];
        ws['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 14 }, { wch: 12 }, { wch: 15 }, { wch: 6 }, { wch: 10 }, { wch: 12 }, { wch: 22 }];
        XLSX.utils.book_append_sheet(wb, ws, 'Bill of materials');
        XLSX.writeFile(wb, projectName + ' - Consolidated BOM.xlsx');
        showToast('Consolidated BOM exported');
    };

    // Build consolidated BOM data for the in-app view
    const getConsolidatedBOM = () => {
        const locationsWithItems = getLocationsWithItems(project.locations);
        const partMap = {};
        for (const location of locationsWithItems) {
            const flatItems = getFlattenedItems(location, packages, project.packages);
            for (const item of flatItems) {
                const key = item.partNumber || (item.manufacturer + '|' + item.model);
                if (partMap[key]) {
                    partMap[key].totalQty += (item.qty || 0);
                    if (!partMap[key].locations.includes(location.path || location.name)) partMap[key].locations.push(location.path || location.name);
                } else {
                    partMap[key] = {
                        key,
                        totalQty: item.qty || 0,
                        manufacturer: item.manufacturer || '',
                        model: item.model || '',
                        partNumber: item.partNumber || '',
                        description: item.description || '',
                        category: item.category || '',
                        unitCost: item.unitCost || 0,
                        laborHrsPerUnit: item.laborHrsPerUnit || 0,
                        uom: item.uom || 'EA',
                        vendor: item.vendor || '',
                        locations: [location.path || location.name],
                    };
                }
                if (item.accessories) {
                    for (const acc of item.accessories) {
                        const accKey = acc.partNumber || (acc.manufacturer + '|' + acc.model);
                        if (partMap[accKey]) {
                            partMap[accKey].totalQty += (acc.qty || 0);
                            if (!partMap[accKey].locations.includes(location.path || location.name)) partMap[accKey].locations.push(location.path || location.name);
                        } else {
                            partMap[accKey] = {
                                key: accKey,
                                totalQty: acc.qty || 0,
                                manufacturer: acc.manufacturer || '',
                                model: acc.model || '',
                                partNumber: acc.partNumber || '',
                                description: acc.description || '',
                                category: acc.category || '',
                                unitCost: acc.unitCost || 0,
                                laborHrsPerUnit: acc.laborHrsPerUnit || 0,
                                uom: acc.uom || 'EA',
                                vendor: acc.vendor || '',
                                locations: [location.path || location.name],
                            };
                        }
                    }
                }
            }
        }
        return Object.values(partMap).sort((a, b) => (a.category || '').localeCompare(b.category || '') || (a.manufacturer || '').localeCompare(b.manufacturer || ''));
    };

    // Update unit cost or labor across all matching items in all locations (and package definitions)
    const updateConsolidatedField = (partKey, field, value) => {
        const numVal = parseFloat(value);
        if (isNaN(numVal) || numVal < 0) return;
        const updateLocs = (locs) => locs.map(loc => {
            let items = loc.items;
            if (items) {
                items = items.map(item => {
                    if (item.type === 'package') return item; // Package instances are read-only; update the definitions instead
                    const itemKey = item.partNumber || (item.manufacturer + '|' + item.model);
                    let updatedItem = itemKey === partKey ? { ...item, [field]: numVal } : item;
                    if (updatedItem.accessories) {
                        updatedItem = { ...updatedItem, accessories: updatedItem.accessories.map(acc => {
                            const accKey = acc.partNumber || (acc.manufacturer + '|' + acc.model);
                            return accKey === partKey ? { ...acc, [field]: numVal } : acc;
                        })};
                    }
                    return updatedItem;
                });
            }
            const children = loc.children ? updateLocs(loc.children) : loc.children;
            return { ...loc, items, children };
        });
        // Also update matching items within package definitions (catalog + project)
        const updatePkgItems = (pkgs) => pkgs.map(pkg => ({
            ...pkg,
            items: (pkg.items || []).map(item => {
                const itemKey = item.partNumber || (item.manufacturer + '|' + item.model);
                let updatedItem = itemKey === partKey ? { ...item, [field]: numVal } : item;
                if (updatedItem.accessories) {
                    updatedItem = { ...updatedItem, accessories: updatedItem.accessories.map(acc => {
                        const accKey = acc.partNumber || (acc.manufacturer + '|' + acc.model);
                        return accKey === partKey ? { ...acc, [field]: numVal } : acc;
                    })};
                }
                return updatedItem;
            }),
        }));
        setPackages(prev => updatePkgItems(prev));
        setProject(p => ({
            ...p,
            locations: updateLocs(p.locations),
            packages: p.packages ? updatePkgItems(p.packages) : p.packages,
        }));
    };

    // Sync all instances of a package to a specific version
    const syncPackageInstances = (packageId, newVersion) => {
        const updateLocs = (locs) => locs.map(loc => ({
            ...loc,
            items: (loc.items || []).map(item =>
                item.type === 'package' && item.packageId === packageId
                    ? { ...item, packageVersion: newVersion }
                    : item
            ),
            children: loc.children ? updateLocs(loc.children) : loc.children,
        }));
        setProject(p => ({ ...p, locations: updateLocs(p.locations) }));
    };

    // Global keyboard shortcuts
    useEffect(() => {
        const handleKeyDown = (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redo(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); showToast('Project saved'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                if (!showSearch && activeProjectId && !showProjectsHome) {
                    setShowSearch(true);
                }
            }
            if (e.key === 'Escape') {
                // Close any open modals first
                const hasOpenModal = showSearch || showAddLocation || showAddSublocation || showDuplicate || showDelete || showSavePackage || showSaveTemplate || showApplyTemplate;
                if (hasOpenModal) {
                    setShowSearch(false); setShowAddLocation(false); setShowAddSublocation(false);
                    setShowDuplicate(false); setDuplicateTarget(null); setShowDelete(false); setShowSavePackage(false);
                    setShowSaveTemplate(false); setShowApplyTemplate(false);
                } else if (clipboard.length > 0) {
                    // If no modals open, clear clipboard
                    setClipboard([]);
                    showToast('Clipboard cleared');
                }
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [historyIndex, history, clipboard, showSearch, showAddLocation, showAddSublocation, showDuplicate, showDelete, showSavePackage, showSaveTemplate, showApplyTemplate, activeProjectId, showProjectsHome]);

    // Initialize expanded state when locations change
    useEffect(() => {
        const getAllIds = (locs) => {
            let ids = {};
            locs.forEach(l => {
                ids[l.id] = true;
                if (l.children) ids = { ...ids, ...getAllIds(l.children) };
            });
            return ids;
        };
        setExpandedLocations(prev => {
            const allIds = getAllIds(project.locations);
            // Keep existing state, add new locations as expanded
            const newState = { ...prev };
            Object.keys(allIds).forEach(id => {
                if (!(id in newState)) newState[id] = true;
            });
            return newState;
        });
    }, [project.locations]);

    const expandAll = () => {
        const getAllIds = (locs) => {
            let ids = {};
            locs.forEach(l => { ids[l.id] = true; if (l.children) ids = { ...ids, ...getAllIds(l.children) }; });
            return ids;
        };
        setExpandedLocations(getAllIds(project.locations));
    };

    const collapseAll = () => {
        setExpandedLocations({});
    };

    const toggleExpand = (id) => {
        setExpandedLocations(prev => ({ ...prev, [id]: !prev[id] }));
    };

    const getDepth = (id, locations = project.locations, depth = 0) => {
        for (const loc of locations) {
            if (loc.id === id) return depth;
            if (loc.children) { const found = getDepth(id, loc.children, depth + 1); if (found !== -1) return found; }
        }
        return -1;
    };

    const addLocations = (names, parentId) => {
        const newLocs = names.map(name => ({ id: Date.now().toString() + Math.random().toString(36).substr(2, 9), name, children: [], items: [] }));
        if (!parentId) {
            setProject(p => ({ ...p, locations: [...p.locations, ...newLocs] }));
        } else {
            const addToParent = locs => locs.map(l => l.id === parentId ? { ...l, children: [...(l.children || []), ...newLocs] } : l.children ? { ...l, children: addToParent(l.children) } : l);
            setProject(p => ({ ...p, locations: addToParent(p.locations) }));
            if (selected?.id === parentId) setSelected(s => ({ ...s, children: [...(s.children || []), ...newLocs] }));
        }
    };

    const deleteLocation = (id) => {
        const removeFromTree = locs => locs.filter(l => l.id !== id).map(l => l.children ? { ...l, children: removeFromTree(l.children) } : l);
        setProject(p => ({ ...p, locations: removeFromTree(p.locations) }));
        if (selected?.id === id) setSelected(null);
    };

    const sortLocations = () => {
        const sortTree = locs => sortLocationsAlpha(locs).map(l => l.children?.length > 0 ? { ...l, children: sortTree(l.children) } : l);
        setProject(p => ({ ...p, locations: sortTree(p.locations) }));
    };

    const duplicateStructure = (location, newNames, includeItems = true) => {
        const newLocs = newNames.map(name => cloneStructure(location, name, includeItems));
        
        // Find parent of the location being duplicated and add siblings there
        const addSiblings = (locs, targetId, newSiblings) => {
            // Check if target is at this level
            const idx = locs.findIndex(l => l.id === targetId);
            if (idx !== -1) {
                // Found it - insert new locations after it
                const result = [...locs];
                result.splice(idx + 1, 0, ...newSiblings);
                return result;
            }
            // Check children
            return locs.map(l => {
                if (l.children?.length > 0) {
                    const childIdx = l.children.findIndex(c => c.id === targetId);
                    if (childIdx !== -1) {
                        const newChildren = [...l.children];
                        newChildren.splice(childIdx + 1, 0, ...newSiblings);
                        return { ...l, children: newChildren };
                    }
                    return { ...l, children: addSiblings(l.children, targetId, newSiblings) };
                }
                return l;
            });
        };
        
        setProject(p => ({ ...p, locations: addSiblings(p.locations, location.id, newLocs) }));
        const itemText = includeItems ? ' with components' : '';
        showToast(`Created ${newNames.length} location${newNames.length > 1 ? 's' : ''}${itemText}`);
    };
    
    // Move location up within its current level
    const moveLocationUp = (locationId) => {
        const moveUp = (locs) => {
            const idx = locs.findIndex(l => l.id === locationId);
            if (idx > 0) {
                const newLocs = [...locs];
                [newLocs[idx - 1], newLocs[idx]] = [newLocs[idx], newLocs[idx - 1]];
                return newLocs;
            }
            return locs.map(l => l.children?.length > 0 ? { ...l, children: moveUp(l.children) } : l);
        };
        setProject(p => ({ ...p, locations: moveUp(p.locations) }));
    };
    
    // Move location down within its current level
    const moveLocationDown = (locationId) => {
        const moveDown = (locs) => {
            const idx = locs.findIndex(l => l.id === locationId);
            if (idx !== -1 && idx < locs.length - 1) {
                const newLocs = [...locs];
                [newLocs[idx], newLocs[idx + 1]] = [newLocs[idx + 1], newLocs[idx]];
                return newLocs;
            }
            return locs.map(l => l.children?.length > 0 ? { ...l, children: moveDown(l.children) } : l);
        };
        setProject(p => ({ ...p, locations: moveDown(p.locations) }));
    };
    
    // Promote location (move up one level - make it a sibling of its parent)
    const promoteLocation = (locationId) => {
        let locationToMove = null;
        let parentId = null;
        
        // Find the location and its parent
        const findLocationAndParent = (locs, parent = null) => {
            for (const loc of locs) {
                if (loc.id === locationId) {
                    locationToMove = loc;
                    parentId = parent?.id;
                    return true;
                }
                if (loc.children?.length > 0 && findLocationAndParent(loc.children, loc)) {
                    return true;
                }
            }
            return false;
        };
        
        findLocationAndParent(project.locations);
        
        if (!locationToMove || !parentId) {
            showToast('Cannot promote top-level location');
            return;
        }
        
        // Remove from current parent and add as sibling of parent
        const promote = (locs) => {
            // First, find and remove from parent's children
            const removeFromParent = (locs) => {
                return locs.map(l => {
                    if (l.id === parentId) {
                        return { ...l, children: l.children.filter(c => c.id !== locationId) };
                    }
                    if (l.children?.length > 0) {
                        return { ...l, children: removeFromParent(l.children) };
                    }
                    return l;
                });
            };
            
            // Then add as sibling after parent
            const addAfterParent = (locs) => {
                const idx = locs.findIndex(l => l.id === parentId);
                if (idx !== -1) {
                    const newLocs = [...locs];
                    newLocs.splice(idx + 1, 0, locationToMove);
                    return newLocs;
                }
                return locs.map(l => l.children?.length > 0 ? { ...l, children: addAfterParent(l.children) } : l);
            };
            
            return addAfterParent(removeFromParent(locs));
        };
        
        setProject(p => ({ ...p, locations: promote(p.locations) }));
        showToast(`Promoted "${locationToMove.name}"`);
    };
    
    // Demote location (move down one level - make it a child of the previous sibling)
    const demoteLocation = (locationId) => {
        const demote = (locs) => {
            const idx = locs.findIndex(l => l.id === locationId);
            if (idx > 0) {
                // Has a previous sibling - demote into it
                const locationToMove = locs[idx];
                const newLocs = locs.filter((_, i) => i !== idx);
                newLocs[idx - 1] = {
                    ...newLocs[idx - 1],
                    children: [...(newLocs[idx - 1].children || []), locationToMove]
                };
                return newLocs;
            }
            // Check children
            return locs.map(l => l.children?.length > 0 ? { ...l, children: demote(l.children) } : l);
        };
        
        const loc = findLocation(project.locations, locationId);
        setProject(p => ({ ...p, locations: demote(p.locations) }));
        if (loc) showToast(`Demoted "${loc.name}"`);
    };

    const updateItems = (id, items) => {
        const upd = locs => locs.map(l => l.id === id ? { ...l, items } : l.children ? { ...l, children: upd(l.children) } : l);
        setProject(p => ({ ...p, locations: upd(p.locations) }));
        if (selected?.id === id) setSelected(s => ({ ...s, items }));
    };
    
    const renameLocation = (id, newName) => {
        const upd = locs => locs.map(l => l.id === id ? { ...l, name: newName } : l.children ? { ...l, children: upd(l.children) } : l);
        setProject(p => ({ ...p, locations: upd(p.locations) }));
        if (selected?.id === id) setSelected(s => ({ ...s, name: newName }));
        showToast(`Renamed to "${newName}"`);
    };

    // Discontinued item warning
    const [discontinuedWarning, setDiscontinuedWarning] = useState(null);

    const checkDiscontinuedAndInsert = (comps, qty) => {
        const discontinued = comps.filter(c => c.discontinued);
        if (discontinued.length > 0) {
            setDiscontinuedWarning({ comps, qty, discontinued });
        } else {
            insertComps(comps, qty);
        }
    };

    // Check if any components have accessories that need prompting
    const insertComps = (comps, qty) => {
        // Determine target location - searchTargetLocation for all-locations mode, otherwise selected
        const targetLocationId = searchTargetLocation || (selected ? selected.id : null);
        const targetLocation = targetLocationId ? findLocation(project.locations, targetLocationId) : null;
        
        if (!targetLocation) return;
        
        // Find components with default accessories
        const compsWithAccessories = comps.filter(c => c.defaultAccessories?.length > 0);
        
        if (compsWithAccessories.length > 0) {
            // Store pending components and show prompt for first one
            setPendingComponents({ comps, qty, currentIdx: 0, processedItems: [], targetLocationId });
            setAccessoryPromptComponent(compsWithAccessories[0]);
        } else {
            // No accessories, just add directly
            const newItems = comps.map(c => ({ ...c, qty }));
            updateItems(targetLocationId, [...(targetLocation.items || []), ...newItems]); 
        }
        setSearchTargetLocation(null); // Clear after use
    };
    
    // Handle accessory prompt response
    const handleAccessoryPromptConfirm = (includedAccessories) => {
        if (!pendingComponents || !accessoryPromptComponent) return;
        
        const { comps, qty, currentIdx, processedItems, targetLocationId } = pendingComponents;
        const targetLocation = findLocation(project.locations, targetLocationId || (selected ? selected.id : null));
        
        if (!targetLocation) return;
        
        // Add current component with selected accessories
        const item = { ...accessoryPromptComponent, qty };
        if (includedAccessories.length > 0) {
            item.accessories = includedAccessories;
        }
        const newProcessedItems = [...processedItems, item];
        
        // Find next component with accessories
        const compsWithAccessories = comps.filter(c => c.defaultAccessories?.length > 0);
        const nextIdx = currentIdx + 1;
        
        if (nextIdx < compsWithAccessories.length) {
            // More components with accessories to prompt
            setPendingComponents({ comps, qty, currentIdx: nextIdx, processedItems: newProcessedItems, targetLocationId });
            setAccessoryPromptComponent(compsWithAccessories[nextIdx]);
        } else {
            // All done - add all items including ones without accessories
            const compsWithoutAccessories = comps.filter(c => !c.defaultAccessories?.length);
            const itemsWithoutAccessories = compsWithoutAccessories.map(c => ({ ...c, qty }));
            const allItems = [...newProcessedItems, ...itemsWithoutAccessories];
            
            updateItems(targetLocationId || selected.id, [...(targetLocation.items || []), ...allItems]);
            setPendingComponents(null);
            setAccessoryPromptComponent(null);
        }
    };
    
    // Cancel accessory prompt - add items without any accessories
    const handleAccessoryPromptCancel = () => {
        if (pendingComponents) {
            const { comps, qty, targetLocationId } = pendingComponents;
            const locId = targetLocationId || (selected ? selected.id : null);
            const targetLocation = locId ? findLocation(project.locations, locId) : null;
            if (targetLocation) {
                const newItems = comps.map(c => ({ ...c, qty }));
                updateItems(locId, [...(targetLocation.items || []), ...newItems]);
            }
        }
        setPendingComponents(null);
        setAccessoryPromptComponent(null);
    };
    
    // Convert item to accessory of another item
    const handleConvertToAccessory = (locationIdOrItemIdx, itemIdx) => {
        // If only one arg, it's itemIdx (single view mode)
        // If two args, first is locationId, second is itemIdx (all locations view)
        if (itemIdx === undefined) {
            setConvertItemIdx(locationIdOrItemIdx);
            setConvertLocationId(null);
        } else {
            setConvertLocationId(locationIdOrItemIdx);
            setConvertItemIdx(itemIdx);
        }
        setShowConvertToAccessory(true);
    };
    
    const confirmConvertToAccessory = (itemIdx, parentIdx) => {
        const targetLocation = convertLocationId ? findLocation(project.locations, convertLocationId) : selected;
        if (!targetLocation) return;
        const items = [...targetLocation.items];
        const itemToConvert = items[itemIdx];
        const parentItem = items[parentIdx];
        
        // Adjust indices if item comes before parent
        const adjustedParentIdx = itemIdx < parentIdx ? parentIdx - 1 : parentIdx;
        
        // Remove item from main list first
        const filteredItems = items.filter((_, i) => i !== itemIdx);
        
        // Add as accessory to parent
        const newAccessory = { ...itemToConvert, qtyPer: itemToConvert.qty };
        filteredItems[adjustedParentIdx] = {
            ...filteredItems[adjustedParentIdx],
            accessories: [...(filteredItems[adjustedParentIdx].accessories || []), newAccessory]
        };
        
        updateItems(targetLocation.id, filteredItems);
        setShowConvertToAccessory(false);
        setConvertItemIdx(null);
        setConvertLocationId(null);
        showToast('Item converted to accessory');
    };
    
    // Add accessory to existing item
    const handleAddAccessoryToItem = (locationIdOrItemIdx, itemIdx) => {
        // If only one arg, it's itemIdx (single view mode)
        // If two args, first is locationId, second is itemIdx (all locations view)
        if (itemIdx === undefined) {
            setAddAccessoryItemIdx(locationIdOrItemIdx);
            setAddAccessoryLocationId(null);
        } else {
            setAddAccessoryLocationId(locationIdOrItemIdx);
            setAddAccessoryItemIdx(itemIdx);
        }
        setShowAddAccessoryModal(true);
    };
    
    const confirmAddAccessory = (accessory) => {
        const targetLocation = addAccessoryLocationId ? findLocation(project.locations, addAccessoryLocationId) : selected;
        if (!targetLocation || addAccessoryItemIdx === null) return;
        const items = [...targetLocation.items];
        items[addAccessoryItemIdx] = {
            ...items[addAccessoryItemIdx],
            accessories: [...(items[addAccessoryItemIdx].accessories || []), accessory]
        };
        updateItems(targetLocation.id, items);
        setShowAddAccessoryModal(false);
        setAddAccessoryItemIdx(null);
        setAddAccessoryLocationId(null);
        showToast('Accessory added');
    };
    
    // Ungroup a package - remove packageName from all items in the package
    const handleUngroupPackage = (packageName) => {
        if (!selected) return;
        const items = selected.items.map(item => {
            if (item.packageName === packageName) {
                const { packageName: _, ...rest } = item;
                return rest;
            }
            return item;
        });
        updateItems(selected.id, items);
        showToast(`Package "${packageName}" ungrouped`);
    };
    
    // Move item to an existing package
    const handleMoveToPackage = (itemIdx, packageName) => {
        if (!selected) return;
        const items = [...selected.items];
        items[itemIdx] = { ...items[itemIdx], packageName };
        updateItems(selected.id, items);
        showToast(`Item moved to "${packageName}"`);
    };
    
    const insertPkg = (pkg, qty) => {
        const targetLocationId = searchTargetLocation || (selected ? selected.id : null);
        const targetLocation = targetLocationId ? findLocation(project.locations, targetLocationId) : null;
        if (targetLocation) {
            const newInstance = {
                type: 'package',
                packageId: pkg.id,
                packageName: pkg.name,
                packageVersion: pkg.version || 1,
                qty: qty,
                notes: '',
            };
            updateItems(targetLocationId, [...(targetLocation.items || []), newInstance]);
        }
        setSearchTargetLocation(null);
    };
    const handleCopy = (items) => { setClipboard(items); showToast(`${items.length} item${items.length > 1 ? 's' : ''} copied`); };
    const handlePaste = (locationId) => {
        if (clipboard.length === 0) return;
        const loc = findLocation(project.locations, locationId);
        if (loc) updateItems(locationId, [...(loc.items || []), ...clipboard.map(item => ({ ...item, id: Date.now().toString() + Math.random().toString(36).substr(2, 9) }))]);
    };
    
    // Add item to catalog
    const handleAddToCatalog = (item) => {
        // Check if item already exists in catalog (by part number or manufacturer+model)
        const exists = catalog.find(c => 
            (c.partNumber && c.partNumber === item.partNumber) ||
            (c.manufacturer === item.manufacturer && c.model === item.model)
        );
        
        if (exists && !exists.deleted) {
            showToast('Item already exists in catalog');
            return;
        }
        
        const newCatalogItem = {
            id: generateCatalogId(),
            manufacturer: item.manufacturer || '',
            model: item.model || '',
            partNumber: item.partNumber || '',
            description: item.description || '',
            category: item.category || '',
            subcategory: item.subcategory || '',
            unitCost: item.unitCost || 0,
            laborHrsPerUnit: item.laborHrsPerUnit || 0,
            uom: item.uom || 'EA',
            vendor: item.vendor || '',
            discontinued: false,
            phase: item.phase || '',
            modifiedAt: new Date().toISOString(),
        };
        
        setCatalog(prev => [...prev, newCatalogItem]);
        showToast(`Added "${item.manufacturer} ${item.model}" to catalog`);
    };
    
    const handleSavePackage = (items, indices) => {
        setPendingPackageItems(items);
        setPendingPackageIndices(indices || []);
        setShowSavePackage(true);
    };
    
    const savePackage = (name, scope = 'catalog') => {
        const pkgId = generatePackageId();
        const newPkg = {
            id: pkgId,
            name,
            scope,
            version: 1,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            items: pendingPackageItems.map(i => {
                const { packageName: _, ...rest } = i;
                return { ...rest, qtyPerPackage: i.qty || 1 };
            }),
        };

        if (scope === 'catalog') {
            setPackages(p => [...p, newPkg]);
        } else {
            setProjectDirect(p => ({
                ...p,
                packages: [...(p.packages || []), newPkg],
            }));
        }

        // Replace selected items with a single package instance
        const targetLocationId = pendingPackageLocationId || (selected ? selected.id : null);
        const targetLocation = targetLocationId ? findLocation(project.locations, targetLocationId) : null;

        if (targetLocation && pendingPackageIndices.length > 0) {
            const newInstance = {
                type: 'package',
                packageId: pkgId,
                packageName: name,
                packageVersion: 1,
                qty: 1,
                notes: '',
            };
            const remainingItems = targetLocation.items.filter((_, idx) => !pendingPackageIndices.includes(idx));
            updateItems(targetLocationId, [...remainingItems, newInstance]);
        }

        setShowSavePackage(false);
        setPendingPackageItems([]);
        setPendingPackageIndices([]);
        setPendingPackageLocationId(null);
        showToast(`Package "${name}" saved as ${scope} package`);
    };
    
    const handleSaveTemplate = () => {
        if (selected && selected.items?.length > 0) setShowSaveTemplate(true);
    };
    
    const saveTemplate = (name) => {
        const newTpl = { id: Date.now().toString(), name, items: selected.items.map(i => ({ ...i })) };
        setTemplates(t => [...t, newTpl]);
        setShowSaveTemplate(false);
        showToast(`Template "${name}" saved`);
    };
    
    const applyTemplate = (template) => {
        if (selected && template) {
            const newItems = template.items.map(i => ({ ...i, id: Date.now().toString() + Math.random().toString(36).substr(2, 9) }));
            updateItems(selected.id, [...(selected.items || []), ...newItems]);
            showToast(`Template "${template.name}" applied`);
        }
    };

    const findLocation = (locs, id) => {
        for (const loc of locs) {
            if (loc.id === id) return loc;
            if (loc.children) { const found = findLocation(loc.children, id); if (found) return found; }
        }
        return null;
    };

    const selectedDepth = selected ? getDepth(selected.id) : -1;
    const projectTotals = (project.locations || []).reduce((acc, loc) => { const t = calculateTotals(loc, packages, project.packages); return { cost: acc.cost + t.cost, labor: acc.labor + t.labor, itemCount: acc.itemCount + t.itemCount }; }, { cost: 0, labor: 0, itemCount: 0 });

    // Auth gate
    if (authLoading) {
        return (
            <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#0d1117', color: '#8b98a5', fontSize: '16px' }}>
                Loading...
            </div>
        );
    }
    if (supabase && !session) {
        return <LoginScreen onAuth={setSession} />;
    }

    // Show projects home if no project is open
    if (showProjectsHome) {
        if (showDashboardCatalog) {
            return (
                <div style={styles.app}>
                    <header style={{ ...styles.header, borderBottom: '1px solid #2f3336', justifyContent: 'space-between' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <button
                                style={{ ...styles.iconButton, color: '#8b98a5' }}
                                onClick={() => setShowDashboardCatalog(false)}
                                title="Back to Projects">
                                <Icons.ChevronDown style={{ transform: 'rotate(90deg)' }} />
                            </button>
                            <div style={styles.logo}>
                                <Icons.Layers /> Catalog
                            </div>
                        </div>
                    </header>
                    <main style={{ ...styles.main, padding: '16px 24px' }}>
                        <CatalogView
                            catalog={catalog}
                            onUpdateCatalog={updateCatalog}
                            onRefreshCatalog={refreshCatalog}
                            onSaveCatalog={saveCatalog}
                            syncStatus={catalogSyncStatus}
                            catalogDirty={catalogDirty}
                            compactMode={compactMode}
                        />
                    </main>
                    {toast && <div style={styles.toast}>{toast}</div>}
                </div>
            );
        }
        return (
            <>
                <ProjectsHome
                    projects={projects}
                    onOpen={openProject}
                    onCreate={() => setShowNewProjectModal(true)}
                    onOpenCatalog={() => setShowDashboardCatalog(true)}
                    onOpenTeam={() => setShowTeamModal(true)}
                    team={team}
                    checkouts={checkouts}
                    onEdit={(project) => setEditingProject(project)}
                    onDuplicate={duplicateProject}
                    onDelete={deleteProject}
                    onUpdateStatus={updateProjectStatus}
                    getProjectTotals={getProjectTotals}
                    searchTerm={projectSearchTerm}
                    onSearchChange={setProjectSearchTerm}
                    filter={projectFilter}
                    onFilterChange={setProjectFilter}
                    session={session}
                    syncStatus={syncStatus}
                    onLogout={() => { supabase && supabase.auth.signOut(); }}
                />
                {showNewProjectModal && (
                    <NewProjectModal
                        onClose={() => setShowNewProjectModal(false)}
                        onCreate={(data) => {
                            const id = createProject(data);
                            openProject(id);
                        }}
                    />
                )}
                {editingProject && (
                    <EditProjectModal
                        project={editingProject}
                        onClose={() => setEditingProject(null)}
                        onSave={(updatedProject) => {
                            saveProject(updatedProject);
                            setEditingProject(null);
                        }}
                    />
                )}
                {showTeamModal && (
                    <TeamModal
                        team={team}
                        session={session}
                        onClose={() => setShowTeamModal(false)}
                        onTeamUpdate={(newTeam) => { setTeam(newTeam); if (newTeam) showToast(`Team: ${newTeam.name}`); }}
                    />
                )}
                {toast && <div style={styles.toast}>{toast}</div>}
            </>
        );
    }

    return (
        <div style={styles.app}>
            <header style={styles.header}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <button 
                        style={{ ...styles.iconButton, color: '#8b98a5' }} 
                        onClick={closeProject}
                        title="Back to Projects">
                        <Icons.ChevronLeft />
                    </button>
                    <div style={styles.logo}><Icons.Zap /> {project.name}</div>
                    {projectReadOnly && (
                        <span style={{ ...styles.badge(''), backgroundColor: '#3d1a1a', color: '#f87171', fontSize: '11px' }}>
                            <Icons.Lock /> Read-Only  checked out by {checkedOutBy}
                        </span>
                    )}
                    {project.client && <span style={{ color: '#6e767d', fontSize: '14px' }}> {project.client}</span>}
                    {project.status && (
                        <span style={{ ...styles.badge(''), backgroundColor: PROJECT_STATUSES[project.status]?.bg, color: PROJECT_STATUSES[project.status]?.color }}>
                            {PROJECT_STATUSES[project.status]?.label}
                        </span>
                    )}
                    {project.currentRevision && project.revisions && (
                        <span
                            style={{ ...styles.badge(''), backgroundColor: '#3d2e1a', color: '#f59e0b', cursor: 'pointer' }}
                            title="Click to close this revision. Next change will require a new revision."
                            onClick={() => { if (confirm('Close revision "' + ((project.revisions.find(r => r.id === project.currentRevision) || {}).label || '') + '"? Next change will require a new revision.')) closeRevision(); }}
                        >
                            {(project.revisions.find(r => r.id === project.currentRevision) || {}).label || 'Revision'}
                        </span>
                    )}
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <div style={{ display: 'flex', gap: '4px' }}>
                        <button style={{ ...styles.iconButton, opacity: historyIndex <= 0 ? 0.3 : 1 }} onClick={undo} disabled={historyIndex <= 0} title="Undo (Ctrl+Z)"><Icons.Undo /></button>
                        <button style={{ ...styles.iconButton, opacity: historyIndex >= history.length - 1 ? 0.3 : 1 }} onClick={redo} disabled={historyIndex >= history.length - 1} title="Redo (Ctrl+Y)"><Icons.Redo /></button>
                    </div>
                    <div style={{ display: 'flex', gap: '2px', backgroundColor: '#2f3336', borderRadius: '6px', padding: '2px' }}>
                        <button 
                            style={{ ...styles.iconButton, backgroundColor: !compactMode ? '#1d9bf0' : 'transparent', color: !compactMode ? '#fff' : '#8b98a5', borderRadius: '4px' }} 
                            onClick={() => setCompactMode(false)} 
                            title="Comfortable view">
                            <Icons.Comfortable />
                        </button>
                        <button 
                            style={{ ...styles.iconButton, backgroundColor: compactMode ? '#1d9bf0' : 'transparent', color: compactMode ? '#fff' : '#8b98a5', borderRadius: '4px' }} 
                            onClick={() => setCompactMode(true)} 
                            title="Compact view">
                            <Icons.Compact />
                        </button>
                    </div>
                    <nav style={styles.nav}>
                        {['project', 'catalog', 'packages', 'reports'].map(t => (
                            <button key={t} style={styles.navButton(tab === t)} onClick={() => setTab(t)}>{t.charAt(0).toUpperCase() + t.slice(1)}</button>
                        ))}
                    </nav>
                </div>
            </header>

            {clipboard.length > 0 && (
                <div style={styles.clipboardBanner}>
                    <span><Icons.Clipboard /> {clipboard.length} component{clipboard.length > 1 ? 's' : ''} copied</span>
                    <button style={{ ...styles.smallButton, backgroundColor: 'transparent', color: '#00ba7c' }} onClick={() => setClipboard([])}><Icons.X /> Clear</button>
                </div>
            )}

            <main style={styles.main}>
                {tab === 'project' && (
                    <>
                        <aside style={styles.sidebar}>
                            <div style={styles.sidebarHeader}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#8b98a5', textTransform: 'uppercase', letterSpacing: '1px' }}>Locations</span>
                                    <div style={{ display: 'flex', gap: '4px' }}>
                                        <button style={{ ...styles.iconButton, color: '#8b98a5' }} onClick={expandAll} title="Expand All"><Icons.ChevronsDown /></button>
                                        <button style={{ ...styles.iconButton, color: '#8b98a5' }} onClick={collapseAll} title="Collapse All"><Icons.ChevronsUp /></button>
                                        <button style={{ ...styles.iconButton, color: '#8b98a5' }} onClick={sortLocations} title="Sort A-Z"><Icons.SortAZ /></button>
                                    </div>
                                </div>
                                {projectTotals.itemCount > 0 && (
                                    <div style={{ display: 'flex', gap: '12px', fontSize: '13px' }}>
                                        <span style={{ color: '#00ba7c' }}><Icons.DollarSign /> {fmtCost(projectTotals.cost)}</span>
                                        <span style={{ color: '#1d9bf0' }}><Icons.Clock /> {formatHours(projectTotals.labor)}</span>
                                    </div>
                                )}
                            </div>

                            <div style={styles.sidebarSearch}>
                                <div style={{ position: 'relative' }}>
                                    <Icons.Search />
                                    <input
                                        type="text"
                                        placeholder="Filter locations..."
                                        value={locationSearch}
                                        onChange={e => setLocationSearch(e.target.value)}
                                        style={{ ...styles.inputSmall, width: '100%', paddingLeft: '32px' }}
                                    />
                                    <div style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#6e767d' }}><Icons.Search /></div>
                                    {locationSearch && (
                                        <button style={{ ...styles.iconButton, position: 'absolute', right: '4px', top: '50%', transform: 'translateY(-50%)' }} onClick={() => setLocationSearch('')}><Icons.X /></button>
                                    )}
                                </div>
                            </div>

                            <div style={styles.sidebarActions}>
                                <button style={{ ...styles.smallButton, flex: 1 }} onClick={() => setShowAddLocation(true)}><Icons.Plus /> Add Locations</button>
                                {selected && <button style={{ ...styles.smallButton, flex: 1, backgroundColor: '#1d3a5c', color: '#1d9bf0' }} onClick={() => setShowAddSublocation(true)}><Icons.Plus /> Add Sublocations</button>}
                            </div>

                            {multiSelectLocations.length > 0 && (
                                <div style={{ ...styles.sidebarActions, borderTop: 'none', paddingTop: 0, flexWrap: 'wrap', gap: '4px' }}>
                                    <button
                                        style={{ ...styles.smallButton, flex: '1 1 auto', backgroundColor: '#1a2e1a', color: '#4ade80', fontSize: '11px' }}
                                        onClick={() => { multiSelectLocations.forEach(loc => promoteLocation(loc.id)); setMultiSelectLocations([]); }}>
                                        <Icons.ChevronLeft /> Promote ({multiSelectLocations.length})
                                    </button>
                                    <button
                                        style={{ ...styles.smallButton, flex: '1 1 auto', backgroundColor: '#1a2e3d', color: '#60a5fa', fontSize: '11px' }}
                                        onClick={() => { multiSelectLocations.forEach(loc => demoteLocation(loc.id)); setMultiSelectLocations([]); }}>
                                        <Icons.ChevronRight /> Demote ({multiSelectLocations.length})
                                    </button>
                                    <button
                                        style={{ ...styles.smallButton, flex: '1 1 100%', backgroundColor: '#3d1a1a', color: '#f87171' }}
                                        onClick={() => { setDeleteTargets(multiSelectLocations); setShowDelete(true); }}>
                                        <Icons.Trash /> Delete Selected ({multiSelectLocations.length})
                                    </button>
                                    <button
                                        style={{ ...styles.smallButton, backgroundColor: '#2f3336' }}
                                        onClick={() => setMultiSelectLocations([])}>
                                        <Icons.X />
                                    </button>
                                </div>
                            )}

                            {selected && (
                                <div style={{ ...styles.sidebarActions, borderTop: 'none', paddingTop: 0 }}>
                                    <button style={{ ...styles.smallButton, flex: 1, backgroundColor: '#3d2e1a', color: '#ffad1f' }} onClick={() => setShowDuplicate(true)}><Icons.Duplicate /> Duplicate Location</button>
                                </div>
                            )}

                            {multiSelectLocations.length === 0 && project.locations.length > 0 && (
                                <div style={{ padding: '4px 16px 8px', fontSize: '11px', color: '#6e767d' }}>
                                     Ctrl+Click to multi-select, Shift+Click to select range
                                </div>
                            )}

                            <div style={styles.sidebarContent}>
                                {project.locations.length > 0 ? (
                                    <LocationTree 
                                        locations={project.locations} 
                                        selectedId={selected?.id} 
                                        onSelect={(loc) => { setMultiSelectLocations([]); setSelected(loc); }}
                                        onDelete={(loc) => { setDeleteTargets([loc]); setShowDelete(true); }}
                                        onRename={renameLocation}
                                        onDuplicate={(loc) => { setDuplicateTarget(loc); setShowDuplicate(true); }}
                                        onMoveUp={moveLocationUp}
                                        onMoveDown={moveLocationDown}
                                        onPromote={promoteLocation}
                                        onDemote={demoteLocation}
                                        multiSelect={multiSelectLocations}
                                        onMultiSelectToggle={(loc, e) => {
                                            if (e?.shiftKey && lastMultiSelectLocRef.current) {
                                                // Shift+click: select range of visible locations
                                                const flattenVisible = (locs) => {
                                                    let result = [];
                                                    for (const l of locs) {
                                                        result.push(l);
                                                        if (l.children?.length > 0 && expandedLocations[l.id]) {
                                                            result = result.concat(flattenVisible(l.children));
                                                        }
                                                    }
                                                    return result;
                                                };
                                                const flat = flattenVisible(project.locations);
                                                const idxA = flat.findIndex(l => l.id === lastMultiSelectLocRef.current);
                                                const idxB = flat.findIndex(l => l.id === loc.id);
                                                if (idxA !== -1 && idxB !== -1) {
                                                    const start = Math.min(idxA, idxB);
                                                    const end = Math.max(idxA, idxB);
                                                    const range = flat.slice(start, end + 1);
                                                    setMultiSelectLocations(prev => {
                                                        const combined = [...prev];
                                                        range.forEach(r => { if (!combined.some(c => c.id === r.id)) combined.push(r); });
                                                        return combined;
                                                    });
                                                }
                                            } else {
                                                // Ctrl+click: toggle individual
                                                setMultiSelectLocations(prev =>
                                                    prev.some(l => l.id === loc.id)
                                                        ? prev.filter(l => l.id !== loc.id)
                                                        : [...prev, loc]
                                                );
                                            }
                                            lastMultiSelectLocRef.current = loc.id;
                                        }}
                                        searchTerm={locationSearch}
                                        expandedState={expandedLocations}
                                        onToggleExpand={toggleExpand}
                                        catalogPkgs={packages}
                                        projectPkgs={project.packages}
                                    />
                                ) : (
                                    <div style={{ padding: '30px 20px', textAlign: 'center', color: '#6e767d', fontSize: '14px' }}>No locations yet.<br />Click "Add Locations" above.</div>
                                )}
                            </div>
                        </aside>

                        <section style={styles.content}>
                            {/* View mode toggle */}
                            <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '16px', gap: '4px' }}>
                                <button 
                                    style={{ 
                                        ...styles.smallButton, 
                                        backgroundColor: viewMode === 'single' ? '#1d9bf0' : 'transparent',
                                        color: viewMode === 'single' ? '#fff' : '#8b98a5',
                                        border: '1px solid #30363d'
                                    }} 
                                    onClick={() => setViewMode('single')}
                                    title="Single location view"
                                >
                                    <Icons.ViewSingle /> Single
                                </button>
                                <button 
                                    style={{ 
                                        ...styles.smallButton, 
                                        backgroundColor: viewMode === 'all' ? '#1d9bf0' : 'transparent',
                                        color: viewMode === 'all' ? '#fff' : '#8b98a5',
                                        border: '1px solid #30363d'
                                    }} 
                                    onClick={() => setViewMode('all')}
                                    title="All locations view"
                                >
                                    <Icons.ViewAll /> All
                                </button>
                            </div>
                            
                            {viewMode === 'single' ? (
                                selected ? (
                                    <LocationView
                                        location={selected}
                                        depth={selectedDepth}
                                        locationPath={getLocationPath(project.locations, selected.id)}
                                        onUpdate={updateItems}
                                        onSearch={() => setShowSearch(true)}
                                        clipboard={clipboard}
                                        onCopy={handleCopy}
                                        onPaste={handlePaste}
                                        onSavePackage={handleSavePackage}
                                        onSaveTemplate={handleSaveTemplate}
                                        onApplyTemplate={() => setShowApplyTemplate(true)}
                                        templates={templates}
                                        catalog={catalog}
                                        onAddAccessoryToItem={handleAddAccessoryToItem}
                                        onConvertToAccessory={handleConvertToAccessory}
                                        onUngroupPackage={handleUngroupPackage}
                                        onMoveToPackage={handleMoveToPackage}
                                        compactMode={compactMode}
                                        onAddToCatalog={handleAddToCatalog}
                                        catalogPkgs={packages}
                                        projectPkgs={project.packages}
                                    />
                                ) : (
                                    <div style={styles.emptyState}>
                                        <div style={{ fontSize: '64px', marginBottom: '16px' }}></div>
                                        <h3 style={{ color: '#8b98a5', fontSize: '20px' }}>Welcome to AV Estimator</h3>
                                        <p style={{ margin: '0 0 24px 0', maxWidth: '400px' }}>Start by creating your project structure. Add locations like buildings, levels, or areas.</p>
                                        <button style={styles.button('primary')} onClick={() => setShowAddLocation(true)}><Icons.Plus /> Add Locations</button>
                                    </div>
                                )
                            ) : (
                                <AllLocationsView
                                    locations={project.locations}
                                    onUpdate={(locationId, updater) => {
                                        const loc = findLocation(project.locations, locationId);
                                        if (loc) {
                                            const newItems = typeof updater === 'function' ? updater(loc.items || []) : updater;
                                            updateItems(locationId, newItems);
                                        }
                                    }}
                                    onSearch={(locationId) => {
                                        if (locationId) {
                                            setSearchTargetLocation(locationId);
                                        }
                                        setShowSearch(true);
                                    }}
                                    clipboard={clipboard}
                                    onCopy={handleCopy}
                                    onPaste={handlePaste}
                                    onSavePackage={(items, indices, locationId) => {
                                        setPendingPackageItems(items);
                                        setPendingPackageIndices(indices || []);
                                        setPendingPackageLocationId(locationId);
                                        setShowSavePackage(true);
                                    }}
                                    catalog={catalog}
                                    onAddAccessoryToItem={handleAddAccessoryToItem}
                                    onConvertToAccessory={handleConvertToAccessory}
                                    onUngroupPackage={handleUngroupPackage}
                                    onMoveToPackage={(locationId, itemIdx, packageName) => {
                                        const loc = findLocation(project.locations, locationId);
                                        if (!loc) return;
                                        const items = [...loc.items];
                                        items[itemIdx] = { ...items[itemIdx], packageName };
                                        updateItems(locationId, items);
                                        showToast(`Moved to ${packageName}`);
                                    }}
                                    expandedLocations={expandedWorkspaceLocations}
                                    onToggleLocationExpand={(locId) => setExpandedWorkspaceLocations(prev => ({ ...prev, [locId]: prev[locId] === false ? true : false }))}
                                    onExpandAllLocations={() => {
                                        const all = {};
                                        getAllLocationsFlatted(project.locations).forEach(loc => all[loc.id] = true);
                                        setExpandedWorkspaceLocations(all);
                                    }}
                                    onCollapseAllLocations={() => {
                                        const all = {};
                                        getAllLocationsFlatted(project.locations).forEach(loc => all[loc.id] = false);
                                        setExpandedWorkspaceLocations(all);
                                    }}
                                    compactMode={compactMode}
                                    onAddToCatalog={handleAddToCatalog}
                                    catalogPkgs={packages}
                                    projectPkgs={project.packages}
                                />
                            )}
                        </section>
                    </>
                )}

                {tab === 'catalog' && (
                    <section style={{ ...styles.content, marginLeft: 0 }}>
                        <CatalogView
                            catalog={catalog}
                            onUpdateCatalog={updateCatalog}
                            onRefreshCatalog={refreshCatalog}
                            onSaveCatalog={saveCatalog}
                            syncStatus={catalogSyncStatus}
                            catalogDirty={catalogDirty}
                            compactMode={compactMode}
                        />
                    </section>
                )}
                {tab === 'packages' && <section style={{ ...styles.content, marginLeft: 0 }}><PackagesView catalogPackages={packages} projectPackages={project.packages || []} onUpdateCatalogPackages={setPackages} onUpdateProjectPackages={setProjectDirect} catalog={catalog} locations={project.locations || []} onSyncInstances={syncPackageInstances} /></section>}
                {tab === 'reports' && (
                    <section style={{ ...styles.content, marginLeft: 0 }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '28px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '12px' }}><Icons.Download /> Reports & Exports</h2>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <label style={{ fontSize: '12px', color: '#8b98a5', whiteSpace: 'nowrap' }}>Report Grouping:</label>
                                <select
                                    value={reportHierarchyDepth}
                                    onChange={e => setReportHierarchyDepth(parseInt(e.target.value))}
                                    style={{ ...styles.input, width: 'auto', minWidth: '180px', padding: '6px 10px', fontSize: '12px', cursor: 'pointer' }}
                                >
                                    {getHierarchyLevels(project.locations).map(level => (
                                        <option key={level.depth} value={level.depth}>{level.label}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        <div style={{ display: 'grid', gap: '16px', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', marginBottom: '24px' }}>
                            {/* Export to Esticom */}
                            <div style={styles.card}>
                                <div style={styles.cardTitle}>Export to Esticom</div>
                                <p style={{ color: '#8b98a5', fontSize: '14px', margin: '0 0 16px 0' }}>Export BOM files grouped by {reportHierarchyDepth === -1 ? 'leaf location' : 'hierarchy level'}.</p>
                                <button style={styles.button('primary')} onClick={exportToEsticom}><Icons.Download /> Export</button>
                            </div>
                            {/* Consolidated BOM Export */}
                            <div style={styles.card}>
                                <div style={styles.cardTitle}>Consolidated BOM</div>
                                <p style={{ color: '#8b98a5', fontSize: '14px', margin: '0 0 16px 0' }}>Single BOM with all components across locations.</p>
                                <button style={styles.button('primary')} onClick={exportConsolidatedBOM}><Icons.Download /> Export</button>
                            </div>
                            {/* Labor by Phase */}
                            <div style={styles.card}>
                                <div style={styles.cardTitle}>Labor by Phase</div>
                                <p style={{ color: '#8b98a5', fontSize: '14px', margin: '0 0 16px 0' }}>Labor hours breakdown by phase per location/group.</p>
                                <button style={styles.button('primary')} onClick={() => setShowLaborByPhase(!showLaborByPhase)}>{showLaborByPhase ? 'Hide' : 'Show'} Report</button>
                            </div>
                        </div>

                        {/* Editable Consolidated BOM Table */}
                        {(() => {
                            const bomItems = getConsolidatedBOM();
                            if (bomItems.length === 0) return <p style={{ color: '#8b98a5' }}>No components in project. Add items to locations to see the consolidated BOM.</p>;
                            let totalCost = 0, totalLabor = 0;
                            bomItems.forEach(b => { totalCost += b.totalQty * b.unitCost; totalLabor += b.totalQty * b.laborHrsPerUnit; });
                            return (
                                <div>
                                    <h3 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        Consolidated BOM
                                        <span style={{ fontSize: '13px', color: '#8b98a5', fontWeight: '400' }}>({fmtQty(bomItems.length)} unique items  {fmtCost(totalCost)}  {fmtHrs(totalLabor)})</span>
                                    </h3>
                                    <p style={{ color: '#8b98a5', fontSize: '13px', margin: '0 0 12px 0' }}>Edit Unit Cost or Unit Labor below to update all matching items across all locations.</p>
                                    <div style={{ overflowX: 'auto', border: '1px solid #2f3336', borderRadius: '8px' }}>
                                        <table style={{ ...styles.table, fontSize: '13px' }}>
                                            <colgroup>
                                                {bomCols.map(col => <col key={col.id} style={{ width: col.width }} />)}
                                            </colgroup>
                                            <thead>
                                                <tr style={{ background: '#161b22' }}>
                                                    {bomCols.map((col, colIndex) => (
                                                        <th key={col.id} style={{ ...styles.th, ...styles.thResizable }}>
                                                            {col.label}
                                                            <div
                                                                style={styles.resizeHandle}
                                                                onMouseDown={e => startBomResize(colIndex, e)}
                                                                onMouseEnter={e => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.backgroundColor = '#1d9bf0'; }}
                                                                onMouseLeave={e => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.backgroundColor = '#4a5568'; }}
                                                            />
                                                        </th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {bomItems.map((b, idx) => {
                                                    return (
                                                        <React.Fragment key={b.key}>
                                                            <tr style={{ borderBottom: '1px solid #2f3336' }} title={b.locations.join(', ')}>
                                                                {bomCols.map(col => {
                                                                    switch (col.id) {
                                                                        case 'qty': return <td key={col.id} style={styles.td}>{fmtQty(b.totalQty)}</td>;
                                                                        case 'manufacturer': return <td key={col.id} style={styles.td}>{b.manufacturer}</td>;
                                                                        case 'model': return <td key={col.id} style={{ ...styles.td, fontWeight: '600' }}>{b.model}</td>;
                                                                        case 'partNumber': return <td key={col.id} style={{ ...styles.td, fontSize: '12px', color: '#8b98a5' }}>{b.partNumber}</td>;
                                                                        case 'description': return <td key={col.id} style={styles.td}>{b.description}</td>;
                                                                        case 'unitCost': return <td key={col.id} style={styles.td}><input type="number" step="0.01" min="0" value={b.unitCost} onChange={e => updateConsolidatedField(b.key, 'unitCost', e.target.value)} style={{ ...styles.input, width: '80px', padding: '4px 6px', fontSize: '12px', textAlign: 'right' }} /></td>;
                                                                        case 'laborHrsPerUnit': return <td key={col.id} style={styles.td}><input type="number" step="0.01" min="0" value={b.laborHrsPerUnit} onChange={e => updateConsolidatedField(b.key, 'laborHrsPerUnit', e.target.value)} style={{ ...styles.input, width: '80px', padding: '4px 6px', fontSize: '12px', textAlign: 'right' }} /></td>;
                                                                        case 'extCost': return <td key={col.id} style={{ ...styles.td, color: '#00ba7c', fontWeight: '600' }}>{fmtCost(b.totalQty * b.unitCost)}</td>;
                                                                        case 'extLabor': return <td key={col.id} style={styles.td}>{fmtHrs(b.totalQty * b.laborHrsPerUnit)}</td>;
                                                                        default: return <td key={col.id} style={styles.td}></td>;
                                                                    }
                                                                })}
                                                            </tr>
                                                        </React.Fragment>
                                                    );
                                                })}
                                                <tr style={{ background: '#161b22', fontWeight: '700' }}>
                                                    <td colSpan={bomCols.length - 2} style={{ ...styles.td, textAlign: 'right' }}>TOTALS</td>
                                                    <td style={{ ...styles.td, color: '#00ba7c' }}>{fmtCost(totalCost)}</td>
                                                    <td style={styles.td}>{fmtHrs(totalLabor)}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            );
                        })()}

                        {/* Labor by Phase Report */}
                        {showLaborByPhase && (
                            <div style={{ marginTop: '24px' }}>
                                <LaborByPhaseReport
                                    locations={project.locations}
                                    catalogPkgs={packages}
                                    projectPkgs={project.packages || []}
                                    hierarchyGroups={reportHierarchyDepth === -1 ? null : getGroupedByHierarchy(project.locations, reportHierarchyDepth, packages, project.packages || [])}
                                />
                            </div>
                        )}
                    </section>
                )}
            </main>

            {showSearch && <SearchModal catalog={catalog} packages={packages} projectPackages={project.packages || []} onClose={() => setShowSearch(false)} onInsert={checkDiscontinuedAndInsert} onInsertPkg={insertPkg} />}

            {/* Discontinued Item Warning */}
            {discontinuedWarning && (
                <div style={styles.modal} onClick={() => setDiscontinuedWarning(null)}>
                    <div style={{ ...styles.modalContent, width: '500px' }} onClick={e => e.stopPropagation()}>
                        <h2 style={{ margin: '0 0 12px 0', fontSize: '18px', fontWeight: '700', color: '#f59e0b', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icons.AlertTriangle /> Discontinued Item{discontinuedWarning.discontinued.length > 1 ? 's' : ''}
                        </h2>
                        <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '12px' }}>
                            The following item{discontinuedWarning.discontinued.length > 1 ? 's are' : ' is'} marked as discontinued:
                        </p>
                        {discontinuedWarning.discontinued.map(item => (
                            <div key={item.id} style={{ padding: '10px 12px', backgroundColor: '#1a1f26', borderRadius: '8px', border: '1px solid #f59e0b30', marginBottom: '8px' }}>
                                <div style={{ fontWeight: '600', marginBottom: '2px' }}>{item.manufacturer} <span style={{ color: '#1d9bf0' }}>{item.model}</span></div>
                                {item.catalogNote && (
                                    <div style={{ fontSize: '13px', color: '#f59e0b', marginTop: '4px', display: 'flex', alignItems: 'flex-start', gap: '6px' }}>
                                        <span style={{ flexShrink: 0 }}>Note:</span>
                                        <span>{item.catalogNote}</span>
                                    </div>
                                )}
                            </div>
                        ))}
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '16px', borderTop: '1px solid #2f3336', paddingTop: '16px' }}>
                            <button style={styles.button('secondary')} onClick={() => setDiscontinuedWarning(null)}>Cancel</button>
                            <button style={{ ...styles.button('primary'), backgroundColor: '#f59e0b', color: '#000' }} onClick={() => {
                                insertComps(discontinuedWarning.comps, discontinuedWarning.qty);
                                setDiscontinuedWarning(null);
                            }}>Add Anyway</button>
                        </div>
                    </div>
                </div>
            )}

            {showAddLocation && <AddLocationModal isTopLevel={true} onClose={() => setShowAddLocation(false)} onAdd={addLocations} />}
            {showAddSublocation && selected && <AddLocationModal parent={selected} isTopLevel={false} onClose={() => setShowAddSublocation(false)} onAdd={addLocations} />}
            {showDuplicate && (duplicateTarget || selected) && <DuplicateModal location={duplicateTarget || selected} onClose={() => { setShowDuplicate(false); setDuplicateTarget(null); }} onDuplicate={duplicateStructure} />}
            {showDelete && deleteTargets.length > 0 && <DeleteConfirmModal locations={deleteTargets} onClose={() => { setShowDelete(false); setDeleteTargets([]); setMultiSelectLocations([]); }} onDelete={deleteLocation} catalogPkgs={packages} projectPkgs={project.packages} />}
            
            {/* Revision Prompt Modal */}
            {showRevisionPrompt && (
                <RevisionPromptModal
                    project={project}
                    onClose={() => { setShowRevisionPrompt(false); setPendingMutation(null); }}
                    onCreateRevision={createRevision}
                />
            )}

            {/* Save Package Modal */}
            {showSavePackage && pendingPackageItems.length > 0 && (
                <div style={styles.modal} onClick={() => setShowSavePackage(false)}>
                    <div style={{ ...styles.modalContent, width: '500px' }} onClick={e => e.stopPropagation()}>
                        <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}><Icons.Package /> Save as Package</h2>
                        <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>Save {pendingPackageItems.length} component{pendingPackageItems.length > 1 ? 's' : ''} as a reusable package.</p>
                        <form onSubmit={e => { e.preventDefault(); const name = e.target.elements.pkgName.value.trim(); const scope = e.target.elements.pkgScope.value; if (name) savePackage(name, scope); }}>
                            <input name="pkgName" type="text" placeholder="Package name (e.g., Small Huddle - Logitech)" style={styles.input} autoFocus />
                            <div style={{ display: 'flex', gap: '12px', marginTop: '12px' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', fontSize: '13px', color: '#8b98a5' }}>
                                    <input type="radio" name="pkgScope" value="catalog" defaultChecked style={{ accentColor: '#1d9bf0' }} />
                                    Catalog Package <span style={{ fontSize: '11px', color: '#6e767d' }}>(reusable across all projects)</span>
                                </label>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', fontSize: '13px', color: '#8b98a5' }}>
                                    <input type="radio" name="pkgScope" value="project" style={{ accentColor: '#1d9bf0' }} />
                                    Project Package <span style={{ fontSize: '11px', color: '#6e767d' }}>(this project only)</span>
                                </label>
                            </div>
                            <div style={{ ...styles.preview, marginTop: '16px', maxHeight: '200px' }}>
                                {pendingPackageItems.map((item, i) => (
                                    <div key={i} style={{ ...styles.previewItem, justifyContent: 'space-between' }}>
                                        <span>{item.qty}x {item.manufacturer} {item.model}</span>
                                        <span style={{ color: '#00ba7c' }}>{fmtCost(item.qty * (item.unitCost || 0))}</span>
                                    </div>
                                ))}
                            </div>
                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }}>
                                <button type="button" style={styles.button('secondary')} onClick={() => setShowSavePackage(false)}>Cancel</button>
                                <button type="submit" style={styles.button('success')}><Icons.Package /> Save Package</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
            
            {/* Save Template Modal */}
            {showSaveTemplate && selected && (
                <div style={styles.modal} onClick={() => setShowSaveTemplate(false)}>
                    <div style={{ ...styles.modalContent, width: '500px' }} onClick={e => e.stopPropagation()}>
                        <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}><Icons.Template /> Save as Room Template</h2>
                        <p style={{ color: '#8b98a5', fontSize: '14px', marginBottom: '16px' }}>Save this room's {selected.items?.length || 0} component{(selected.items?.length || 0) !== 1 ? 's' : ''} as a reusable template.</p>
                        <form onSubmit={e => { e.preventDefault(); const name = e.target.elements.tplName.value.trim(); if (name) saveTemplate(name); }}>
                            <input name="tplName" type="text" placeholder="Template name" defaultValue={selected.name + ' Template'} style={styles.input} autoFocus />
                            <div style={{ ...styles.preview, marginTop: '16px', maxHeight: '200px' }}>
                                {(selected.items || []).map((item, i) => (
                                    <div key={i} style={{ ...styles.previewItem, justifyContent: 'space-between' }}>
                                        <span>{item.qty}x {item.manufacturer} {item.model}</span>
                                        <span style={{ color: '#00ba7c' }}>{fmtCost(item.qty * (item.unitCost || 0))}</span>
                                    </div>
                                ))}
                            </div>
                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '20px' }}>
                                <button type="button" style={styles.button('secondary')} onClick={() => setShowSaveTemplate(false)}>Cancel</button>
                                <button type="submit" style={styles.button('purple')}><Icons.Template /> Save Template</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
            
            {/* Apply Template Modal */}
            {showApplyTemplate && (
                <div style={styles.modal} onClick={() => setShowApplyTemplate(false)}>
                    <div style={{ ...styles.modalContent, width: '550px' }} onClick={e => e.stopPropagation()}>
                        <h2 style={{ margin: '0 0 16px 0', fontSize: '20px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}><Icons.Template /> Apply Room Template</h2>
                        {templates.length > 0 ? (
                            <div style={styles.searchResults}>
                                {templates.map(tpl => {
                                    const cost = tpl.items.reduce((s, i) => s + (i.qty * (i.unitCost || 0)), 0);
                                    return (
                                        <div key={tpl.id} style={{ ...styles.searchItem(false), cursor: 'pointer' }} 
                                            onClick={() => { applyTemplate(tpl); setShowApplyTemplate(false); }}
                                            onMouseEnter={e => e.currentTarget.style.backgroundColor = '#1a1f26'}
                                            onMouseLeave={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                    <Icons.Template />
                                                    <span style={{ fontWeight: '600' }}>{tpl.name}</span>
                                                    <span style={styles.badge('purple')}>{tpl.items.length} items</span>
                                                </div>
                                                <span style={{ color: '#00ba7c', fontWeight: '600' }}>{fmtCost(cost)}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div style={{ textAlign: 'center', padding: '40px', color: '#6e767d' }}>
                                <div style={{ fontSize: '32px', marginBottom: '12px' }}></div>
                                <p>No room templates yet. Save a room as a template first.</p>
                            </div>
                        )}
                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px' }}>
                            <button style={styles.button('secondary')} onClick={() => setShowApplyTemplate(false)}>Cancel</button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Accessory Prompt Modal */}
            {accessoryPromptComponent && pendingComponents && (
                <AccessoryPromptModal
                    component={accessoryPromptComponent}
                    accessories={accessoryPromptComponent.defaultAccessories || []}
                    qty={pendingComponents.qty}
                    catalog={catalog}
                    onConfirm={handleAccessoryPromptConfirm}
                    onClose={handleAccessoryPromptCancel}
                />
            )}
            
            {/* Convert to Accessory Modal */}
            {showConvertToAccessory && convertItemIdx !== null && (() => {
                const targetLocation = convertLocationId ? findLocation(project.locations, convertLocationId) : selected;
                return targetLocation ? (
                    <ConvertToAccessoryModal
                        items={targetLocation.items}
                        itemIdx={convertItemIdx}
                        onConfirm={confirmConvertToAccessory}
                        onClose={() => { setShowConvertToAccessory(false); setConvertItemIdx(null); setConvertLocationId(null); }}
                    />
                ) : null;
            })()}
            
            {/* Add Accessory Modal */}
            {showAddAccessoryModal && addAccessoryItemIdx !== null && (() => {
                const targetLocation = addAccessoryLocationId ? findLocation(project.locations, addAccessoryLocationId) : selected;
                return targetLocation ? (
                    <AddAccessoryModal
                        item={targetLocation.items[addAccessoryItemIdx]}
                        catalog={catalog}
                        onConfirm={confirmAddAccessory}
                        onClose={() => { setShowAddAccessoryModal(false); setAddAccessoryItemIdx(null); setAddAccessoryLocationId(null); }}
                    />
                ) : null;
            })()}
            
            {/* Catalog Conflict Resolution Modal */}
            {catalogConflicts && (
                <CatalogConflictModal 
                    conflicts={catalogConflicts.conflicts}
                    onResolve={handleConflictResolution}
                    onClose={() => { setCatalogConflicts(null); setCatalogSyncStatus('offline'); }}
                />
            )}
            
            {/* Toast Notification */}
            {toast && (
                <div style={{ position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)', padding: '12px 24px', borderRadius: '12px', backgroundColor: '#1a3d2e', border: '1px solid #2d4a3e', color: '#00ba7c', fontSize: '14px', fontWeight: '500', zIndex: 2000 }}>
                    {toast}
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW registration failed:', err));
    });
}
    </script>
</body>
</html>
